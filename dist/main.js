(()=>{"use strict";let e=1e-8;function t(t,i){return i-t>-e}function i(t,i){return t-i>-e}function n(t,i){return Math.abs(i-t)<e}function r(t){return t>e}function s(t){return t<-e}class o{constructor(e,t,i){this.x=e,this.y=t,this.z=i}Length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}MultiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}Normalize(){let e=this.Length();return e>0&&this.MultiplyScalar(1/e),this}Offset(e,t){let i=e.Clone().Normalize();return this.x+=i.x*t,this.y+=i.y*t,this.z+=i.z*t,this}Rotate(e,t,i){let n=e.Clone().Normalize(),r=n.x,s=n.y,o=n.z,l=this.x-i.x,a=this.y-i.y,h=this.z-i.z,d=Math.sin(t),u=Math.cos(t);return this.x=-r*(-r*l-s*a-o*h)*(1-u)+l*u+(-o*a+s*h)*d,this.y=-s*(-r*l-s*a-o*h)*(1-u)+a*u+(o*l-r*h)*d,this.z=-o*(-r*l-s*a-o*h)*(1-u)+h*u+(-s*l+r*a)*d,this.x+=i.x,this.y+=i.y,this.z+=i.z,this}Clone(){return new o(this.x,this.y,this.z)}}function l(e,t){return n(e.x,t.x)&&n(e.y,t.y)&&n(e.z,t.z)}function a(e,t){return new o(e.x-t.x,e.y-t.y,e.z-t.z)}function h(e,t){return Math.sqrt((e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)+(e.z-t.z)*(e.z-t.z))}function d(e,t){let i=new o(0,0,0);return i.x=e.y*t.z-e.z*t.y,i.y=e.z*t.x-e.x*t.z,i.z=e.x*t.y-e.y*t.x,i}function u(e,t,i){return Math.sqrt(e*e+t*t+i*i)}function m(e){return new o(e[0],e[1],e[2])}class c{constructor(e,t){this.x=e,this.y=t}Clone(){return new c(this.x,this.y)}}function p(e,t){return n(e.x,t.x)&&n(e.y,t.y)}class f{constructor(e,t,i){this.eye=e,this.center=t,this.up=i}Clone(){return new f(this.eye.Clone(),this.center.Clone(),this.up.Clone())}}class g{constructor(e,t,i){this.r=e,this.g=t,this.b=i}Set(e,t,i){this.r=e,this.g=t,this.b=i}Clone(){return new g(this.r,this.g,this.b)}}class x{constructor(){this.name=null,this.url=null,this.buffer=null,this.offset=new c(0,0),this.scale=new c(1,1),this.rotation=0}IsValid(){return null!==this.name&&null!==this.url&&null!==this.buffer}HasTransformation(){return!p(this.offset,new c(0,0))||!p(this.scale,new c(1,1))||!n(this.rotation,0)}Clone(){let e=new x;return e.name=this.name,e.url=this.url,e.buffer=this.buffer,e.offset=this.offset.Clone(),e.scale=this.scale.Clone(),e.rotation=this.rotation,e}}class v{constructor(e){this.type=e,this.name="",this.color=new g(0,0,0),this.ambient=new g(0,0,0),this.specular=new g(0,0,0),this.emissive=new g(0,0,0),this.metalness=0,this.roughness=1,this.shininess=0,this.opacity=1,this.diffuseMap=null,this.specularMap=null,this.bumpMap=null,this.normalMap=null,this.emissiveMap=null,this.metalnessMap=null,this.alphaTest=0,this.transparent=!1,this.multiplyDiffuseMap=!1,this.multiplyMetallicMap=!1,this.isDefault=!1}Clone(){let e=new v(this.type);return e.name=this.name,e.color=this.color.Clone(),e.ambient=this.ambient.Clone(),e.specular=this.specular.Clone(),e.emissive=this.emissive.Clone(),e.metalness=this.metalness,e.roughness=this.roughness,e.shininess=this.shininess,e.opacity=this.opacity,e.diffuseMap=this.CloneTextureMap(this.diffuseMap),e.specularMap=this.CloneTextureMap(this.specularMap),e.bumpMap=this.CloneTextureMap(this.bumpMap),e.normalMap=this.CloneTextureMap(this.normalMap),e.emissiveMap=this.CloneTextureMap(this.emissiveMap),e.metalnessMap=this.CloneTextureMap(this.metalnessMap),e.alphaTest=this.alphaTest,e.transparent=this.transparent,e.multiplyDiffuseMap=this.multiplyDiffuseMap,e}CloneTextureMap(e){return null===e?null:e.Clone()}}function C(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function y(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}function b(e){let t=parseInt(e,10).toString(16);for(;t.length<2;)t="0"+t;return t}function w(e){return b(e.r)+b(e.g)+b(e.b)}function M(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b}function I(e,t){function i(e,t){return null===e&&null===t||null!==e&&null!==t&&i(e,t)}return!!(e.type===t.type&&e.name===t.name&&M(e.color,t.color)&&M(e.ambient,t.ambient)&&M(e.specular,t.specular)&&M(e.emissive,t.emissive)&&n(e.metalness,t.metalness)&&n(e.roughness,t.roughness)&&n(e.shininess,t.shininess)&&n(e.opacity,t.opacity)&&i(e.diffuseMap,t.diffuseMap)&&i(e.specularMap,t.specularMap)&&i(e.bumpMap,t.bumpMap)&&i(e.normalMap,t.normalMap)&&i(e.emissiveMap,t.emissiveMap)&&i(e.metalnessMap,t.metalnessMap)&&n(e.alphaTest,t.alphaTest)&&e.transparent===t.transparent&&e.multiplyDiffuseMap===t.multiplyDiffuseMap&&e.multiplyMetallicMap===t.multiplyMetallicMap&&e.isDefault===t.isDefault)}function S(e){return 1===e?new f(new o(2,-3,1.5),new o(0,0,0),new o(1,0,0)):2===e?new f(new o(-1.5,2,3),new o(0,0,0),new o(0,1,0)):3===e?new f(new o(-1.5,-3,2),new o(0,0,0),new o(0,0,1)):null}function T(e,t){if(!t(e))return!1;for(let i of e.children)if(!T(i,t))return!1;return!0}function E(e){let t=null;return T(e,(e=>{if(e.isMesh)for(const i of e.material)return"MeshPhongMaterial"===i.type?t=1:"MeshStandardMaterial"===i.type&&(t=2),!1;return!0})),t}class A{constructor(){this.direction=3,this.isFixed=!0,this.isFlipped=!1}SetDirection(e,t){this.direction=e,this.isFlipped=!1;let i=S(this.direction),n=a(i.eye,i.center),r=h(t.center,t.eye),s=t.center.Clone().Offset(n,r),l=t.Clone();return 1===this.direction&&(l.up=new o(1,0,0),l.eye=s),2===this.direction?(l.up=new o(0,1,0),l.eye=s):3===this.direction&&(l.up=new o(0,0,1),l.eye=s),l}SetFixed(e,t){return this.isFixed=e,this.isFixed?this.SetDirection(this.direction,t):null}Flip(e){this.isFlipped=!this.isFlipped;let t=e.Clone();return t.up.MultiplyScalar(-1),t}}class G{constructor(e){this.scene=e,this.mainObject=null}SetMainObject(e){this.mainObject=e,this.scene.add(this.mainObject)}ClearMainObject(){null!==this.mainObject&&(this.EnumerateMeshes((e=>{e.geometry.dispose()})),this.scene.remove(this.mainObject),this.mainObject=null)}EnumerateMeshes(e){null!==this.mainObject&&this.mainObject.traverse((t=>{t.isMesh&&e(t)}))}GetModelMeshUnderMouse(e,t,i,n){if(null===this.mainObject)return null;let r=new THREE.Raycaster,s=new THREE.Vector2;s.x=e.x/i*2-1,s.y=-e.y/n*2+1,r.setFromCamera(s,t);let o=r.intersectObject(this.mainObject,!0);for(let e=0;e<o.length;e++){let t=o[e];if("Mesh"===t.object.type&&t.object.visible)return t.object}return null}GetModelIntersectionUnderMouse(e,t,i,n){let r=new THREE.Raycaster,s=new THREE.Vector2;s.x=e.x/i*2-1,s.y=-e.y/n*2+1,r.setFromCamera(s,t);let o=r.intersectObjects(this.modelMeshes);for(let e=0;e<o.length;e++){let t=o[e];if("Mesh"===t.object.type&&t.object.visible)return t}return null}}class D{constructor(e){this.scene=e,this.mainObject=null}AddAxisLines(e,t){function i(e,t,i){let n=[e,t],r=(new THREE.BufferGeometry).setFromPoints(n);return new THREE.Line(r,i)}this.RemoveAxisLines(),this.mainObject=new THREE.Object3D;const n=new THREE.LineBasicMaterial({color:13421772});let r=new THREE.Vector3;e.getSize(r);let s=.5*r.y,o=new THREE.Vector2(e.min.z-s,e.min.x-s),l=new THREE.Vector2(e.max.z+s,e.max.x+s),a=new THREE.Vector2(Math.floor(o.x/t)*t,Math.floor(o.y/t)*t),h=new THREE.Vector2(Math.ceil(l.x/t)*t,Math.ceil(l.y/t)*t),d=e.min.y,u=Math.ceil((h.x-a.x)/t),m=Math.ceil((h.y-a.y)/t);for(let e=0;e<u+1;e++){let r=a.x+e*t;this.mainObject.add(i(new THREE.Vector3(a.y,d,r),new THREE.Vector3(h.y,d,r),n))}for(let e=0;e<m+1;e++){let r=a.y+e*t;this.mainObject.add(i(new THREE.Vector3(r,d,a.x),new THREE.Vector3(r,d,h.x),n))}this.scene.add(this.mainObject)}RemoveAxisLines(){null!==this.mainObject&&(this.scene.remove(this.mainObject),this.mainObject=null)}}class R{constructor(e){this.scene=e,this.type=1,this.ambientLight=new THREE.AmbientLight(8947848),this.directionalLight=new THREE.DirectionalLight(8947848),this.environment=null,this.scene.add(this.ambientLight),this.scene.add(this.directionalLight)}SetType(e){this.type=e,1===this.type?(this.ambientLight.color.set(8947848),this.directionalLight.color.set(8947848),this.scene.environment=null):2===this.type&&(this.ambientLight.color.set(0),this.directionalLight.color.set(5592405),this.scene.environment=this.environment)}SetEnvironment(e,t){let i=new THREE.CubeTextureLoader;this.environment=i.load(e,(()=>{t()}))}UpdateByCamera(e){const t=a(e.eye,e.center);this.directionalLight.position.set(t.x,t.y,t.z)}CreateHighlightMaterial(e){return 1===this.type?new THREE.MeshPhongMaterial({color:e,side:THREE.DoubleSide}):2===this.type?new THREE.MeshStandardMaterial({color:e,side:THREE.DoubleSide}):null}}class F{constructor(){this.canvas=null,this.renderer=null,this.scene=null,this.geometry=null,this.axis=null,this.camera=null,this.shading=null,this.navigation=null,this.upVector=null,this.settings={animationSteps:40}}Init(e){this.canvas=e,this.canvas.id="viewer";let t={canvas:this.canvas,antialias:!0};this.renderer=new THREE.WebGLRenderer(t),window.devicePixelRatio&&this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setClearColor("#ffffff",1),this.renderer.setSize(this.canvas.width,this.canvas.height),this.scene=new THREE.Scene,this.geometry=new G(this.scene),this.axis=new D(this.scene),this.InitCamera(),this.InitShading(),this.Render()}SetClickHandler(e){this.navigation.SetClickHandler(e)}SetContextMenuHandler(e){this.navigation.SetContextMenuHandler(e)}SetBackgroundColor(e){let t="#"+w(e);this.renderer.setClearColor(t,1),this.Render()}SetEnvironmentMap(e){this.shading.SetEnvironment(e,(()=>{this.Render()}))}GetCamera(){return this.navigation.GetCamera()}SetCamera(e){this.navigation.SetCamera(e),this.Render()}Resize(e,t){let i=GetDomElementInnerDimensions(this.canvas,e,t);this.ResizeRenderer(i.width,i.height)}ResizeRenderer(e,t){window.devicePixelRatio&&this.renderer.setPixelRatio(window.devicePixelRatio),this.camera.aspect=e/t,this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.Render()}FitSphereToWindow(e,t){if(null===e)return;let i=new o(e.center.x,e.center.y,e.center.z),n=e.radius,r=this.camera.fov;if(t){let e=this.navigation.GetFitToSphereCamera(i,n,r);this.navigation.MoveCamera(e,this.settings.animationSteps)}else this.navigation.FitToSphere(i,n,r)}AdjustClippingPlanesToSphere(e){null!==e&&(e.radius<10?(this.camera.near=.01,this.camera.far=100):e.radius<100?(this.camera.near=.1,this.camera.far=1e3):e.radius<1e3?(this.camera.near=10,this.camera.far=1e4):(this.camera.near=100,this.camera.far=1e6),this.camera.updateProjectionMatrix(),this.Render())}IsFixUpVector(){return this.navigation.IsFixUpVector()}SetFixUpVector(e){let t=this.navigation.GetCamera(),i=this.upVector.SetFixed(e,t);this.navigation.SetFixUpVector(e),null!==i&&this.navigation.MoveCamera(i,this.settings.animationSteps),this.Render()}SetUpVector(e,t){let i=this.navigation.GetCamera(),n=this.upVector.SetDirection(e,i),r=t?this.settings.animationSteps:0;this.navigation.MoveCamera(n,r),this.Render()}FlipUpVector(){let e=this.navigation.GetCamera(),t=this.upVector.Flip(e);this.navigation.MoveCamera(t,0),this.Render()}Render(){let e=this.navigation.GetCamera();this.camera.position.set(e.eye.x,e.eye.y,e.eye.z),this.camera.up.set(e.up.x,e.up.y,e.up.z),this.camera.lookAt(new THREE.Vector3(e.center.x,e.center.y,e.center.z)),this.shading.UpdateByCamera(e),this.renderer.render(this.scene,this.camera)}SetMainObject(e){const t=E(e);this.geometry.SetMainObject(e),this.shading.SetType(t),this.Render()}Clear(){this.geometry.ClearMainObject(),this.Render()}SetMeshesVisibility(e){this.geometry.EnumerateMeshes((t=>{let i=e(t.userData);t.visible!==i&&(t.visible=i)})),this.Render()}SetMeshesHighlight(e,t){const i=this.shading.CreateHighlightMaterial(e);this.geometry.EnumerateMeshes((e=>{t(e.userData)?null===e.userData.threeMaterials&&(e.userData.threeMaterials=e.material,e.material=function(e,t){let i=[];for(let n=0;n<e.length;n++)i.push(t);return i}(e.material,i)):null!==e.userData.threeMaterials&&(e.material=e.userData.threeMaterials,e.userData.threeMaterials=null)})),this.Render()}GetMeshUserDataUnderMouse(e){let t=this.canvas.width,i=this.canvas.height;window.devicePixelRatio&&(t/=window.devicePixelRatio,i/=window.devicePixelRatio);let n=this.geometry.GetModelMeshUnderMouse(e,this.camera,t,i);return null===n?null:n.userData}GetBoundingBox(e){let t=!1,i=new THREE.Box3;return this.geometry.EnumerateMeshes((n=>{e(n.userData)&&(i.union((new THREE.Box3).setFromObject(n)),t=!0)})),t?i:null}GetBoundingSphere(e){let t=this.GetBoundingBox(e);if(null===t)return null;let i=new THREE.Sphere;return t.getBoundingSphere(i),i}EnumerateMeshesUserData(e){this.geometry.EnumerateMeshes((t=>{e(t.userData)}))}InitCamera(){this.camera=new THREE.PerspectiveCamera(45,this.canvas.width/this.canvas.height,.1,1e3),this.scene.add(this.camera);let e=this.renderer.domElement,t=S(3);this.navigation=new Navigation(e,t),this.navigation.SetUpdateHandler((()=>{this.Render()})),this.upVector=new A}InitShading(){this.shading=new R(this.scene)}GetImageSize(){let e=new THREE.Vector2;return this.renderer.getSize(e),{width:parseInt(e.x,10),height:parseInt(e.y,10)}}GetImageAsDataUrl(e,t){let i=this.GetImageSize(),n=e,r=t;window.devicePixelRatio&&(n/=window.devicePixelRatio,r/=window.devicePixelRatio),this.ResizeRenderer(n,r),this.Render();let s=this.renderer.domElement.toDataURL();return this.ResizeRenderer(i.width,i.height),s}}let _={IntegerToString:e=>e.toString(),StringToInteger:e=>parseInt(e,10),NumberToString:e=>e.toPrecision(5),StringToNumber:e=>parseFloat(e),ModelUrlsToString:function(e){return null===e?null:e.join(",")},StringToModelUrls:function(e){return null===e||0===e.length?null:e.split(",")},CameraToString:function(e){return null===e?null:[this.NumberToString(e.eye.x),this.NumberToString(e.eye.y),this.NumberToString(e.eye.z),this.NumberToString(e.center.x),this.NumberToString(e.center.y),this.NumberToString(e.center.z),this.NumberToString(e.up.x),this.NumberToString(e.up.y),this.NumberToString(e.up.z)].join(",")},StringToCamera:function(e){if(null===e||0===e.length)return null;let t=e.split(",");return 9!==t.length?null:new f(new o(this.StringToNumber(t[0]),this.StringToNumber(t[1]),this.StringToNumber(t[2])),new o(this.StringToNumber(t[3]),this.StringToNumber(t[4]),this.StringToNumber(t[5])),new o(this.StringToNumber(t[6]),this.StringToNumber(t[7]),this.StringToNumber(t[8])))},ColorToString:function(e){return null===e?null:[this.IntegerToString(e.r),this.IntegerToString(e.g),this.IntegerToString(e.b)].join(",")},StringToColor:function(e){if(null===e||0===e.length)return null;let t=e.split(",");return 3!==t.length?null:new g(this.StringToInteger(t[0]),this.StringToInteger(t[1]),this.StringToInteger(t[2]))}};class L{constructor(e){this.separator=e,this.paramList=""}AddModelUrls(e){return this.AddUrlPart("model",_.ModelUrlsToString(e)),this}AddCamera(e){return this.AddUrlPart("camera",_.CameraToString(e)),this}AddBackground(e){return this.AddUrlPart("backgroundcolor",_.ColorToString(e)),this}AddColor(e){return this.AddUrlPart("defaultcolor",_.ColorToString(e)),this}AddUrlPart(e,t){null!==e&&null!==t&&(this.paramList.length>0&&(this.paramList+=this.separator),this.paramList+=e+"="+t)}GetParameterList(){return this.paramList}}class V{constructor(e,t){this.separator=t,this.paramList=e}GetModelUrls(){if(-1===this.paramList.indexOf("="))return this.paramList.split(",");let e=this.GetKeywordParams("model");return _.StringToModelUrls(e)}GetCamera(){let e=this.GetKeywordParams("camera");return _.StringToCamera(e)}GetBackgroundColor(){let e=this.GetKeywordParams("backgroundcolor");return _.StringToColor(e)}GetDefaultColor(){let e=this.GetKeywordParams("defaultcolor");return _.StringToColor(e)}GetKeywordParams(e){if(null===this.paramList||0===this.paramList.length)return null;let t=e+"=",i=this.paramList.split(this.separator);for(let e=0;e<i.length;e++){let n=i[e];if(n.startsWith(t))return n.substr(t.length)}return null}}function P(){return new L("$")}function N(e){return new V(e,"$")}class k{constructor(){this.skipNextEvent=!1,this.eventListener=null}SetEventListener(e){this.eventListener=e,window.onhashchange=this.OnChange.bind(this)}SkipNextEventHandler(){this.skipNextEvent=!0}HasHash(){return this.GetHash().length>0}ClearHash(){this.SetHash("")}GetModelFilesFromHash(){return N(this.GetHash()).GetModelUrls()}SetModelFilesToHash(e){let t=function(e){let t=P();return t.AddModelUrls(e),t.GetParameterList()}(e);this.SetHash(t)}GetCameraFromHash(){return N(this.GetHash()).GetCamera()}GetBackgroundFromHash(){return N(this.GetHash()).GetBackgroundColor()}GetDefaultColorFromHash(){return N(this.GetHash()).GetDefaultColor()}GetHash(){return window.location.hash.substr(1)}SetHash(e){window.location.hash=e}OnChange(){this.skipNextEvent?this.skipNextEvent=!1:this.eventListener()}}class H{constructor(){this.expirationDays=365}ClearVal(e){this.SetStringVal(e,"")}SetStringVal(e,t){let i=new Date;i.setTime(i.getTime()+24*this.expirationDays*60*60*1e3),document.cookie=e+"="+t+"; expires="+i.toUTCString()+";"}GetStringVal(e,t){let i=decodeURIComponent(document.cookie).split(";");for(let t=0;t<i.length;t++){let n=i[t].trim();if(n.startsWith(e+"="))return n.substr(e.length+1)}return t}GetBoolVal(e,t){let i=this.GetStringVal(e,null);return null===i?t:"true"===i}SetBoolVal(e,t){this.SetStringVal(e,t?"true":"false")}GetIntVal(e,t){let i=this.GetStringVal(e,null);return null===i?t:parseInt(i,10)}SetIntVal(e,t){this.SetStringVal(e,t.toString())}GetColorVal(e,t){let i=this.GetStringVal(e,null);return null===i?t:_.StringToColor(i)}SetColorVal(e,t){this.SetStringVal(e,_.ColorToString(t))}}class U{GetIntegerFromStyle(e){return Math.round(parseFloat(e))}GetDomElementExternalWidth(e){return this.GetIntegerFromStyle(e.paddingLeft)+this.GetIntegerFromStyle(e.paddingRight)+(this.GetIntegerFromStyle(e.borderLeftWidth)+this.GetIntegerFromStyle(e.borderRightWidth))+(this.GetIntegerFromStyle(e.marginLeft)+this.GetIntegerFromStyle(e.marginRight))}GetDomElementExternalHeight(e){return this.GetIntegerFromStyle(e.paddingTop)+this.GetIntegerFromStyle(e.paddingBottom)+(this.GetIntegerFromStyle(e.borderTopWidth)+this.GetIntegerFromStyle(e.borderBottomWidth))+(this.GetIntegerFromStyle(e.marginTop)+this.GetIntegerFromStyle(e.marginBottom))}GetDomElementInnerDimensions(e,t,i){let n=getComputedStyle(e);return{width:t-this.GetDomElementExternalWidth(n),height:i-this.GetDomElementExternalHeight(n)}}CreateDomElement(e,t,i){let n=document.createElement(e);return t&&(n.className=t),i&&(n.innerHTML=i),n}AddDomElement(e,t,i,n){let r=this.CreateDomElement(t,i,n);return e.appendChild(r),r}ClearDomElement(e){for(;e.firstChild;)e.removeChild(e.firstChild)}InsertDomElementBefore(e,t){t.parentNode.insertBefore(e,t)}InsertDomElementAfter(e,t){t.parentNode.insertBefore(e,t.nextSibling)}ShowDomElement(e){e.style.display="block"}HideDomElement(e){e.style.display="none"}IsDomElementVisible(e){return null!==e.offsetParent}SetDomElementWidth(e,t){e.style.width=t.toString()+"px"}SetDomElementHeight(e,t){e.style.height=t.toString()+"px"}GetDomElementOuterWidth(e){let t=getComputedStyle(e);return e.offsetWidth+this.GetIntegerFromStyle(t.marginLeft)+this.GetIntegerFromStyle(t.marginRight)}GetDomElementOuterHeight(e){let t=getComputedStyle(e);return e.offsetHeight+this.GetIntegerFromStyle(t.marginTop)+this.GetIntegerFromStyle(t.marginBottom)}SetDomElementOuterWidth(e,t){let i=getComputedStyle(e);this.SetDomElementWidth(e,t-this.GetDomElementExternalWidth(i))}SetDomElementOuterHeight(e,t){let i=getComputedStyle(e);this.SetDomElementHeight(e,t-this.GetDomElementExternalHeight(i))}CreateDiv(e,t){return this.CreateDomElement("div",e,t)}AddDiv(e,t,i){return this.AddDomElement(e,"div",t,i)}}class B{GetNameOrDefault(e,t){return e.length>0?e:t}GetNodeName(e){return this.GetNameOrDefault(e,"No Name")}GetMeshName(e){return this.GetNameOrDefault(e,"No Name")}GetMaterialName(e){return this.GetNameOrDefault(e,"No Name")}IsHoverEnabled(){return window.matchMedia("(hover: hover)").matches}AddSmallWidthChangeEventListener(e){window.matchMedia("(max-width: 800px)").addEventListener("change",e)}IsSmallWidth(){return window.matchMedia("(max-width: 800px)").matches}IsSmallHeight(){return window.matchMedia("(max-height: 800px)").matches}InstallTooltip(e,t){if(!this.IsHoverEnabled())return;let i=null;e.addEventListener("mouseover",(()=>{i=U.AddDiv(document.body,"ov_tooltip",t);let n=function(e,t){let i=window.innerWidth,n=e.getBoundingClientRect(),r=e.offsetWidth,s=e.offsetHeight,o=t.offsetWidth,l=n.left+r/2-o/2;return l+o>i-10&&(l=i-o-10),l<10&&(l=10),l=Math.max(l,0),{left:l,top:n.top+s+10}}(e,i);i.style.left=n.left+"px",i.style.top=n.top+"px"})),e.addEventListener("mouseout",(()=>{i.remove()}))}CopyToClipboard(e){let t=document.createElement("input");t.style.position="absolute",t.style.left="0",t.style.top="0",t.setAttribute("value",e),document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}DownloadUrlAsFile(e,t){let i=document.createElement("a");i.href=e,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i)}DownloadArrayBufferAsFile(e,t){let i=CreateObjectUrl(e);this.DownloadUrlAsFile(i,t)}CreateSvgIconElement(e,t){let i=U.CreateDiv("ov_svg_icon");return t&&i.classList.add(t),U.AddDomElement(i,"i","icon icon-"+e),i}AddSvgIconElement(e,t,i){let n=this.CreateSvgIconElement(t,i);return e.appendChild(n),n}SetSvgIconImageElement(e,t){e.firstChild.className="icon icon-"+t}CreateHeaderButton(e,t,i,n){let r=U.CreateDomElement("a");return r.setAttribute("href",n),r.setAttribute("target","_blank"),r.setAttribute("rel","noopener noreferrer"),this.InstallTooltip(r,i),this.AddSvgIconElement(r,t,"header_button"),e.appendChild(r),r}CreateInlineColorCircle(e){let t="#"+this.ColorToHexString(e),i=new this.Color(Math.max(0,e.r-50),Math.max(0,e.g-50),Math.max(0,e.b-50)),n="#"+this.ColorToHexString(i),r=U.CreateDiv("ov_color_circle");return r.style.background=t,r.style.border="1px solid "+n,r}InstallVerticalSplitter(e,t,i,n){let r=null;this.CreateVerticalSplitter(e,{onSplitStart:()=>{r=this.GetDomElementOuterWidth(t)},onSplit:e=>{let s=0;s=i?r-e:r+e,s<280?s=280:s>450&&(s=450),U.SetDomElementOuterWidth(t,s),n()}})}}class O{constructor(e,t,i){this.image=e,this.imageTitle=t,this.selected=!1,this.buttonDiv=U.CreateDiv("ov_toolbar_button"),this.buttonImg=U.AddSvgIconElement(this.buttonDiv,this.image),null!==i&&this.buttonDiv.addEventListener("click",i),this.buttonDiv.setAttribute("alt",this.imageTitle),B.InstallTooltip(this.buttonDiv,this.imageTitle)}AddDomElements(e){e.appendChild(this.buttonDiv)}AddClass(e){this.buttonDiv.classList.add(e)}RemoveClass(e){this.buttonDiv.classList.remove(e)}AddImageClass(e){this.buttonImg.classList.add(e)}RemoveImageClass(e){this.buttonImg.classList.remove(e)}SetSelected(e){this.selected=e,this.selected?this.buttonDiv.classList.add("selected"):this.buttonDiv.classList.remove("selected")}}class z{constructor(e){this.mainDiv=U.AddDiv(e,"ov_toolbar")}AddImageButton(e,t,i){let n=new O(e,t,i);return n.AddDomElements(this.mainDiv),n}AddImageRadioButton(e,t,i){let n=[];for(let r=0;r<e.length;r++){let s=e[r],o=this.AddImageButton(s.image,s.title,(()=>{for(let e=0;e<n.length;e++){let t=n[e];e===r?t.SetSelected(!0):t.SetSelected(!1)}i(r)}));t===r&&o.SetSelected(!0),n.push(o)}return n}AddSeparator(){return U.AddDiv(this.mainDiv,"ov_toolbar_separator")}}class W{constructor(e){this.parentDiv=e,this.menuDiv=U.AddDiv(e,"ov_panel_set_menu"),this.contentDiv=U.AddDiv(e,"ov_panel_set_content ov_thin_scrollbar"),this.panels=[],this.panelButtons=[],this.panelsVisible=!0,this.panelsPrevWidth=null,this.callbacks=null}Init(e){this.callbacks=e}GetContentDiv(){return this.contentDiv}AddPanel(e){this.panels.push(e);let t=B.AddSvgIconElement(this.menuDiv,e.GetIcon(),"ov_panel_set_menu_button");t.setAttribute("alt",e.GetName()),t.setAttribute("title",e.GetName()),this.panelButtons.push(t),t.addEventListener("click",(()=>{e===this.GetVisiblePanel()?this.ShowPanels(!1):(this.ShowPanels(!0),this.ShowPanel(e))}))}IsPanelsVisible(){return this.panelsVisible}ShowPanels(e){if(this.IsParentVisible()&&this.panelsVisible!==e){if(this.panelsVisible=e,this.panelsVisible)U.ShowDomElement(this.contentDiv),U.SetDomElementWidth(this.parentDiv,this.menuDiv.offsetWidth+this.panelsPrevWidth);else{for(let e of this.panelButtons)e.classList.remove("selected");for(let e of this.panels)e.Show(!1);this.panelsPrevWidth=this.contentDiv.offsetWidth,U.SetDomElementWidth(this.parentDiv,this.menuDiv.offsetWidth),U.HideDomElement(this.contentDiv)}this.callbacks.onShowHidePanels(this.panelsVisible),this.callbacks.onResize()}}ShowPanel(e){if(e===this.GetVisiblePanel())return;let t=this.GetPanelButton(e);for(let e of this.panelButtons)e!==t&&e.classList.remove("selected");t.classList.add("selected");for(let t of this.panels)t!==e&&t.Show(!1);e.Show(!0),e.Resize()}GetVisiblePanel(){if(!this.panelsVisible)return null;for(let e of this.panels)if(e.IsVisible())return e;return null}SetPanelIcon(e,t){let i=this.GetPanelButton(e);B.SetSvgIconImageElement(i,t)}GetPanelButton(e){const t=this.panels.indexOf(e);return this.panelButtons[t]}Resize(){let e=this.parentDiv.offsetHeight;if(U.SetDomElementHeight(this.menuDiv,e),U.SetDomElementHeight(this.contentDiv,e),this.panelsVisible)for(let e of this.panels)e.IsVisible()&&e.Resize()}IsParentVisible(){return U.IsDomElementVisible(this.parentDiv)}Clear(){for(let e of this.panels)e.Clear()}}class j{constructor(e,t,i,n){this.x=e,this.y=t,this.z=i,this.w=n}}function K(e){return new j(e[0],e[1],e[2],e[3])}class q{constructor(e){this.matrix=null,null!=e&&(this.matrix=e)}IsValid(){return null!==this.matrix}Set(e){return this.matrix=e,this}Get(){return this.matrix}Clone(){let e=[this.matrix[0],this.matrix[1],this.matrix[2],this.matrix[3],this.matrix[4],this.matrix[5],this.matrix[6],this.matrix[7],this.matrix[8],this.matrix[9],this.matrix[10],this.matrix[11],this.matrix[12],this.matrix[13],this.matrix[14],this.matrix[15]];return new q(e)}CreateIdentity(){return this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this}IsIdentity(){let e=(new q).CreateIdentity().Get();for(let t=0;t<16;t++)if(!n(this.matrix[t],e[t]))return!1;return!0}CreateTranslation(e,t,i){return this.matrix=[1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1],this}CreateRotation(e,t,i,n){let r=e+e,s=t+t,o=i+i,l=e*r,a=e*s,h=e*o,d=t*s,u=t*o,m=i*o,c=n*r,p=n*s,f=n*o;return this.matrix=[1-(d+m),a+f,h-p,0,a-f,1-(l+m),u+c,0,h+p,u-c,1-(l+d),0,0,0,0,1],this}CreateScale(e,t,i){return this.matrix=[e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1],this}ComposeTRS(e,t,i){let n=e.x,r=e.y,s=e.z,o=t.x,l=t.y,a=t.z,h=t.w,d=i.x,u=i.y,m=i.z,c=o+o,p=l+l,f=a+a,g=o*c,x=o*p,v=o*f,C=l*p,y=l*f,b=a*f,w=h*c,M=h*p,I=h*f;return this.matrix=[(1-(C+b))*d,(x+I)*d,(v-M)*d,0,(x-I)*u,(1-(g+b))*u,(y+w)*u,0,(v+M)*m,(y-w)*m,(1-(g+C))*m,0,n,r,s,1],this}DecomposeTRS(){let e=new o(this.matrix[12],this.matrix[13],this.matrix[14]),t=u(this.matrix[0],this.matrix[1],this.matrix[2]),i=u(this.matrix[4],this.matrix[5],this.matrix[6]),n=u(this.matrix[8],this.matrix[9],this.matrix[10]);s(this.Determinant())&&(t*=-1);let r=new o(t,i,n),l=this.matrix[0]/t,a=this.matrix[4]/i,h=this.matrix[8]/n,d=this.matrix[1]/t,m=this.matrix[5]/i,c=this.matrix[9]/n,p=this.matrix[2]/t,f=this.matrix[6]/i,g=this.matrix[10]/n,x=null,v=l+m+g;if(v>0){let e=2*Math.sqrt(v+1);x=new j((f-c)/e,(h-p)/e,(d-a)/e,.25*e)}else if(l>m&&l>g){let e=2*Math.sqrt(1+l-m-g);x=new j(.25*e,(a+d)/e,(h+p)/e,(f-c)/e)}else if(m>g){let e=2*Math.sqrt(1+m-l-g);x=new j((a+d)/e,.25*e,(c+f)/e,(h-p)/e)}else{let e=2*Math.sqrt(1+g-l-m);x=new j((h+p)/e,(c+f)/e,.25*e,(d-a)/e)}return{translation:e,rotation:x,scale:r}}Determinant(){let e=this.matrix[0],t=this.matrix[1],i=this.matrix[2],n=this.matrix[3],r=this.matrix[4],s=this.matrix[5],o=this.matrix[6],l=this.matrix[7],a=this.matrix[8],h=this.matrix[9],d=this.matrix[10],u=this.matrix[11],m=this.matrix[12],c=this.matrix[13],p=this.matrix[14],f=this.matrix[15];return(e*s-t*r)*(d*f-u*p)-(e*o-i*r)*(h*f-u*c)+(e*l-n*r)*(h*p-d*c)+(t*o-i*s)*(a*f-u*m)-(t*l-n*s)*(a*p-d*m)+(i*l-n*o)*(a*c-h*m)}Invert(){let e=this.matrix[0],t=this.matrix[1],i=this.matrix[2],r=this.matrix[3],s=this.matrix[4],o=this.matrix[5],l=this.matrix[6],a=this.matrix[7],h=this.matrix[8],d=this.matrix[9],u=this.matrix[10],m=this.matrix[11],c=this.matrix[12],p=this.matrix[13],f=this.matrix[14],g=this.matrix[15],x=e*o-t*s,v=e*l-i*s,C=e*a-r*s,y=t*l-i*o,b=t*a-r*o,w=i*a-r*l,M=h*p-d*c,I=h*f-u*c,S=h*g-m*c,T=d*f-u*p,E=d*g-m*p,A=u*g-m*f,G=x*A-v*E+C*T+y*S-b*I+w*M;return n(G,0)?null:new q([(o*A-l*E+a*T)/G,(i*E-t*A-r*T)/G,(p*w-f*b+g*y)/G,(u*b-d*w-m*y)/G,(l*S-s*A-a*I)/G,(e*A-i*S+r*I)/G,(f*C-c*w-g*v)/G,(h*w-u*C+m*v)/G,(s*E-o*S+a*M)/G,(t*S-e*E-r*M)/G,(c*b-p*C+g*x)/G,(d*C-h*b-m*x)/G,(o*I-s*T-l*M)/G,(e*T-t*I+i*M)/G,(p*v-c*y-f*x)/G,(h*y-d*v+u*x)/G])}MultiplyVector(e){let t=e[0],i=e[1],n=e[2],r=e[3],s=this.matrix[0],o=this.matrix[1],l=this.matrix[2],a=this.matrix[3],h=this.matrix[4],d=this.matrix[5],u=this.matrix[6],m=this.matrix[7],c=this.matrix[8],p=this.matrix[9],f=this.matrix[10],g=this.matrix[11];return[t*s+i*h+n*c+r*this.matrix[12],t*o+i*d+n*p+r*this.matrix[13],t*l+i*u+n*f+r*this.matrix[14],t*a+i*m+n*g+r*this.matrix[15]]}MultiplyMatrix(e){let t=this.matrix[0],i=this.matrix[1],n=this.matrix[2],r=this.matrix[3],s=this.matrix[4],o=this.matrix[5],l=this.matrix[6],a=this.matrix[7],h=this.matrix[8],d=this.matrix[9],u=this.matrix[10],m=this.matrix[11],c=this.matrix[12],p=this.matrix[13],f=this.matrix[14],g=this.matrix[15],x=e.matrix[0],v=e.matrix[1],C=e.matrix[2],y=e.matrix[3],b=e.matrix[4],w=e.matrix[5],M=e.matrix[6],I=e.matrix[7],S=e.matrix[8],T=e.matrix[9],E=e.matrix[10],A=e.matrix[11],G=e.matrix[12],D=e.matrix[13],R=e.matrix[14],F=e.matrix[15];return new q([t*x+i*b+n*S+r*G,t*v+i*w+n*T+r*D,t*C+i*M+n*E+r*R,t*y+i*I+n*A+r*F,s*x+o*b+l*S+a*G,s*v+o*w+l*T+a*D,s*C+o*M+l*E+a*R,s*y+o*I+l*A+a*F,h*x+d*b+u*S+m*G,h*v+d*w+u*T+m*D,h*C+d*M+u*E+m*R,h*y+d*I+u*A+m*F,c*x+p*b+f*S+g*G,c*v+p*w+f*T+g*D,c*C+p*M+f*E+g*R,c*y+p*I+f*A+g*F])}}class J{constructor(e){null!=e?this.matrix=e:(this.matrix=new q,this.matrix.CreateIdentity())}SetMatrix(e){return this.matrix=e,this}GetMatrix(){return this.matrix}IsIdentity(){return this.matrix.IsIdentity()}AppendMatrix(e){return this.matrix=this.matrix.MultiplyMatrix(e),this}Append(e){return this.AppendMatrix(e.GetMatrix()),this}TransformCoord3D(e){let t=this.matrix.MultiplyVector([e.x,e.y,e.z,1]);return new o(t[0],t[1],t[2])}Clone(){const e=this.matrix.Clone();return new J(e)}}class X extends class{constructor(){}VertexCount(){return 0}NormalCount(){return 0}TextureUVCount(){return 0}TriangleCount(){return 0}EnumerateVertices(e){}EnumerateTriangleVertexIndices(e){}EnumerateTriangleVertices(e){}}{constructor(){super(),this.name="",this.propertyGroups=[]}GetName(){return this.name}SetName(e){this.name=e}PropertyGroupCount(){return this.propertyGroups.length}AddPropertyGroup(e){return this.propertyGroups.push(e),this.propertyGroups.length-1}GetPropertyGroup(e){return this.propertyGroups[e]}}class $ extends X{constructor(){super(),this.vertices=[],this.normals=[],this.uvs=[],this.triangles=[]}VertexCount(){return this.vertices.length}NormalCount(){return this.normals.length}TextureUVCount(){return this.uvs.length}TriangleCount(){return this.triangles.length}AddVertex(e){return this.vertices.push(e),this.vertices.length-1}SetVertex(e,t){this.vertices[e]=t}GetVertex(e){return this.vertices[e]}AddNormal(e){return this.normals.push(e),this.normals.length-1}SetNormal(e,t){this.normals[e]=t}GetNormal(e){return this.normals[e]}AddTextureUV(e){return this.uvs.push(e),this.uvs.length-1}SetTextureUV(e,t){this.uvs[e]=t}GetTextureUV(e){return this.uvs[e]}AddTriangle(e){return this.triangles.push(e),this.triangles.length-1}GetTriangle(e){return this.triangles[e]}EnumerateVertices(e){for(const t of this.vertices)e(t)}EnumerateTriangleVertexIndices(e){for(const t of this.triangles)e(t.v0,t.v1,t.v2)}EnumerateTriangleVertices(e){for(const t of this.triangles)e(this.vertices[t.v0],this.vertices[t.v1],this.vertices[t.v2])}}class Y{constructor(e,t){this.min=e,this.max=t}GetMin(){return this.min}GetMax(){return this.max}GetCenter(){return new o((this.min.x+this.max.x)/2,(this.min.y+this.max.y)/2,(this.min.z+this.max.z)/2)}}class Z{constructor(){this.box=new Y(new o(1/0,1/0,1/0),new o(-1/0,-1/0,-1/0))}GetBox(){return this.box}AddPoint(e){this.box.min.x=Math.min(this.box.min.x,e.x),this.box.min.y=Math.min(this.box.min.y,e.y),this.box.min.z=Math.min(this.box.min.z,e.z),this.box.max.x=Math.max(this.box.max.x,e.x),this.box.max.y=Math.max(this.box.max.y,e.y),this.box.max.z=Math.max(this.box.max.z,e.z)}}class Q{constructor(e,t){this.boundingBox=e,this.level=t,this.pointItems=[],this.childNodes=[]}AddPoint(e,t,i){let n=this.FindNodeForPoint(e);if(null===n)return!1;if(null!==n.FindPointDirectly(e))return!1;if(n.pointItems.length<i.maxPointsPerNode||n.level>=i.maxTreeDepth)return n.AddPointDirectly(e,t),!0;{n.CreateChildNodes();let r=n.pointItems;n.pointItems=[];for(let e=0;e<r.length;e++){let t=r[e];if(!n.AddPoint(t.point,t.data,i))return!1}return n.AddPoint(e,t,i)}}FindPoint(e){let t=this.FindNodeForPoint(e);return null===t?null:t.FindPointDirectly(e)}AddPointDirectly(e,t){this.pointItems.push({point:e,data:t})}FindPointDirectly(e){for(let t=0;t<this.pointItems.length;t++){let i=this.pointItems[t];if(l(e,i.point))return i.data}return null}FindNodeForPoint(e){if(!this.IsPointInBounds(e))return null;if(0===this.childNodes.length)return this;for(let t=0;t<this.childNodes.length;t++){let i=this.childNodes[t].FindNodeForPoint(e);if(null!==i)return i}return null}CreateChildNodes(){function e(e,t,i,n,r,s,l){let a=new Y(new o(t,i,n),new o(t+r,i+s,n+l));e.childNodes.push(new Q(a,e.level+1,e.options))}let t=this.boundingBox.min,i=this.boundingBox.GetCenter(),n=(this.boundingBox.max.x-this.boundingBox.min.x)/2,r=(this.boundingBox.max.y-this.boundingBox.min.y)/2,s=(this.boundingBox.max.z-this.boundingBox.min.z)/2;e(this,t.x,t.y,t.z,n,r,s),e(this,i.x,t.y,t.z,n,r,s),e(this,t.x,i.y,t.z,n,r,s),e(this,i.x,i.y,t.z,n,r,s),e(this,t.x,t.y,i.z,n,r,s),e(this,i.x,t.y,i.z,n,r,s),e(this,t.x,i.y,i.z,n,r,s),e(this,i.x,i.y,i.z,n,r,s)}IsPointInBounds(e){return i(e.x,this.boundingBox.min.x)&&i(e.y,this.boundingBox.min.y)&&i(e.z,this.boundingBox.min.z)&&t(e.x,this.boundingBox.max.x)&&t(e.y,this.boundingBox.max.y)&&t(e.z,this.boundingBox.max.z)}}class ee{constructor(e,t){this.options={maxPointsPerNode:10,maxTreeDepth:10},void 0!==t&&(void 0!==t.maxPointsPerNode&&(this.options.maxPointsPerNode=t.maxPointsPerNode),void 0!==t.maxTreeDepth&&(this.options.maxTreeDepth=t.maxTreeDepth)),this.rootNode=new Q(e,0,this.options)}AddPoint(e,t){return this.rootNode.AddPoint(e,t,this.options)}FindPoint(e){return this.rootNode.FindPoint(e)}}class te{constructor(){this.edges=[],this.triangles=[]}}class ie{constructor(e,t){this.vertex1=e,this.vertex2=t,this.triangles=[]}}class ne{constructor(e,t){this.edge=e,this.reversed=t}}class re{constructor(){this.triEdge1=null,this.triEdge2=null,this.triEdge3=null}}class se{constructor(){this.vertices=[],this.edges=[],this.triangleEdges=[],this.triangles=[],this.edgeStartToEndVertexMap={}}AddVertex(){return this.vertices.push(new te),this.vertices.length-1}AddTriangle(e,t,i){function n(e,t,i){e[t].triangles.push(i)}function r(e,t,i,n){let r=e[i],s=t[n];r.edges.push(s.edge)}function s(e,t,i,n){e[t[i].edge].triangles.push(n)}let o=this.triangles.length,l=new re;l.triEdge1=this.AddTriangleEdge(e,t),l.triEdge2=this.AddTriangleEdge(t,i),l.triEdge3=this.AddTriangleEdge(i,e),n(this.vertices,e,o),n(this.vertices,t,o),n(this.vertices,i,o),r(this.vertices,this.triangleEdges,e,l.triEdge1),r(this.vertices,this.triangleEdges,t,l.triEdge2),r(this.vertices,this.triangleEdges,i,l.triEdge3),s(this.edges,this.triangleEdges,l.triEdge1,o),s(this.edges,this.triangleEdges,l.triEdge2,o),s(this.edges,this.triangleEdges,l.triEdge3,o),this.triangles.push(l)}AddTriangleEdge(e,t){let i=e,n=t,r=!1;t<e&&(i=t,n=e,r=!0);let s=this.AddEdge(i,n);return this.triangleEdges.push(new ne(s,r)),this.triangleEdges.length-1}AddEdge(e,t){void 0===this.edgeStartToEndVertexMap[e]&&(this.edgeStartToEndVertexMap[e]=[]);let i=this.edgeStartToEndVertexMap[e];for(let e=0;e<i.length;e++){let n=i[e];if(n.endVertex===t)return n.edgeIndex}let n=this.edges.length;return i.push({endVertex:t,edgeIndex:n}),this.edges.push(new ie(e,t)),n}}function oe(e,t,i){let n=d(a(t,e),a(i,e));return n.Normalize(),n}function le(e,t){if(!t.IsIdentity()){for(let i=0;i<e.VertexCount();i++){let n=e.GetVertex(i),r=t.TransformCoord3D(n);n.x=r.x,n.y=r.y,n.z=r.z}if(e.NormalCount()>0){let i=t.GetMatrix().DecomposeTRS(),n=(new q).ComposeTRS(new o(0,0,0),i.rotation,new o(1,1,1)),r=new J(n);for(let t=0;t<e.NormalCount();t++){let i=e.GetNormal(t),n=r.TransformCoord3D(i);i.x=n.x,i.y=n.y,i.z=n.z}}}}function ae(e){let t=!0;return e.EnumerateMeshInstances((e=>{e.TriangleCount()>0&&(t=!1)})),t}function he(e,t){e.EnumerateMeshInstances((e=>{e.EnumerateVertices((e=>{t.onVertex(e.x,e.y,e.z)}))}));let i=0;e.EnumerateMeshInstances((e=>{e.EnumerateTriangleVertexIndices(((e,n,r)=>{t.onTriangle(e+i,n+i,r+i)})),i+=e.VertexCount()}))}function de(e,t){e.EnumerateTriangleVertices(((e,i,n)=>{let r=oe(e,i,n);t(e,i,n,r)}))}function ue(e){let t=new Z;return e.EnumerateVertices((e=>{t.AddPoint(e)})),t.GetBox()}function me(e,t){for(let i=0;i<e.MaterialCount();i++){let n=e.GetMaterial(i);n.isDefault&&(n.color=t)}}class ce{constructor(e,t,i){this.type=e,this.name=t,this.value=i}}class pe{constructor(e){this.name=e,this.properties=[]}PropertyCount(){return this.properties.length}AddProperty(e){this.properties.push(e)}GetProperty(e){return this.properties[e]}}function fe(e){if(!function(e){function t(e,t,i){const n=e.triangles[t],r=e.triangleEdges[n.triEdge1],s=e.triangleEdges[n.triEdge2],o=e.triangleEdges[n.triEdge3];return r.edge===i?r.reversed:s.edge===i?s.reversed:o.edge===i?o.reversed:null}const i=function(e){function t(e,t,i){let n=t.FindPoint(e);return null===n&&(n=i.AddVertex(),t.AddPoint(e,n)),n}let i=ue(e),n=new ee(i),r=new se;return e.EnumerateTriangleVertices(((e,i,s)=>{let o=t(e,n,r),l=t(i,n,r),a=t(s,n,r);r.AddTriangle(o,l,a)})),r}(e);for(let e=0;e<i.edges.length;e++){const n=i.edges[e];let r=n.triangles.length;if(0===r||r%2!=0)return!1;let s=0;for(let r=0;r<n.triangles.length;r++)t(i,n.triangles[r],e)?s+=1:s-=1;if(0!==s)return!1}return!0}(e))return null;let t=0;return e.EnumerateTriangleVertices(((e,i,n)=>{t+=function(e,t,i){return n=e,r=d(t,i),(n.x*r.x+n.y*r.y+n.z*r.z)/6;var n,r}(e,i,n)})),t}function ge(e){let t=e.lastIndexOf("/");-1===t&&(t=e.lastIndexOf("\\"));let i=e;-1!==t&&(i=e.substr(t+1));let n=i.indexOf("?");return-1!==n&&(i=i.substr(0,n)),decodeURI(i)}function xe(e){let t=ge(e),i=t.lastIndexOf(".");return-1===i?"":t.substr(i+1).toLowerCase()}class ve{constructor(){this.backgroundColor=new Color(255,255,255),this.defaultColor=new Color(200,200,200),this.themeId=1}LoadFromCookies(e){this.backgroundColor=e.GetColorVal("ov_background_color",new Color(255,255,255)),this.defaultColor=e.GetColorVal("ov_default_color",new Color(200,200,200)),this.themeId=e.GetIntVal("ov_theme_id",1)}SaveToCookies(e){e.SetColorVal("ov_background_color",this.backgroundColor),e.SetColorVal("ov_default_color",this.defaultColor),e.SetStringVal("ov_theme_id",this.themeId)}}class Ce{constructor(){this.count=null,this.current=null,this.callbacks=null}Run(e,t){this.count=e,this.current=0,this.callbacks=t,0===e?this.TaskReady():this.RunOnce()}RunBatch(e,t,i){let n=0;e>0&&(n=parseInt((e-1)/t,10)+1),this.Run(n,{runTask:(n,r)=>{const s=n*t,o=Math.min((n+1)*t,e)-1;i.runTask(s,o,r)},onReady:i.onReady})}RunOnce(){setTimeout((()=>{this.callbacks.runTask(this.current,this.TaskReady.bind(this))}),0)}TaskReady(){this.current+=1,this.current<this.count?this.RunOnce():this.callbacks.onReady&&this.callbacks.onReady()}}function ye(e){setTimeout((()=>{e()}),0)}class be extends class{constructor(e){this.parentDiv=e,this.panelDiv=U.AddDiv(e),U.HideDomElement(this.panelDiv),this.visible=!1}GetIcon(){return null}IsVisible(){return this.visible}Show(e){this.visible!==e&&(this.visible=e,this.visible?U.ShowDomElement(this.panelDiv):U.HideDomElement(this.panelDiv))}Resize(){}Clear(){}}{constructor(e){super(e),this.callbacks=null,this.titleDiv=U.AddDiv(this.panelDiv,"ov_sidebar_title"),this.contentDiv=U.AddDiv(this.panelDiv,"ov_sidebar_content ov_thin_scrollbar");let t=this.GetName();U.AddDiv(this.titleDiv,"ov_sidebar_title_text",this.GetName()),this.titleDiv.setAttribute("title",t)}GetName(){return null}Clear(){U.ClearDomElement(this.contentDiv)}Init(e){this.callbacks=e}}class we extends be{constructor(e){super(e)}GetName(){return"Details"}GetIcon(){return"details"}AddObject3DProperties(e){this.Clear();let t=U.AddDiv(this.contentDiv,"ov_property_table"),i=ue(e),n=a(i.max,i.min);if(this.AddProperty(t,new ce(2,"Vertices",e.VertexCount())),this.AddProperty(t,new ce(2,"Triangles",e.TriangleCount())),this.AddProperty(t,new ce(3,"Size X",n.x)),this.AddProperty(t,new ce(3,"Size Y",n.y)),this.AddProperty(t,new ce(3,"Size Z",n.z)),this.AddCalculatedProperty(t,"Volume",(()=>{const t=fe(e);return null===t?null:new ce(3,null,t)})),this.AddCalculatedProperty(t,"Surface",(()=>{const t=function(e){let t=0;return e.EnumerateTriangleVertices(((e,i,n)=>{t+=function(e,t,i){const n=h(e,t),r=h(t,i),s=h(e,i),o=(n+r+s)/2,l=o*(o-n)*(o-r)*(o-s);return l<0?0:Math.sqrt(l)}(e,i,n)})),t}(e);return null===t?null:new ce(3,null,t)})),e.PropertyGroupCount()>0){let t=U.AddDiv(this.contentDiv,"ov_property_table ov_property_table_custom");for(let i=0;i<e.PropertyGroupCount();i++){const n=e.GetPropertyGroup(i);this.AddPropertyGroup(t,n);for(let e=0;e<n.PropertyCount();e++){const i=n.GetProperty(e);this.AddPropertyInGroup(t,i)}}}this.Resize()}AddMaterialProperties(e){function t(e,t,i,n){if(null===n||null===n.name)return;let r=ge(n.name);e.AddProperty(t,new ce(1,i,r))}this.Clear();let i=U.AddDiv(this.contentDiv,"ov_property_table"),n=null;1===e.type?n="Phong":2===e.type&&(n="Physical"),this.AddProperty(i,new ce(1,"Source",e.isDefault?"Default":"Model")),this.AddProperty(i,new ce(1,"Type",n)),this.AddProperty(i,new ce(6,"Color",e.color)),1===e.type?(this.AddProperty(i,new ce(6,"Ambient",e.ambient)),this.AddProperty(i,new ce(6,"Specular",e.specular))):2===e.type&&(this.AddProperty(i,new ce(5,"Metalness",e.metalness)),this.AddProperty(i,new ce(5,"Roughness",e.roughness))),this.AddProperty(i,new ce(5,"Opacity",e.opacity)),t(this,i,"Diffuse Map",e.diffuseMap),t(this,i,"Specular Map",e.specularMap),t(this,i,"Bump Map",e.bumpMap),t(this,i,"Normal Map",e.normalMap),t(this,i,"Emissive Map",e.emissiveMap),t(this,i,"Metallic Map",e.metalnessMap),this.Resize()}AddPropertyGroup(e,t){U.AddDiv(e,"ov_property_table_row group",t.name).setAttribute("title",t.name)}AddProperty(e,t){let i=U.AddDiv(e,"ov_property_table_row"),n=U.AddDiv(i,"ov_property_table_cell ov_property_table_name",t.name+":"),r=U.AddDiv(i,"ov_property_table_cell ov_property_table_value");return n.setAttribute("title",t.name),this.DisplayPropertyValue(t,r),i}AddPropertyInGroup(e,t){this.AddProperty(e,t).classList.add("ingroup")}AddCalculatedProperty(e,t,i){let n=U.AddDiv(e,"ov_property_table_row"),r=U.AddDiv(n,"ov_property_table_cell ov_property_table_name",t+":"),s=U.AddDiv(n,"ov_property_table_cell ov_property_table_value");r.setAttribute("title",t),U.AddDiv(s,"ov_property_table_button","Calculate...").addEventListener("click",(()=>{U.ClearDomElement(s),s.innerHTML="Please wait...",ye((()=>{let e=i();null===e?s.innerHTML="-":this.DisplayPropertyValue(e,s)}))}))}DisplayPropertyValue(e,t){U.ClearDomElement(t);let i=null;if(1===e.type)i=e.value;else if(2===e.type)i=e.value.toLocaleString();else if(3===e.type)i=e.value.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2});else if(4===e.type)i=e.value?"True":"False";else if(5===e.type)i=parseInt(100*e.value,10).toString()+"%";else if(6===e.type){let i="#"+w(e.value),n=CreateInlineColorCircle(e.value);t.appendChild(n),U.AddDomElement(t,"span",null,i)}null!==i&&(t.innerHTML=i,t.setAttribute("title",i))}}class Me extends be{constructor(e){super(e),this.backgroundColorInput=null,this.defaultColorInput=null,this.defaultColorWarning=null,this.themeInput=null}GetName(){return"Settings"}GetIcon(){return"settings"}Clear(){this.backgroundColorInput.pickr.hide(),this.defaultColorInput.pickr.hide()}InitSettings(e,t,i){this.Init(i),this.backgroundColorInput=this.AddColorParameter("Background Color","Affects only the visualization.",null,["#ffffff","#e3e3e3","#c9c9c9","#898989","#5f5f5f","#494949","#383838","#0f0f0f"],e.backgroundColor,this.callbacks.onBackgroundColorChange),this.defaultColorInput=this.AddColorParameter("Default Color","Appears when the model doesn't have materials.","Has no effect on the currently loaded file.",["#ffffff","#e3e3e3","#cc3333","#fac832","#4caf50","#3393bd","#9b27b0","#fda4b8"],e.defaultColor,this.callbacks.onDefaultColorChange),this.themeInput=this.AddThemeParameter(e.themeId),this.AddResetToDefaultsButton(t)}Update(e){let t=function(e){for(let t=0;t<e.MaterialCount();t++)if(e.GetMaterial(t).isDefault)return!0;return!1}(e);t?U.HideDomElement(this.defaultColorInput.warning):U.ShowDomElement(this.defaultColorInput.warning),this.Resize()}AddColorParameter(e,t,i,n,r,s){let o=U.AddDiv(this.contentDiv,"ov_sidebar_settings_content"),l=U.AddDiv(o,"ov_sidebar_subtitle"),a=U.AddDiv(l,"color-picker");U.AddDomElement(l,"span",null,e);const h=Pickr.create({el:a,theme:"monolith",position:"left-start",swatches:n,comparison:!1,default:"#"+w(r),components:{preview:!1,opacity:!1,hue:!0,interaction:{hex:!1,rgba:!1,hsla:!1,hsva:!1,cmyk:!1,input:!0,clear:!1,save:!1}}});h.on("change",((e,t,i)=>{let n=e.toRGBA(),r=new g(parseInt(n[0],10),parseInt(n[1],10),parseInt(n[2],10));s(r)})),U.AddDiv(o,"ov_sidebar_settings_padded",t);let d=null;return null!==i&&(d=U.AddDiv(o,"ov_sidebar_settings_padded"),B.AddSvgIconElement(d,"warning","left_inline").classList.add("light"),U.AddDiv(d,"ov_sidebar_settings_warning",i)),{pickr:h,warning:d}}AddThemeParameter(e){function t(e,t,i,n){let r=U.AddDiv(e,"ov_sidebar_settings_row"),s=U.AddDomElement(r,"label");s.setAttribute("for",t.toString());let o=U.AddDomElement(s,"input","ov_radio_button");return o.setAttribute("type","radio"),o.setAttribute("id",t.toString()),o.setAttribute("name","theme"),U.AddDomElement(s,"span",null,i),o.addEventListener("change",(()=>{n(t)})),o}function i(e,t){for(let i=0;i<e.length;i++){let n=e[i];n.checked=n.getAttribute("id")===t.toString()}}let n=U.AddDiv(this.contentDiv,"ov_sidebar_settings_content"),r=U.AddDiv(n,"ov_sidebar_subtitle");B.AddSvgIconElement(r,"theme","ov_sidebar_subtitle_icon"),U.AddDiv(r,null,"Appearance");let s=U.AddDiv(n,"ov_sidebar_settings_padded"),o={buttons:[],select:e=>{i(o.buttons,e)}};return o.buttons.push(t(s,1,"Light",this.callbacks.onThemeChange)),o.buttons.push(t(s,2,"Dark",this.callbacks.onThemeChange)),i(o.buttons,e),o}AddResetToDefaultsButton(e){U.AddDiv(this.contentDiv,"ov_button outline ov_sidebar_button","Reset to Default").addEventListener("click",(()=>{this.backgroundColorInput.pickr.setColor("#"+w(e.backgroundColor)),this.callbacks.onBackgroundColorChange(e.backgroundColor),this.defaultColorInput.pickr.setColor("#"+w(e.defaultColor)),this.callbacks.onDefaultColorChange(e.defaultColor),null!==this.themeInput&&(this.themeInput.select(e.themeId),this.callbacks.onThemeChange(e.themeId))}))}}class Ie{constructor(e,t){this.mainDiv=e,this.splitterDiv=t,this.panelSet=new W(e),this.detailsPanel=new we(this.panelSet.GetContentDiv()),this.settingsPanel=new Me(this.panelSet.GetContentDiv()),this.panelSet.AddPanel(this.detailsPanel),this.panelSet.AddPanel(this.settingsPanel),this.panelSet.ShowPanel(this.detailsPanel)}IsPanelsVisible(){return this.panelSet.IsPanelsVisible()}ShowPanels(e){this.panelSet.ShowPanels(e)}Init(e,t){this.callbacks=t,this.panelSet.Init({onResize:()=>{this.panelSet.IsPanelsVisible()?U.ShowDomElement(this.splitterDiv):U.HideDomElement(this.splitterDiv),this.callbacks.onResize()},onShowHidePanels:e=>{this.callbacks.onShowHidePanels(e)}});let i=new ve;this.settingsPanel.InitSettings(e,i,{onBackgroundColorChange:e=>{this.callbacks.onBackgroundColorChange(e)},onDefaultColorChange:e=>{this.callbacks.onDefaultColorChange(e)},onThemeChange:e=>{this.callbacks.onThemeChange(e)}}),B.InstallVerticalSplitter(this.splitterDiv,this.mainDiv,!0,(()=>{this.callbacks.onResize()}))}Update(e){this.settingsPanel.Update(e)}Resize(e){U.SetDomElementOuterHeight(this.mainDiv,e),U.SetDomElementHeight(this.splitterDiv,e),this.panelSet.Resize()}GetWidth(){let e=U.GetDomElementOuterWidth(this.mainDiv),t=0;return this.panelSet.IsPanelsVisible()&&(t=this.splitterDiv.offsetWidth),e+t}DecreaseWidth(e){let t=this.mainDiv.offsetWidth;U.SetDomElementWidth(this.mainDiv,t-e)}Clear(){this.panelSet.Clear()}AddObject3DProperties(e){this.detailsPanel.AddObject3DProperties(e)}AddMaterialProperties(e){this.detailsPanel.AddMaterialProperties(e)}}class Se{constructor(e){this.eventHandler=e}HandleEvent(e,t){void 0!==this.eventHandler&&null!==this.eventHandler&&this.eventHandler(e,t)}}function Te(e){return new TextDecoder("utf-8").decode(e)}function Ee(e){return(new TextEncoder).encode(e).buffer}function Ae(e){let t="data:";if(!e.startsWith(t))return null;let i=e.indexOf(";");if(-1===i)return null;let n=e.indexOf(",");if(-1===n)return null;let r=e.substr(t.length,i-5),s=atob(e.substr(n+1)),o=new ArrayBuffer(s.length),l=new Uint8Array(o);for(let e=0;e<s.length;e++)l[e]=s.charCodeAt(e);return{mimeType:r,buffer:o}}function Ge(e){if(null==e)return"";let t=e.split("/");return 0===t.length?"":t[t.length-1]}function De(e){let t=new Blob([e]);return URL.createObjectURL(t)}function Re(e,t){let i=new Blob([e],{type:t});return URL.createObjectURL(i)}class Fe{constructor(){this.nextId=0}GenerateId(){const e=this.nextId;return this.nextId+=1,e}}class _e{constructor(){this.type=0,this.name="",this.parent=null,this.transformation=new J,this.childNodes=[],this.meshIndices=[],this.idGenerator=new Fe,this.id=this.idGenerator.GenerateId()}IsEmpty(){return 0===this.childNodes.length&&0===this.meshIndices.length}GetType(){return this.type}SetType(e){this.type=e}GetId(){return this.id}GetName(){return this.name}SetName(e){this.name=e}HasParent(){return null!==this.parent}GetParent(){return this.parent}GetTransformation(){return this.transformation}GetWorldTransformation(){let e=this.transformation.Clone(),t=this.parent;for(;null!==t;)e.Append(t.transformation),t=t.parent;return e}SetTransformation(e){this.transformation=e}AddChildNode(e){return e.parent=this,e.idGenerator=this.idGenerator,e.id=e.idGenerator.GenerateId(),this.childNodes.push(e),this.childNodes.length-1}RemoveChildNode(e){e.parent=null;let t=this.childNodes.indexOf(e);this.childNodes.splice(t,1)}GetChildNodes(){return this.childNodes}ChildNodeCount(){return this.childNodes.length}GetChildNode(e){return this.childNodes[e]}AddMeshIndex(e){return this.meshIndices.push(e),this.meshIndices.length-1}MeshIndexCount(){return this.meshIndices.length}GetMeshIndex(e){return this.meshIndices[e]}GetMeshIndices(){return this.meshIndices}Enumerate(e){e(this);for(const t of this.childNodes)t.Enumerate(e)}EnumerateChildren(e){for(const t of this.childNodes)e(t),t.EnumerateChildren(e)}EnumerateMeshIndices(e){for(const t of this.meshIndices)e(t);for(const t of this.childNodes)t.EnumerateMeshIndices(e)}}class Le extends X{constructor(e,t){super(),this.node=e,this.mesh=t}VertexCount(){return this.mesh.VertexCount()}NormalCount(){return this.mesh.NormalCount()}TextureUVCount(){return this.mesh.TextureUVCount()}TriangleCount(){return this.mesh.TriangleCount()}EnumerateVertices(e){let t=this.node.GetWorldTransformation();t.IsIdentity()?this.mesh.EnumerateVertices(e):this.mesh.EnumerateVertices((i=>{const n=t.TransformCoord3D(i);e(n)}))}EnumerateTriangleVertexIndices(e){this.mesh.EnumerateTriangleVertexIndices(e)}EnumerateTriangleVertices(e){let t=this.node.GetWorldTransformation();t.IsIdentity()?this.mesh.EnumerateTriangleVertices(e):this.mesh.EnumerateTriangleVertices(((i,n,r)=>{const s=t.TransformCoord3D(i),o=t.TransformCoord3D(n),l=t.TransformCoord3D(r);e(s,o,l)}))}PropertyGroupCount(){return this.mesh.PropertyGroupCount()}AddPropertyGroup(e){return this.mesh.AddPropertyGroup(e)}GetPropertyGroup(e){return this.mesh.GetPropertyGroup(e)}GetTransformedMesh(){let e=this.node.GetWorldTransformation();const t=function(e){let t=new $;t.SetName(e.GetName());for(let i=0;i<e.VertexCount();i++){let n=e.GetVertex(i);t.AddVertex(n.Clone())}for(let i=0;i<e.NormalCount();i++){let n=e.GetNormal(i);t.AddNormal(n.Clone())}for(let i=0;i<e.TextureUVCount();i++){let n=e.GetTextureUV(i);t.AddTextureUV(n.Clone())}for(let i=0;i<e.TriangleCount();i++){let n=e.GetTriangle(i);t.AddTriangle(n.Clone())}return t}(this.mesh);return le(t,e),t}}class Ve extends X{constructor(){super(),this.root=new _e,this.materials=[],this.meshes=[]}GetRootNode(){return this.root}MaterialCount(){return this.materials.length}MeshCount(){return this.meshes.length}MeshInstanceCount(){let e=0;return this.root.Enumerate((t=>{e+=t.MeshIndexCount()})),e}VertexCount(){let e=0;return this.EnumerateMeshInstances((t=>{e+=t.VertexCount()})),e}NormalCount(){let e=0;return this.EnumerateMeshInstances((t=>{e+=t.NormalCount()})),e}TextureUVCount(){let e=0;return this.EnumerateMeshInstances((t=>{e+=t.TextureUVCount()})),e}TriangleCount(){let e=0;return this.EnumerateMeshInstances((t=>{e+=t.TriangleCount()})),e}AddMaterial(e){return this.materials.push(e),this.materials.length-1}GetMaterial(e){return this.materials[e]}AddMesh(e){return this.meshes.push(e),this.meshes.length-1}AddMeshToRootNode(e){const t=this.AddMesh(e);return this.root.AddMeshIndex(t),t}RemoveMesh(e){this.meshes.splice(e,1),this.root.Enumerate((t=>{for(let i=0;i<t.meshIndices.length;i++)t.meshIndices[i]===e?(t.meshIndices.splice(i,1),i-=1):t.meshIndices[i]>e&&(t.meshIndices[i]-=1)}))}GetMesh(e){return this.meshes[e]}GetMeshInstance(e){let t=null;if(this.root.Enumerate((i=>{i.GetId()===e.nodeId&&(t=i)})),null===t)return null;if(-1===t.GetMeshIndices().indexOf(e.meshIndex))return null;let i=this.GetMesh(e.meshIndex);return new Le(t,i)}EnumerateMeshes(e){for(const t of this.meshes)e(t)}EnumerateMeshInstances(e){this.root.Enumerate((t=>{for(let i of t.GetMeshIndices()){let n=this.GetMesh(i),r=new Le(t,n);e(r)}}))}EnumerateTransformedMeshes(e){this.EnumerateMeshInstances((t=>{const i=t.GetTransformedMesh();e(i)}))}EnumerateVertices(e){this.EnumerateMeshInstances((t=>{t.EnumerateVertices(e)}))}EnumerateTriangleVertexIndices(e){this.EnumerateMeshInstances((t=>{t.EnumerateTriangleVertexIndices(e)}))}EnumerateTriangleVertices(e){this.EnumerateMeshInstances((t=>{t.EnumerateTriangleVertices(e)}))}}class Pe{constructor(){this.name=null,this.extension=null,this.callbacks=null,this.model=null,this.error=null,this.message=null}Import(e,t,i,n){this.Clear(),this.name=e,this.extension=t,this.callbacks=n,this.model=new Ve,this.error=!1,this.message=null,this.ResetContent(),this.ImportContent(i,(()=>{this.CreateResult(n)}))}Clear(){this.name=null,this.extension=null,this.callbacks=null,this.model=null,this.error=null,this.message=null,this.ClearContent()}CreateResult(e){return this.error?(e.onError(),void e.onComplete()):ae(this.model)?(this.error=!0,e.onError(),void e.onComplete()):(function(e,t){function i(e,t){function i(e,t,i){if(!t.HasNormals())if(null===t.curve||0===t.curve){let i=oe(e.GetVertex(t.v0),e.GetVertex(t.v1),e.GetVertex(t.v2)),n=e.AddNormal(i);t.SetNormals(n,n,n)}else i.calculateCurveNormals=!0;null===t.mat&&(t.mat=i.getDefaultMaterialIndex()),null===t.curve&&(t.curve=0)}let n={getDefaultMaterialIndex:t,calculateCurveNormals:!1};for(let t=0;t<e.TriangleCount();t++){let r=e.GetTriangle(t);i(e,r,n)}n.calculateCurveNormals&&function(e){function t(e,t,i,n,r){function s(e,t){for(let i=0;i<e.length;i++)if(l(e[i],t))return!0;return!1}let a=[],h=r[i];for(let i=0;i<h.length;i++){let r=h[i],o=e.GetTriangle(r);if(t.curve===o.curve){let e=n[r];s(a,e)||a.push(e)}}let d=new o(0,0,0);for(let e=0;e<a.length;e++)u=d,m=a[e],d=new o(u.x+m.x,u.y+m.y,u.z+m.z);var u,m;return d.MultiplyScalar(1/a.length),d.Normalize(),e.AddNormal(d)}let i=[],n={};for(let t=0;t<e.VertexCount();t++)n[t]=[];for(let t=0;t<e.TriangleCount();t++){let r=e.GetTriangle(t),s=oe(e.GetVertex(r.v0),e.GetVertex(r.v1),e.GetVertex(r.v2));i.push(s),n[r.v0].push(t),n[r.v1].push(t),n[r.v2].push(t)}for(let r=0;r<e.TriangleCount();r++){let s=e.GetTriangle(r);if(!s.HasNormals()){let r=t(e,s,s.v0,i,n),o=t(e,s,s.v1,i,n),l=t(e,s,s.v2,i,n);s.SetNormals(r,o,l)}}}(e)}let n=null,r=function(){if(null===n){let i=t();i.isDefault=!0,n=e.AddMaterial(i)}return n};for(let t=0;t<e.MeshCount();t++){let n=e.GetMesh(t);0!==n.TriangleCount()?i(n,r):(e.RemoveMesh(t),t-=1)}let s=e.GetRootNode(),a=[];s.EnumerateChildren((e=>{e.IsEmpty()&&a.push(e)}));for(let e=0;e<a.length;e++){let t=a[e],i=t.GetParent();null!==i&&(i.RemoveChildNode(t),i.IsEmpty()&&a.push(i))}}(this.model,this.callbacks.getDefaultMaterial),e.onSuccess(),void e.onComplete())}CanImportExtension(e){return!1}GetUpDirection(){return 3}ClearContent(){}ResetContent(){}ImportContent(e,t){}GetModel(){return this.model}SetError(e){this.error=!0,null!=e&&(this.message=e)}WasError(){return this.error}GetErrorMessage(){return this.message}}function Ne(e,t,i){let n=e.substr(t),r=n.indexOf(i);return-1!==r&&(n=n.substr(0,r)),n.trim()}function ke(e,t){if(null!==t){let i=e.indexOf(t);-1!==i&&(e=e.substr(0,i).trim())}return e.split(/\s+/u)}function He(e,t){function i(e,t){let i=e.trim();i.length>0&&t(i)}let n=0,r=e.indexOf("\n",n);for(;-1!==r;)i(e.substr(n,r-n),t),n=r+1,r=e.indexOf("\n",n);i(e.substr(n),t)}function Ue(t){t.transparent=!1,1-t.opacity>e&&(t.transparent=!0)}class Be{constructor(e,t,i){this.v0=e,this.v1=t,this.v2=i,this.n0=null,this.n1=null,this.n2=null,this.u0=null,this.u1=null,this.u2=null,this.mat=null,this.curve=null}HasVertices(){return null!==this.v0&&null!==this.v1&&null!==this.v2}HasNormals(){return null!==this.n0&&null!==this.n1&&null!==this.n2}HasTextureUVs(){return null!==this.u0&&null!==this.u1&&null!==this.u2}SetVertices(e,t,i){return this.v0=e,this.v1=t,this.v2=i,this}SetNormals(e,t,i){return this.n0=e,this.n1=t,this.n2=i,this}SetTextureUVs(e,t,i){return this.u0=e,this.u1=t,this.u2=i,this}SetMaterial(e){return this.mat=e,this}SetCurve(e){return this.curve=e,this}Clone(){let e=new Be(this.v0,this.v1,this.v2);return e.SetNormals(this.n0,this.n1,this.n2),e.SetTextureUVs(this.u0,this.u1,this.u2),e.SetMaterial(this.mat),e.SetCurve(this.curve),e}}class Oe{constructor(e){this.mesh=e,this.globalToCurrentVertices=new Map,this.globalToCurrentNormals=new Map,this.globalToCurrentUvs=new Map}GetLocalVertexIndex(e,t){return this.GetLocalIndex(e,t,this.globalToCurrentVertices,(e=>this.mesh.AddVertex(new o(e.x,e.y,e.z))))}GetLocalNormalIndex(e,t){return this.GetLocalIndex(e,t,this.globalToCurrentNormals,(e=>this.mesh.AddNormal(new o(e.x,e.y,e.z))))}GetLocalUVIndex(e,t){return this.GetLocalIndex(e,t,this.globalToCurrentUvs,(e=>this.mesh.AddTextureUV(new c(e.x,e.y))))}AddTriangle(e){this.mesh.AddTriangle(e)}GetLocalIndex(e,t,i,n){if(isNaN(e)||e<0||e>=t.length)return null;if(i.has(e))return i.get(e);{let r=n(t[e]);return i.set(e,r),r}}}class ze extends Pe{constructor(){super()}CanImportExtension(e){return"obj"===e}GetUpDirection(){return 2}ClearContent(){this.globalVertices=null,this.globalNormals=null,this.globalUvs=null,this.currentMeshData=null,this.currentMaterial=null,this.currentMaterialIndex=null,this.meshNameToMeshData=null,this.materialNameToIndex=null}ResetContent(){this.globalVertices=[],this.globalNormals=[],this.globalUvs=[],this.currentMeshData=null,this.currentMaterial=null,this.currentMaterialIndex=null,this.meshNameToMeshData=new Map,this.materialNameToIndex=new Map}ImportContent(e,t){He(Te(e),(e=>{this.WasError()||this.ProcessLine(e)})),t()}ProcessLine(e){if("#"===e[0])return;let t=ke(e,"#");if(0===t.length)return;let i=t[0].toLowerCase();t.shift(),this.ProcessMeshParameter(i,t,e)||this.ProcessMaterialParameter(i,t,e)}AddNewMesh(e){if(this.meshNameToMeshData.has(e))this.currentMeshData=this.meshNameToMeshData.get(e);else{let t=new $;t.SetName(e),this.model.AddMeshToRootNode(t),this.currentMeshData=new Oe(t),this.meshNameToMeshData.set(e,this.currentMeshData)}}ProcessMeshParameter(e,t,i){if("g"===e||"o"===e){if(0===t.length)return!0;let n=Ne(i,e.length,"#");return this.AddNewMesh(n),!0}return"v"===e?(t.length<3||this.globalVertices.push(new o(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),!0):"vn"===e?(t.length<3||this.globalNormals.push(new o(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),!0):"vt"===e?(t.length<2||this.globalUvs.push(new c(parseFloat(t[0]),parseFloat(t[1]))),!0):"f"===e&&(t.length<3||this.ProcessFace(t),!0)}ProcessMaterialParameter(e,t,i){function n(e){return new g(parseInt(parseFloat(255*e[0]),10),parseInt(parseFloat(255*e[1]),10),parseInt(parseFloat(255*e[2]),10))}function r(e,t,i){let n=new TextureMap,r=Ne(t,e.length,"#"),s=i.getTextureBuffer(r);return n.name=r,null!==s&&(n.url=s.url,n.buffer=s.buffer),n}if("newmtl"===e){if(0===t.length)return!0;let n=new v(1),r=Ne(i,e.length,"#"),s=this.model.AddMaterial(n);return n.name=r,this.currentMaterial=n,this.materialNameToIndex.set(r,s),!0}if("usemtl"===e){if(0===t.length)return!0;let n=Ne(i,e.length,"#");return this.materialNameToIndex.has(n)&&(this.currentMaterialIndex=this.materialNameToIndex.get(n)),!0}if("mtllib"===e){if(0===t.length)return!0;let n=Ne(i,e.length,"#"),r=this.callbacks.getFileBuffer(n);return null!==r&&He(Te(r),(e=>{this.WasError()||this.ProcessLine(e)})),!0}return"map_kd"===e?(null===this.currentMaterial||0===t.length||(this.currentMaterial.diffuseMap=r(e,i,this.callbacks),Ue(this.currentMaterial)),!0):"map_ks"===e?(null===this.currentMaterial||0===t.length||(this.currentMaterial.specularMap=r(e,i,this.callbacks)),!0):"map_bump"===e||"bump"===e?(null===this.currentMaterial||0===t.length||(this.currentMaterial.bumpMap=r(e,i,this.callbacks)),!0):"ka"===e?(null===this.currentMaterial||t.length<3||(this.currentMaterial.ambient=n(t)),!0):"kd"===e?(null===this.currentMaterial||t.length<3||(this.currentMaterial.color=n(t)),!0):"ks"===e?(null===this.currentMaterial||t.length<3||(this.currentMaterial.specular=n(t)),!0):"ns"===e?(null===this.currentMaterial||t.length<1||(this.currentMaterial.shininess=parseFloat(t[0])/1e3),!0):"tr"===e?(null===this.currentMaterial||t.length<1||(this.currentMaterial.opacity=1-parseFloat(t[0]),Ue(this.currentMaterial)),!0):"d"===e&&(null===this.currentMaterial||t.length<1||(this.currentMaterial.opacity=parseFloat(t[0]),Ue(this.currentMaterial)),!0)}ProcessFace(e){function t(e,t){return e>0?e-1:t+e}let i=[],n=[],r=[];for(let s=0;s<e.length;s++){let o=e[s].split("/");i.push(t(parseInt(o[0],10),this.globalVertices.length)),o.length>1&&o[1].length>0&&r.push(t(parseInt(o[1],10),this.globalUvs.length)),o.length>2&&o[2].length>0&&n.push(t(parseInt(o[2],10),this.globalNormals.length))}null===this.currentMeshData&&this.AddNewMesh("");for(let e=0;e<i.length-2;e++){let t=this.currentMeshData.GetLocalVertexIndex(i[0],this.globalVertices),s=this.currentMeshData.GetLocalVertexIndex(i[e+1],this.globalVertices),o=this.currentMeshData.GetLocalVertexIndex(i[e+2],this.globalVertices);if(null===t||null===s||null===o){this.SetError("Invalid vertex index.");break}let l=new Be(t,s,o);if(n.length===i.length){let t=this.currentMeshData.GetLocalNormalIndex(n[0],this.globalNormals),i=this.currentMeshData.GetLocalNormalIndex(n[e+1],this.globalNormals),r=this.currentMeshData.GetLocalNormalIndex(n[e+2],this.globalNormals);if(null===t||null===i||null===r){this.SetError("Invalid normal index.");break}l.SetNormals(t,i,r)}if(r.length===i.length){let t=this.currentMeshData.GetLocalUVIndex(r[0],this.globalUvs),i=this.currentMeshData.GetLocalUVIndex(r[e+1],this.globalUvs),n=this.currentMeshData.GetLocalUVIndex(r[e+2],this.globalUvs);if(null===t||null===i||null===n){this.SetError("Invalid uv index.");break}l.SetTextureUVs(t,i,n)}null!==this.currentMaterialIndex&&(l.mat=this.currentMaterialIndex),this.currentMeshData.AddTriangle(l)}}}class We{constructor(e,t){this.arrayBuffer=e,this.dataView=new DataView(e),this.isLittleEndian=t,this.position=0}GetPosition(){return this.position}SetPosition(e){this.position=e}GetByteLength(){return this.arrayBuffer.byteLength}Skip(e){this.position=this.position+e}End(){return this.position>=this.arrayBuffer.byteLength}ReadArrayBuffer(e){let t=new Uint8Array(this.arrayBuffer),i=new ArrayBuffer(e),n=new Uint8Array(i),r=t.subarray(this.position,this.position+e);return n.set(r,0),this.position+=e,i}ReadBoolean8(){let e=this.dataView.getInt8(this.position);return this.position=this.position+1,!!e}ReadCharacter8(){let e=this.dataView.getInt8(this.position);return this.position=this.position+1,e}ReadUnsignedCharacter8(){let e=this.dataView.getUint8(this.position);return this.position=this.position+1,e}ReadInteger16(){let e=this.dataView.getInt16(this.position,this.isLittleEndian);return this.position=this.position+2,e}ReadUnsignedInteger16(){let e=this.dataView.getUint16(this.position,this.isLittleEndian);return this.position=this.position+2,e}ReadInteger32(){let e=this.dataView.getInt32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadUnsignedInteger32(){let e=this.dataView.getUint32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadFloat32(){let e=this.dataView.getFloat32(this.position,this.isLittleEndian);return this.position=this.position+4,e}ReadDouble64(){let e=this.dataView.getFloat64(this.position,this.isLittleEndian);return this.position=this.position+8,e}}class je extends Pe{constructor(){super()}CanImportExtension(e){return"stl"===e}GetUpDirection(){return 3}ClearContent(){this.mesh=null,this.triangle=null}ResetContent(){this.mesh=new $,this.model.AddMeshToRootNode(this.mesh),this.triangle=null}ImportContent(e,t){this.IsBinaryStlFile(e)?this.ProcessBinary(e):He(Te(e),(e=>{this.WasError()||this.ProcessLine(e)})),t()}IsBinaryStlFile(e){let t=e.byteLength;if(t<84)return!1;let i=new We(e,!0);return i.Skip(80),t===50*i.ReadUnsignedInteger32()+84}ProcessLine(e){if("#"===e[0])return;let t=ke(e,"#");if(0===t.length)return;let i=t[0];if("solid"!==i){if("facet"!==i){if("vertex"!==i||null===this.triangle)return"endfacet"===i&&null!==this.triangle?(-1!==this.triangle.v0&&-1!==this.triangle.v1&&null!==this.triangle.v2&&this.mesh.AddTriangle(this.triangle),void(this.triangle=null)):void 0;if(t.length>=4){let e=this.mesh.AddVertex(new o(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])));-1===this.triangle.v0?this.triangle.v0=e:-1===this.triangle.v1?this.triangle.v1=e:-1===this.triangle.v2&&(this.triangle.v2=e)}}else if(this.triangle=new Be(-1,-1,-1),t.length>=5&&"normal"===t[1]){let e=new o(parseFloat(t[2]),parseFloat(t[3]),parseFloat(t[4]));if(r(e.Length())){let t=this.mesh.AddNormal(e);this.triangle.SetNormals(t,t,t)}}}else if(t.length>1){let t=Ne(e,i.length,"#");this.mesh.SetName(t)}}ProcessBinary(e){function t(e){let t=new o;return t.x=e.ReadFloat32(),t.y=e.ReadFloat32(),t.z=e.ReadFloat32(),t}function i(e,i){let n=t(i);return e.AddVertex(n)}let n=new We(e,!0);n.Skip(80);let s=n.ReadUnsignedInteger32();for(let e=0;e<s;e++){let e=t(n),s=i(this.mesh,n),o=i(this.mesh,n),l=i(this.mesh,n);n.Skip(2);let a=new Be(s,o,l);if(r(e.Length())){let t=this.mesh.AddNormal(e);a.SetNormals(t,t,t)}this.mesh.AddTriangle(a)}}}class Ke extends Pe{constructor(){super()}CanImportExtension(e){return"off"===e}GetUpDirection(){return 2}ClearContent(){this.mesh=null,this.status=null}ResetContent(){this.mesh=new $,this.model.AddMeshToRootNode(this.mesh),this.status={vertexCount:0,faceCount:0,foundVertex:0,foundFace:0}}ImportContent(e,t){He(Te(e),(e=>{this.WasError()||this.ProcessLine(e)})),t()}ProcessLine(e){if("#"===e[0])return;let t=ke(e,"#");if(0!==t.length&&"OFF"!==t[0])if(0!==this.status.vertexCount||0!==this.status.faceCount){if(this.status.foundVertex<this.status.vertexCount)t.length>=3&&(this.mesh.AddVertex(new o(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),this.status.foundVertex+=1);else if(this.status.foundFace<this.status.faceCount&&t.length>=4){let e=parseInt(t[0],10);if(t.length<e+1)return;for(let i=0;i<e-2;i++){let e=parseInt(t[1]),n=parseInt(t[i+2]),r=parseInt(t[i+3]),s=new Be(e,n,r);this.mesh.AddTriangle(s)}this.status.foundFace+=1}}else t.length>1&&(this.status.vertexCount=parseInt(t[0],10),this.status.faceCount=parseInt(t[1],10))}}class qe{constructor(){this.format=null,this.elements=[]}SetFormat(e){this.format=e}AddElement(e,t){this.elements.push({name:e,count:t,format:[]})}GetElements(){return this.elements}AddSingleFormat(e,t){this.elements[this.elements.length-1].format.push({name:t,isSingle:!0,elemType:e})}AddListFormat(e,t,i){this.elements[this.elements.length-1].format.push({name:i,isSingle:!1,countType:e,elemType:t})}GetElement(e){for(let t=0;t<this.elements.length;t++){let i=this.elements[t];if(i.name===e)return i}return null}Check(){let e=this.GetElement("vertex");if(null===e||0===e.length||e.format.length<3)return 2;let t=this.GetElement("face");if("ascii"===this.format){if(null===t||0===t.count||t.format.length<0)return 3}else{if("binary_little_endian"!==this.format&&"binary_big_endian"!==this.format)return 4;{let e=this.GetElement("tristrips"),i=null!==t&&t.count>0&&t.format.length>0,n=null!==e&&e.count>0&&e.format.length>0;if(!i&&!n)return 3}}return 1}}class Je{constructor(e){this.model=e,this.vertexColors=[],this.colorToMaterial={}}AddVertexColor(e){this.vertexColors.push(e)}GetTriangleColor(e,t,i){let n=this.vertexColors.length;return e>=n||t>=n||i>=n?null:this.vertexColors[e]}GetTriangleFaceMaterialIndex(e){return this.GetMaterialIndexByColor(e)}GetTriangleVertexMaterialIndex(e,t,i){let n=this.GetTriangleColor(e,t,i);return null===n?null:this.GetMaterialIndexByColor(n)}GetMaterialIndexByColor(e){let t="Color "+b(e[0])+b(e[1])+b(e[2])+b(e[3]),i=this.colorToMaterial[t];if(void 0===i){let n=new v(1);n.name=t,n.color=new g(e[0],e[1],e[2]),n.opacity=e[3]/255,Ue(n),i=this.model.AddMaterial(n),this.colorToMaterial[t]=i}return i}}class Xe extends Pe{constructor(){super()}CanImportExtension(e){return"ply"===e}GetUpDirection(){return 2}ClearContent(){this.mesh=null}ResetContent(){this.mesh=new $,this.model.AddMeshToRootNode(this.mesh)}ImportContent(e,t){let i=this.GetHeaderContent(e),n=this.ReadHeader(i),r=n.Check();if(1===r)if("ascii"===n.format){let t=Te(e);t=t.substr(i.length),this.ReadAsciiContent(n,t)}else"binary_little_endian"!==n.format&&"binary_big_endian"!==n.format||this.ReadBinaryContent(n,e,i.length);else 2===r?this.SetError("The model contains no vertices."):3===r?this.SetError("The model contains no faces."):this.SetError("Invalid header information.");t()}GetHeaderContent(e){let t="",i=new Uint8Array(e),n=0;for(n=0;n<e.byteLength&&(t+=String.fromCharCode(i[n]),!t.endsWith("end_header"));n++);for(n+=1;n<e.byteLength;){let e=String.fromCharCode(i[n]);if(t+=e,n+=1,"\n"===e)break}return t}ReadHeader(e){let t=new qe;return He(e,(e=>{let i=ke(e,null);0!==i.length&&"comment"!==i[0]&&"ply"!==i[0]&&("format"===i[0]&&i.length>=2?t.SetFormat(i[1]):"element"===i[0]&&i.length>=3?t.AddElement(i[1],parseInt(i[2],10)):"property"===i[0]&&i.length>=3&&("list"===i[1]&&i.length>=5?t.AddListFormat(i[2],i[3],i[4]):t.AddSingleFormat(i[1],i[2])))})),t}ReadAsciiContent(e,t){let i=e.GetElement("vertex"),n=e.GetElement("face"),r=0,s=0;He(t,(e=>{if(this.WasError())return;let t=ke(e,null);if(0!==t.length&&"comment"!==t[0])if(r<i.count)t.length>=3&&(this.mesh.AddVertex(new o(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]))),r+=1);else if(s<n.count&&t.length>=4){let e=parseInt(t[0],10);if(t.length<e+1)return;for(let i=0;i<e-2;i++){let e=parseInt(t[1]),n=parseInt(t[i+2]),r=parseInt(t[i+3]),s=new Be(e,n,r);this.mesh.AddTriangle(s)}s+=1}}))}ReadBinaryContent(e,t,i){function n(e,t){function i(e,t){return"char"===t||"int8"===t?e.ReadCharacter8():"uchar"===t||"uint8"===t?e.ReadUnsignedCharacter8():"short"===t||"int16"===t?e.ReadInteger16():"ushort"===t||"uint16"===t?e.ReadUnsignedInteger16():"int"===t||"int32"===t?e.ReadInteger32():"uint"===t||"uint32"===t?e.ReadUnsignedInteger32():"float"===t||"float32"===t?e.ReadFloat32():"double"===t||"double64"===t?e.ReadDouble64():null}if(t.isSingle)return i(e,t.elemType);{let n=[],r=i(e,t.countType);for(let s=0;s<r;s++)n.push(i(e,t.elemType));return n}}function r(e,t,i){for(let r=i;r<t.length;r++)n(e,t[r])}function s(e,t,i){let r=null,s=null,o=null,l=255;for(let a=i;a<t.length;a++){let i=t[a],h=n(e,i);"red"===i.name?r=h:"green"===i.name?s=h:"blue"===i.name?o=h:"alpha"===i.name&&(l=h)}return null!==r&&null!==s&&null!==o?[r,s,o,l]:null}let l=null;if("binary_little_endian"===e.format)l=new We(t,!0);else{if("binary_big_endian"!==e.format)return;l=new We(t,!1)}l.Skip(i);let a=new Je(this.model),h=e.GetElements();for(let e=0;e<h.length;e++){let t=h[e];if("vertex"===t.name)for(let e=0;e<t.count;e++){let e=n(l,t.format[0]),i=n(l,t.format[1]),r=n(l,t.format[2]),h=s(l,t.format,3);null!==h&&a.AddVertexColor(h),this.mesh.AddVertex(new o(e,i,r))}else if("face"===t.name)for(let e=0;e<t.count;e++){let e=n(l,t.format[0]),i=s(l,t.format,1);for(let t=0;t<e.length-2;t++){let n=e[0],r=e[t+1],s=e[t+2],o=new Be(n,r,s);o.mat=null!==i?a.GetTriangleFaceMaterialIndex(i):a.GetTriangleVertexMaterialIndex(n,r,s),this.mesh.AddTriangle(o)}}else if("tristrips"===t.name)for(let e=0;e<t.count;e++){let e=n(l,t.format[0]);r(l,t.format,1);let i=!0;for(let t=0;t<e.length-2;t++){let n=e[t],r=e[t+1],s=e[t+2];if(-1===s){t+=2,i=!0;continue}if(!i){let e=r;r=s,s=e}i=!i;let o=new Be(n,r,s);this.mesh.AddTriangle(o)}}else r(l,t.format,0)}}}let $e=45089;class Ye{constructor(){this.id=-1,this.name="",this.flags=-1,this.parentId=-1,this.instanceName="",this.pivot=[0,0,0],this.positions=[],this.rotations=[],this.scales=[]}}class Ze{constructor(){this.nodes=[],this.nodeIdToNode=new Map}IsEmpty(){return 0===this.nodes.length}AddNode(e){this.nodes.push(e),this.nodeIdToNode.set(e.nodeId,e)}GetNodes(){return this.nodes}}class Qe extends Pe{constructor(){super()}CanImportExtension(e){return"3ds"===e}GetUpDirection(){return 3}ClearContent(){this.materialNameToIndex=null,this.meshNameToIndex=null,this.nodeList=null}ResetContent(){this.materialNameToIndex=new Map,this.meshNameToIndex=new Map,this.nodeList=new Ze}ImportContent(e,t){this.ProcessBinary(e),t()}ProcessBinary(e){let t=new We(e,!0),i=t.GetByteLength();this.ReadChunks(t,i,((e,i)=>{19789===e?this.ReadMainChunk(t,i):this.SkipChunk(t,i)}))}ReadMainChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,((t,i)=>{15677===t?this.ReadEditorChunk(e,i):45056===t?this.ReadKeyFrameChunk(e,i):this.SkipChunk(e,i)})),this.BuildNodeHierarchy()}ReadEditorChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,((t,i)=>{45055===t?this.ReadMaterialChunk(e,i):16384===t?this.ReadObjectChunk(e,i):this.SkipChunk(e,i)}))}ReadMaterialChunk(e,t){let i=new v(1),n=this.GetChunkEnd(e,t),r=null,s=null;this.ReadChunks(e,n,((t,n)=>{40960===t?i.name=this.ReadName(e):40976===t?i.ambient=this.ReadColorChunk(e,n):40992===t?i.color=this.ReadColorChunk(e,n):41008===t?i.specular=this.ReadColorChunk(e,n):41024===t?r=this.ReadPercentageChunk(e,n):41025===t?s=this.ReadPercentageChunk(e,n):41040===t?(i.opacity=1-this.ReadPercentageChunk(e,n),Ue(i)):41472===t?(i.diffuseMap=this.ReadTextureMapChunk(e,n),Ue(i)):this.SkipChunk(e,n)})),null!==r&&null!==s&&(i.shininess=r*s/10);let o=this.model.AddMaterial(i);this.materialNameToIndex.set(i.name,o)}ReadTextureMapChunk(e,t){let i=new x,n=this.GetChunkEnd(e,t);return this.ReadChunks(e,n,((t,n)=>{if(41728===t){let t=this.ReadName(e),n=this.callbacks.getTextureBuffer(t);i.name=t,null!==n&&(i.url=n.url,i.buffer=n.buffer)}else 41816===t?i.offset.x=e.ReadFloat32():41818===t?i.offset.y=e.ReadFloat32():41812===t?i.scale.x=e.ReadFloat32():41814===t?i.scale.y=e.ReadFloat32():41820===t?i.rotation=.017453292519943*e.ReadFloat32():this.SkipChunk(e,n)})),i}ReadColorChunk(e,t){let i=new g(0,0,0),n=this.GetChunkEnd(e,t),r=!1;return this.ReadChunks(e,n,((t,n)=>{17===t?r||(i.r=e.ReadUnsignedCharacter8(),i.g=e.ReadUnsignedCharacter8(),i.b=e.ReadUnsignedCharacter8()):18===t?(i.r=e.ReadUnsignedCharacter8(),i.g=e.ReadUnsignedCharacter8(),i.b=e.ReadUnsignedCharacter8(),r=!0):16===t?r||(i.r=parseInt(255*e.ReadFloat32(),10),i.g=parseInt(255*e.ReadFloat32(),10),i.b=parseInt(255*e.ReadFloat32(),10)):19===t?(i.r=parseInt(255*e.ReadFloat32(),10),i.g=parseInt(255*e.ReadFloat32(),10),i.b=parseInt(255*e.ReadFloat32(),10),r=!0):this.SkipChunk(e,n)})),i}ReadPercentageChunk(e,t){let i=0,n=this.GetChunkEnd(e,t);return this.ReadChunks(e,n,((t,n)=>{48===t?i=e.ReadUnsignedInteger16()/100:49===t?i=e.ReadFloat32():this.SkipChunk(e,n)})),i}ReadObjectChunk(e,t){let i=this.GetChunkEnd(e,t),n=this.ReadName(e);this.ReadChunks(e,i,((t,i)=>{16640===t?this.ReadMeshChunk(e,i,n):this.SkipChunk(e,i)}))}ReadMeshChunk(e,t,i){let n=new $;n.SetName(i);let r=this.GetChunkEnd(e,t),o=null;if(this.ReadChunks(e,r,((t,i)=>{16656===t?this.ReadVerticesChunk(n,e):16704===t?this.ReadTextureVerticesChunk(n,e):16672===t?this.ReadFacesChunk(n,e,i):16736===t?o=this.ReadTransformationChunk(e):this.SkipChunk(e,i)})),n.VertexCount()===n.TextureUVCount())for(let e=0;e<n.TriangleCount();e++){let t=n.GetTriangle(e);t.SetTextureUVs(t.v0,t.v1,t.v2)}let l=new Matrix(o);!function(e,t){if(!t.IsValid())return;let i=s(t.Determinant());i&&(t=(new Matrix).CreateScale(-1,1,1).MultiplyMatrix(t));let n=t.Invert();null!==n&&(le(e,new J(n)),i&&function(e){for(let t=0;t<e.TriangleCount();t++){let i=e.GetTriangle(t),n=i.v1;i.v1=i.v2,i.v2=n}}(e))}(n,l);let a=this.model.AddMesh(n);this.meshNameToIndex.set(n.GetName(),a)}ReadVerticesChunk(e,t){let i=t.ReadUnsignedInteger16();for(let n=0;n<i;n++){let i=t.ReadFloat32(),n=t.ReadFloat32(),r=t.ReadFloat32();e.AddVertex(new o(i,n,r))}}ReadTextureVerticesChunk(e,t){let i=t.ReadUnsignedInteger16();for(let n=0;n<i;n++){let i=t.ReadFloat32(),n=t.ReadFloat32();e.AddTextureUV(new c(i,n))}}ReadFacesChunk(e,t,i){let n=this.GetChunkEnd(t,i),r=t.ReadUnsignedInteger16();for(let i=0;i<r;i++){let i=t.ReadUnsignedInteger16(),n=t.ReadUnsignedInteger16(),r=t.ReadUnsignedInteger16();t.ReadUnsignedInteger16(),e.AddTriangle(new Be(i,n,r))}this.ReadChunks(t,n,((i,n)=>{16688===i?this.ReadFaceMaterialsChunk(e,t):16720===i?this.ReadFaceSmoothingGroupsChunk(e,r,t):this.SkipChunk(t,n)}))}ReadFaceMaterialsChunk(e,t){let i=this.ReadName(t),n=this.materialNameToIndex.get(i),r=t.ReadUnsignedInteger16();for(let i=0;i<r;i++){let i=t.ReadUnsignedInteger16(),r=e.GetTriangle(i);void 0!==n&&(r.mat=n)}}ReadFaceSmoothingGroupsChunk(e,t,i){for(let n=0;n<t;n++){let t=i.ReadUnsignedInteger32();e.GetTriangle(n).curve=t}}ReadTransformationChunk(e){let t=[];for(let i=0;i<4;i++){for(let i=0;i<3;i++)t.push(e.ReadFloat32());i<3?t.push(0):t.push(1)}return t}ReadKeyFrameChunk(e,t){let i=this.GetChunkEnd(e,t);this.ReadChunks(e,i,((t,i)=>{45058===t?this.ReadObjectNodeChunk(e,i):this.SkipChunk(e,i)}))}BuildNodeHierarchy(){function e(e,t){let i=new Matrix;if(i.ComposeTRS(m(function(e){return 0===e.positions.length?[0,0,0]:e.positions[0]}(e)),K(function(e){return 0===e.rotations.length?[0,0,0,1]:function(e){let t=[0,0,0,1],i=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);if(i>0){let n=-.5*e[3],r=Math.sin(n)/i;t=[r*e[0],r*e[1],r*e[2],Math.cos(n)]}return t}(e.rotations[0])}(e)),m(function(e){return 0===e.scales.length?[1,1,1]:e.scales[0]}(e))),t){let t=e.pivot;i=(new Matrix).CreateTranslation(-t[0],-t[1],-t[2]).MultiplyMatrix(i)}return new J(i)}let t=this.model.GetRootNode();if(this.nodeList.IsEmpty())for(let e=0;e<this.model.MeshCount();e++)t.AddMeshIndex(e);else{let i=new Map;for(let n of this.nodeList.GetNodes()){let r=new _e;n.name.length>0&&"$$$DUMMY"!==n.name&&(r.SetName(n.name),n.instanceName.length>0&&r.SetName(r.GetName()+" "+n.instanceName)),65535!==n.parentId&&i.has(n.parentId)?i.get(n.parentId).AddChildNode(r):t.AddChildNode(r),i.set(n.id,r);let s=this.meshNameToIndex.has(n.name);r.SetTransformation(e(n,s)),s&&(r.SetType(NodeType.MeshNode),r.AddMeshIndex(this.meshNameToIndex.get(n.name)))}}}ReadObjectNodeChunk(e,t){function i(e,t,i){let n=[];t.Skip(10);let r=t.ReadInteger32();for(let s=0;s<r;s++){t.ReadInteger32(),0!==t.ReadUnsignedInteger16()&&t.ReadFloat32();let r=null;if(i===$e){let i=t.ReadFloat32();r=e.ReadVector(t),r[3]=i}else r=e.ReadVector(t);n.push(r)}return n}let n=new Ye,r=this.GetChunkEnd(e,t);this.ReadChunks(e,r,((t,r)=>{45072===t?(n.name=this.ReadName(e),n.flags=e.ReadUnsignedInteger32(),n.parentId=e.ReadUnsignedInteger16()):45073===t?n.instanceName=this.ReadName(e):45075===t?n.pivot=this.ReadVector(e):45088===t?n.positions=i(this,e,45088):t===$e?n.rotations=i(this,e,$e):45090===t?n.scales=i(this,e,45090):45104===t?n.id=e.ReadUnsignedInteger16():this.SkipChunk(e,r)})),this.nodeList.AddNode(n)}ReadName(e){let t="",i=0,n=0;for(;n<64&&(i=e.ReadCharacter8(),0!==i);)t+=String.fromCharCode(i),n+=1;return t}ReadVector(e){return[e.ReadFloat32(),e.ReadFloat32(),e.ReadFloat32()]}ReadChunks(e,t,i){for(;e.GetPosition()<=t-6;)i(e.ReadUnsignedInteger16(),e.ReadUnsignedInteger32())}GetChunkEnd(e,t){return e.GetPosition()+t-6}SkipChunk(e,t){e.Skip(t-6)}}function et(e){return new Promise(((e,t)=>{t()}))}class tt{constructor(e){this.reader=new We(e,!0),this.componentType=null,this.dataType=null,this.byteStride=null,this.dataCount=null,this.sparseReader=null}SetComponentType(e){this.componentType=e}SetDataType(e){"SCALAR"===e?this.dataType=0:"VEC2"===e?this.dataType=1:"VEC3"===e?this.dataType=2:"VEC4"===e?this.dataType=3:"MAT2"===e?this.dataType=4:"MAT3"===e?this.dataType=5:"MAT4"===e&&(this.dataType=6)}SetByteStride(e){this.byteStride=e}SetDataCount(e){this.dataCount=e}SetSparseReader(e,t){this.sparseReader={indexReader:e,valueReader:t}}ReadArrayBuffer(e){return this.reader.ReadArrayBuffer(e)}GetDataCount(){return this.dataCount}ReadData(){if(null===this.dataType)return null;if(0===this.dataType){let e=this.ReadComponent();return this.SkipBytesByStride(1),e}if(1===this.dataType){let e=this.ReadComponent(),t=this.ReadComponent();return this.SkipBytesByStride(2),new c(e,t)}if(2===this.dataType){let e=this.ReadComponent(),t=this.ReadComponent(),i=this.ReadComponent();return this.SkipBytesByStride(3),new o(e,t,i)}return null}EnumerateData(e){if(null===this.sparseReader)for(let t=0;t<this.dataCount;t++)e(this.ReadData());else{let t=[];for(let e=0;e<this.sparseReader.indexReader.GetDataCount();e++){let e=this.sparseReader.indexReader.ReadData(),i=this.sparseReader.valueReader.ReadData();t.push({index:e,value:i})}let i=0;for(let n=0;n<this.dataCount;n++){let r=this.ReadData();i<t.length&&t[i].index===n?(e(t[i].value),i+=1):e(r)}}}SkipBytes(e){this.reader.Skip(e)}ReadComponent(){return null===this.componentType?null:5120===this.componentType?this.reader.ReadCharacter8():5121===this.componentType?this.reader.ReadUnsignedCharacter8():5122===this.componentType?this.reader.ReadInteger16():5123===this.componentType?this.reader.ReadUnsignedInteger16():5125===this.componentType?this.reader.ReadInteger32():5126===this.componentType?this.reader.ReadFloat32():null}SkipBytesByStride(e){if(null===this.byteStride)return;let t=e*this.GetComponentSize();this.reader.Skip(this.byteStride-t)}GetComponentSize(){return 5120===this.componentType||5121===this.componentType?1:5122===this.componentType||5123===this.componentType?2:5125===this.componentType||5126===this.componentType?4:0}}class it{constructor(){this.supportedExtensions=["KHR_draco_mesh_compression","KHR_materials_pbrSpecularGlossiness","KHR_texture_transform"],this.draco=null}LoadLibraries(e,t){void 0!==e&&null===this.draco&&-1!==e.indexOf("KHR_draco_mesh_compression")?et().then((()=>{DracoDecoderModule().then((e=>{this.draco=e,t.onSuccess()}))})).catch((()=>{t.onError()})):t.onSuccess()}GetUnsupportedExtensions(e){let t=[];if(void 0===e)return t;for(let i=0;i<e.length;i++){let n=e[i];-1===this.supportedExtensions.indexOf(n)&&t.push(n)}return t}ProcessMaterial(e,t,i){function n(e){return parseInt(Math.round(255*y(e)),10)}if(void 0===e.extensions)return;let r=e.extensions.KHR_materials_pbrSpecularGlossiness;if(void 0!==r){t.type=1;let e=r.diffuseFactor;void 0!==e&&(t.color=new g(n(e[0]),n(e[1]),n(e[2])),t.opacity=e[3]);let s=r.diffuseTexture;void 0!==s&&(t.diffuseMap=i(s));let o=r.specularFactor;void 0!==o&&(t.specular=new g(n(o[0]),n(o[1]),n(o[2])));let l=r.specularGlossinessTexture;void 0!==l&&(t.specularMap=i(l));let a=r.glossinessFactor;void 0!==a&&(t.shininess=a)}}ProcessTexture(e,t){if(void 0===e.extensions)return;let i=e.extensions.KHR_texture_transform;void 0!==i&&(void 0!==i.offset&&(t.offset.x=i.offset[0],t.offset.y=-i.offset[1]),void 0!==i.scale&&(t.scale.x=i.scale[0],t.scale.y=i.scale[1]),void 0!==i.rotation&&(t.rotation=-i.rotation))}ProcessPrimitive(e,t,i,n){function r(e,t,i,n,r){let s=t.GetAttributeByUniqueId(i,n),l=s.num_components(),a=i.num_points()*l,h=4*a,d=e._malloc(h);t.GetAttributeDataArrayForAllPoints(i,s,e.DT_FLOAT32,h,d);let u=new Float32Array(e.HEAPF32.buffer,d,a).slice();if(2===l)for(let e=0;e<u.length;e+=2)r(new c(u[e+0],u[e+1]));else if(3===l)for(let e=0;e<u.length;e+=3)r(new o(u[e+0],u[e+1],u[e+2]));e._free(d)}if(null===this.draco)return!1;if(void 0===i.extensions||void 0===i.extensions.KHR_draco_mesh_compression)return!1;let s=new this.draco.Decoder,l=new this.draco.DecoderBuffer,a=i.extensions.KHR_draco_mesh_compression,h=t.bufferViews[a.bufferView],d=e.GetReaderFromBufferView(h).ReadArrayBuffer(h.byteLength);if(l.Init(new Int8Array(d),d.byteLength),s.GetEncodedGeometryType(l)!==this.draco.TRIANGULAR_MESH)return!0;let u=new this.draco.Mesh;if(!s.DecodeBufferToMesh(l,u).ok())return!0;let m=void 0!==a.attributes.POSITION,p=void 0!==a.attributes.NORMAL,f=void 0!==a.attributes.TEXCOORD_0;if(!m)return!0;let g=n.VertexCount(),x=n.NormalCount(),v=n.TextureUVCount();r(this.draco,s,u,a.attributes.POSITION,(e=>{n.AddVertex(e)})),p&&r(this.draco,s,u,a.attributes.NORMAL,(e=>{n.AddNormal(e)})),f&&r(this.draco,s,u,a.attributes.TEXCOORD_0,(e=>{e.y=-e.y,n.AddTextureUV(e)}));let C=3*u.num_faces(),y=4*C,b=this.draco._malloc(y);s.GetTrianglesUInt32Array(u,y,b);let w=new Uint32Array(this.draco.HEAPU32.buffer,b,C).slice();for(let t=0;t<w.length;t+=3){let r=w[t],s=w[t+1],o=w[t+2];e.AddTriangle(i,n,r,s,o,p,f,g,x,v)}return this.draco._free(b),!0}}class nt extends Pe{constructor(){super(),this.gltfExtensions=new it}CanImportExtension(e){return"gltf"===e||"glb"===e}GetUpDirection(){return 2}ClearContent(){this.bufferContents=null,this.imageIndexToTextureParams=null}ResetContent(){this.bufferContents=[],this.imageIndexToTextureParams={}}ImportContent(e,t){"gltf"===this.extension?this.ProcessGltf(e,t):"glb"===this.extension&&this.ProcessBinaryGltf(e,t)}ProcessGltf(e,t){let i=Te(e),n=JSON.parse(i);if("2.0"!==n.asset.version)return this.SetError("Invalid glTF version."),void t();for(let e=0;e<n.buffers.length;e++){let i=null,r=n.buffers[e],s=Ae(r.uri);if(null!==s)i=s.buffer;else{let e=this.callbacks.getFileBuffer(r.uri);null!==e&&(i=e)}if(null===i)return this.SetError("One  of the requested buffers is missing."),void t();this.bufferContents.push(i)}this.ProcessMainFile(n,t)}ProcessBinaryGltf(e,t){function i(e){let t=e.ReadUnsignedInteger32();return{type:e.ReadUnsignedInteger32(),buffer:e.ReadArrayBuffer(t)}}let n=new We(e,!0);if(1179937895!==n.ReadUnsignedInteger32())return this.SetError("Invalid glTF file."),void t();if(2!==n.ReadUnsignedInteger32())return this.SetError("Invalid glTF version."),void t();if(n.ReadUnsignedInteger32()!==n.GetByteLength())return this.SetError("Invalid glTF file."),void t();let r=null;for(;!n.End();){let e=i(n);1313821514===e.type?r=Te(e.buffer):5130562===e.type&&this.bufferContents.push(e.buffer)}if(null!==r){let e=JSON.parse(r);this.ProcessMainFile(e,t)}}ProcessMainFile(e,t){let i=this.gltfExtensions.GetUnsupportedExtensions(e.extensionsRequired);if(i.length>0)return this.SetError("Unsupported extension: "+i.join(", ")+"."),void t();this.gltfExtensions.LoadLibraries(e.extensionsRequired,{onSuccess:()=>{this.ImportModel(e),t()},onError:()=>{this.SetError("Failed to load draco decoder."),t()}})}ImportModel(e){let t=e.materials;if(void 0!==t)for(let i of t)this.ImportMaterial(e,i);let i=e.meshes;if(void 0!==i)for(let t of i)this.ImportMesh(e,t);this.ImportNodes(e),this.ImportModelProperties(e)}ImportModelProperties(e){function t(e,t,i){let n=new pe(t);for(let e in i)if(Object.prototype.hasOwnProperty.call(i,e)&&"string"==typeof i[e]){const t=new ce(1,e,i[e]);n.AddProperty(t)}return n.PropertyCount()>0&&e.AddPropertyGroup(n),n}t(this.model,"Asset properties",e.asset),e.asset.extras&&t(this.model,"Extras",e.asset.extras)}GetDefaultScene(e){let t=e.scene||0;return t>=e.scenes.length?null:e.scenes[t]}ImportMaterial(e,t){function i(e){return parseInt(Math.round(255*y(e)),10)}let n=new v(2);if(void 0!==t.name&&(n.name=t.name),n.color=new g(i(1),i(1),i(1)),void 0!==t.pbrMetallicRoughness){let r=t.pbrMetallicRoughness.baseColorFactor;void 0!==r&&(n.color=new g(i(r[0]),i(r[1]),i(r[2])),n.opacity=r[3]);let s=t.pbrMetallicRoughness.metallicFactor;void 0!==s&&(n.metalness=s);let o=t.pbrMetallicRoughness.roughnessFactor;void 0!==o&&(n.roughness=o);let l=t.emissiveFactor;void 0!==l&&(n.emissive=new g(i(l[0]),i(l[1]),i(l[2]))),n.diffuseMap=this.ImportTexture(e,t.pbrMetallicRoughness.baseColorTexture),n.metalnessMap=this.ImportTexture(e,t.pbrMetallicRoughness.metallicRoughnessTexture),n.normalMap=this.ImportTexture(e,t.normalTexture),n.emissiveMap=this.ImportTexture(e,t.emissiveTexture),null!==n.diffuseMap&&(n.multiplyDiffuseMap=!0);let a=t.alphaMode;void 0!==a&&("BLEND"===a?n.transparent=!0:"MASK"===a&&(n.transparent=!0,n.alphaTest=t.alphaCutoff||.5))}this.gltfExtensions.ProcessMaterial(t,n,(t=>this.ImportTexture(e,t))),this.model.AddMaterial(n)}ImportTexture(e,t){if(null==t)return null;let i=new x,n=e.textures[t.index].source,r=e.images[n],s=this.imageIndexToTextureParams[n];if(void 0===s){s={name:null,url:null,buffer:null};let t=n.toString();if(void 0!==r.uri){let e=Ae(r.uri);if(null!==e)s.name="Embedded_"+t+"."+Ge(e.mimeType),s.url=Re(e.buffer,e.mimeType),s.buffer=e.buffer;else{let e=this.callbacks.getTextureBuffer(r.uri);s.name=r.uri,null!==e&&(s.url=e.url,s.buffer=e.buffer)}}else if(void 0!==r.bufferView){let i=e.bufferViews[r.bufferView],n=this.GetReaderFromBufferView(i);if(null!==n){let e=n.ReadArrayBuffer(i.byteLength);s.name="Binary_"+t+"."+Ge(r.mimeType),s.url=Re(e,r.mimeType),s.buffer=e}}this.imageIndexToTextureParams[n]=s}return i.name=s.name,i.url=s.url,i.buffer=s.buffer,this.gltfExtensions.ProcessTexture(t,i),i}ImportMesh(e,t){let i=new $;this.model.AddMesh(i),void 0!==t.name&&i.SetName(t.name);for(let n=0;n<t.primitives.length;n++){let r=t.primitives[n];this.ImportPrimitive(e,r,i)}}ImportPrimitive(e,t,i){if(this.gltfExtensions.ProcessPrimitive(this,e,t,i))return;if(void 0===t.attributes)return;let n=void 0!==t.attributes.POSITION,r=void 0!==t.attributes.NORMAL,s=void 0!==t.attributes.TEXCOORD_0,o=void 0!==t.indices,l=4;if(void 0!==t.mode&&(l=t.mode),4!==l&&5!==l&&6!==l)return;let a=i.VertexCount(),h=i.NormalCount(),d=i.TextureUVCount();if(!n)return;{let n=e.accessors[t.attributes.POSITION],r=this.GetReaderFromAccessor(e,n);if(null===r)return;r.EnumerateData((e=>{i.AddVertex(e)}))}if(r){let n=e.accessors[t.attributes.NORMAL],r=this.GetReaderFromAccessor(e,n);if(null===r)return;r.EnumerateData((e=>{i.AddNormal(e)}))}if(s){let n=e.accessors[t.attributes.TEXCOORD_0],r=this.GetReaderFromAccessor(e,n);if(null===r)return;r.EnumerateData((e=>{e.y=-e.y,i.AddTextureUV(e)}))}let u=[];if(o){let i=e.accessors[t.indices],n=this.GetReaderFromAccessor(e,i);if(null===n)return;n.EnumerateData((e=>{u.push(e)}))}else for(let e=0;e<i.VertexCount();e++)u.push(e);if(4===l)for(let e=0;e<u.length;e+=3){let n=u[e],o=u[e+1],l=u[e+2];this.AddTriangle(t,i,n,o,l,r,s,a,h,d)}else if(5===l)for(let e=0;e<u.length-2;e++){let n=u[e],o=u[e+1],l=u[e+2];if(e%2==1){let e=o;o=l,l=e}this.AddTriangle(t,i,n,o,l,r,s,a,h,d)}else if(6===l)for(let e=1;e<u.length-1;e++){let n=u[0],o=u[e],l=u[e+1];this.AddTriangle(t,i,n,o,l,r,s,a,h,d)}}AddTriangle(e,t,i,n,r,s,o,l,a,h){let d=new Be(l+i,l+n,l+r);s&&d.SetNormals(a+i,a+n,a+r),o&&d.SetTextureUVs(h+i,h+n,h+r),void 0!==e.material&&(d.mat=e.material),t.AddTriangle(d)}ImportNodes(e){let t=this.GetDefaultScene(e);if(null===t)return;let i=this.model.GetRootNode();for(let n of t.nodes){let t=e.nodes[n];this.ImportNode(e,t,i)}}ImportNode(e,t,i){if(void 0===t.children&&void 0===t.mesh)return;let n=new _e;if(void 0!==t.name&&n.SetName(t.name),n.SetTransformation(function(e){let t=(new q).CreateIdentity();if(void 0!==e.matrix)t.Set(e.matrix);else{let i=[0,0,0],n=[0,0,0,1],r=[1,1,1];void 0!==e.translation&&(i=e.translation),void 0!==e.rotation&&(n=e.rotation),void 0!==e.scale&&(r=e.scale),t.ComposeTRS(m(i),K(n),m(r))}return new J(t)}(t)),i.AddChildNode(n),void 0!==t.children)for(let i of t.children){let t=e.nodes[i];this.ImportNode(e,t,n)}void 0!==t.mesh&&(void 0!==t.children&&0!==t.children.length||n.SetType(NodeType.MeshNode),n.AddMeshIndex(t.mesh))}GetReaderFromBufferView(e){let t=e.buffer||0,i=this.bufferContents[t];if(null==i)return null;let n=new tt(i);n.SkipBytes(e.byteOffset||0);let r=e.byteStride;return void 0!==r&&0!==r&&n.SetByteStride(r),n}GetReaderFromAccessor(e,t){let i=t.bufferView||0,n=e.bufferViews[i],r=this.GetReaderFromBufferView(n);if(null===r)return null;if(r.SetComponentType(t.componentType),r.SetDataType(t.type),r.SetDataCount(t.count),r.SkipBytes(t.byteOffset||0),void 0!==t.sparse){let i=this.GetReaderFromSparseAccessor(e,t.sparse.indices,t.sparse.indices.componentType,"SCALAR",t.sparse.count),n=this.GetReaderFromSparseAccessor(e,t.sparse.values,t.componentType,t.type,t.sparse.count);null!==i&&null!==n&&r.SetSparseReader(i,n)}return r}GetReaderFromSparseAccessor(e,t,i,n,r){if(void 0===t.bufferView)return null;let s=e.bufferViews[t.bufferView],o=this.GetReaderFromBufferView(s);return null===o?null:(o.SetComponentType(i),o.SetDataType(n),o.SetDataCount(r),o.SkipBytes(t.byteOffset||0),o)}}function rt(e,t){return null==e?t:e}class st{constructor(){this.name=null,this.material=null}SetName(e){return this.name=e,this}SetMaterial(e){return this.material=e,this}}class ot{constructor(e){this.params=e||new st,this.mesh=new $,null!==this.params.name&&this.mesh.SetName(this.params.name),this.curve=null}GetMesh(){return this.mesh}AddVertex(e,t,i){let n=new o(e,t,i);return this.mesh.AddVertex(n)}AddVertices(e){let t=[];for(let i=0;i<e.length;i++){let n=e[i];t.push(this.AddVertex(n.x,n.y,n.z))}return t}SetCurve(e){this.curve=e}ResetCurve(){this.curve=null}AddTriangle(e,t,i){let n=new Be(e,t,i);return null!==this.params.material&&n.SetMaterial(this.params.material),null!==this.curve&&n.SetCurve(this.curve),this.mesh.AddTriangle(n)}AddTriangleInverted(e,t,i){this.AddTriangle(e,i,t)}AddConvexPolygon(e){for(let t=0;t<e.length-2;t++)this.AddTriangle(e[0],e[t+1],e[t+2])}AddConvexPolygonInverted(e){for(let t=0;t<e.length-2;t++)this.AddTriangleInverted(e[0],e[t+1],e[t+2])}}class lt{constructor(e){this.generator=e}GenerateExtrude(e,t,i){let n=[],r=[];for(let i=0;i<e.length;i++){const s=e[i];r.push(this.generator.AddVertex(s.x,s.y,0)),n.push(this.generator.AddVertex(s.x,s.y,t))}this.generator.SetCurve(i),this.GenerateSurfaceBetweenPolygons(r,n),this.generator.ResetCurve(),this.generator.AddConvexPolygonInverted(r),this.generator.AddConvexPolygon(n)}GenerateSurfaceBetweenPolygons(e,t){if(e.length!==t.length)return;const i=e.length;for(let n=0;n<i;n++){const r=n,s=n<i-1?r+1:0;this.generator.AddConvexPolygon([e[r],e[s],t[s],t[r]])}}GenerateTriangleFan(e,t){const i=e.length;for(let n=0;n<i;n++){const r=n,s=n<i-1?r+1:0;this.generator.AddTriangle(t,e[r],e[s])}}}class at extends Pe{constructor(){super()}CanImportExtension(e){return"o3dv"===e}GetUpDirection(){return 3}ClearContent(){}ResetContent(){}ImportContent(e,t){let i=Te(e),n=JSON.parse(i);if(void 0===n.root)return void t();if(void 0!==n.materials)for(let e=0;e<n.materials.length;e++){const t=n.materials[e];this.ImportMaterial(t)}if(void 0!==n.meshes)for(let e=0;e<n.meshes.length;e++){const t=n.meshes[e];this.ImportMesh(t)}let r=n.nodes[n.root];this.ImportNode(n,r,this.model.GetRootNode()),this.ImportProperties(this.model,n),t()}ImportMaterial(e){let t=new v(2);var i;t.color.Set(255,255,255),void 0!==e.name&&(t.name=e.name),void 0!==e.color&&(t.color=(i=e.color,new g(i[0],i[1],i[2]))),t.metalness=rt(e.metalness,0),t.roughness=rt(e.roughness,1),this.model.AddMaterial(t)}ImportMesh(t){let i=new st;void 0!==t.name&&i.SetName(t.name),void 0!==t.material&&i.SetMaterial(t.material);let n=t.parameters;if(void 0===n)return;let r=null;if("cuboid"===t.type){if(void 0===n.size_x||void 0===n.size_y||void 0===n.size_z)return;r=function(e,t,i,n){let r=new ot(e),s=[new c(0,0),new c(t,0),new c(t,i),new c(0,i)];return new lt(r).GenerateExtrude(s,n,null),r.GetMesh()}(i,n.size_x,n.size_y,n.size_z)}else if("cylinder"===t.type){if(void 0===n.radius||void 0===n.height)return;let e=rt(n.segments,25),t=rt(n.smooth,!0);r=function(e,t,i,n,r){function s(e,t){return new c(e*Math.cos(t),e*Math.sin(t))}if(n<3)return null;let o=new ot(e),l=[];const a=2*Math.PI/n;for(let e=0;e<n;e++){let i=s(t,e*a);l.push(i)}return new lt(o).GenerateExtrude(l,i,r?1:null),o.GetMesh()}(i,n.radius,n.height,e,t)}else if("sphere"===t.type){if(void 0===n.radius)return;let e=rt(n.segments,20),t=rt(n.smooth,!0);r=function(e,t,i,n){function r(e,t,i){return new o(e*Math.sin(t)*Math.cos(i),e*Math.sin(t)*Math.sin(i),e*Math.cos(t))}if(i<3)return null;let s=new ot(e),l=new lt(s);s.SetCurve(n?1:null);let a=[],h=i+1;const d=Math.PI/i,u=2*Math.PI/i;for(let e=1;e<h-1;e++){let n=[],o=e*d;for(let e=0;e<i;e++){let i=r(t,o,-e*u);n.push(s.AddVertex(i.x,i.y,i.z))}e>1&&l.GenerateSurfaceBetweenPolygons(a[a.length-1],n),a.push(n)}let m=s.AddVertex(0,0,t),c=s.AddVertex(0,0,-t);return l.GenerateTriangleFan(a[0].slice().reverse(),m),l.GenerateTriangleFan(a[a.length-1],c),s.ResetCurve(),s.GetMesh()}(i,n.radius,e,t)}else if("platonic"===t.type){if(void 0===n.solid_type)return;let t=rt(n.radius,1);r=function(t,i,n){function r(e,t,i,n,r){let s=new o(i,n,r);s.MultiplyScalar(t/s.Length()),e.AddVertex(s.x,s.y,s.z)}if(s=n,Math.abs(s)<e)return null;var s;let l=new ot(t);if("tetrahedron"===i){let e=1;r(l,n,+e,+e,+e),r(l,n,-e,-e,+e),r(l,n,-e,+e,-e),r(l,n,+e,-e,-e),l.AddTriangle(0,1,3),l.AddTriangle(0,2,1),l.AddTriangle(0,3,2),l.AddTriangle(1,2,3)}else if("hexahedron"===i){let e=1;r(l,n,+e,+e,+e),r(l,n,+e,+e,-e),r(l,n,+e,-e,+e),r(l,n,+e,-e,-e),r(l,n,-e,+e,+e),r(l,n,-e,+e,-e),r(l,n,-e,-e,+e),r(l,n,-e,-e,-e),l.AddConvexPolygon([0,1,5,4]),l.AddConvexPolygon([0,2,3,1]),l.AddConvexPolygon([0,4,6,2]),l.AddConvexPolygon([1,3,7,5]),l.AddConvexPolygon([2,6,7,3]),l.AddConvexPolygon([4,5,7,6])}else if("octahedron"===i){let e=1,t=0;r(l,n,+e,+t,+t),r(l,n,-e,+t,+t),r(l,n,+t,+e,+t),r(l,n,+t,-e,+t),r(l,n,+t,+t,+e),r(l,n,+t,+t,-e),l.AddTriangle(0,2,4),l.AddTriangle(0,3,5),l.AddTriangle(0,4,3),l.AddTriangle(0,5,2),l.AddTriangle(1,2,5),l.AddTriangle(1,3,4),l.AddTriangle(1,4,2),l.AddTriangle(1,5,3)}else if("dodecahedron"===i){let e=1,t=0,i=(1+Math.sqrt(5))/2,s=1/i;r(l,n,+e,+e,+e),r(l,n,+e,+e,-e),r(l,n,+e,-e,+e),r(l,n,-e,+e,+e),r(l,n,+e,-e,-e),r(l,n,-e,+e,-e),r(l,n,-e,-e,+e),r(l,n,-e,-e,-e),r(l,n,+t,+s,+i),r(l,n,+t,+s,-i),r(l,n,+t,-s,+i),r(l,n,+t,-s,-i),r(l,n,+s,+i,+t),r(l,n,+s,-i,+t),r(l,n,-s,+i,+t),r(l,n,-s,-i,+t),r(l,n,+i,+t,+s),r(l,n,-i,+t,+s),r(l,n,+i,+t,-s),r(l,n,-i,+t,-s),l.AddConvexPolygon([0,8,10,2,16]),l.AddConvexPolygon([0,16,18,1,12]),l.AddConvexPolygon([0,12,14,3,8]),l.AddConvexPolygon([1,9,5,14,12]),l.AddConvexPolygon([1,18,4,11,9]),l.AddConvexPolygon([2,10,6,15,13]),l.AddConvexPolygon([2,13,4,18,16]),l.AddConvexPolygon([3,14,5,19,17]),l.AddConvexPolygon([3,17,6,10,8]),l.AddConvexPolygon([4,13,15,7,11]),l.AddConvexPolygon([5,9,11,7,19]),l.AddConvexPolygon([6,17,19,7,15])}else if("icosahedron"===i){let e=1,t=0,i=(1+Math.sqrt(5))/2;r(l,n,+t,+e,+i),r(l,n,+t,+e,-i),r(l,n,+t,-e,+i),r(l,n,+t,-e,-i),r(l,n,+e,+i,+t),r(l,n,+e,-i,+t),r(l,n,-e,+i,+t),r(l,n,-e,-i,+t),r(l,n,+i,+t,+e),r(l,n,+i,+t,-e),r(l,n,-i,+t,+e),r(l,n,-i,+t,-e),l.AddTriangle(0,2,8),l.AddTriangle(0,4,6),l.AddTriangle(0,6,10),l.AddTriangle(0,8,4),l.AddTriangle(0,10,2),l.AddTriangle(1,3,11),l.AddTriangle(1,4,9),l.AddTriangle(1,6,4),l.AddTriangle(1,9,3),l.AddTriangle(1,11,6),l.AddTriangle(2,5,8),l.AddTriangle(2,7,5),l.AddTriangle(2,10,7),l.AddTriangle(3,5,7),l.AddTriangle(3,7,11),l.AddTriangle(3,9,5),l.AddTriangle(4,8,9),l.AddTriangle(5,9,8),l.AddTriangle(6,11,10),l.AddTriangle(7,10,11)}return l.GetMesh()}(i,n.solid_type,t)}null!==r&&(this.ImportProperties(r,t),this.model.AddMesh(r))}ImportNode(e,t,i){if(void 0!==t.name&&i.SetName(t.name),void 0!==t.transformation){const e=this.GetTransformation(t.transformation);i.SetTransformation(e)}if(void 0!==t.children)for(const n of t.children){let t=e.nodes[n],r=new _e;i.AddChildNode(r),this.ImportNode(e,t,r)}void 0!==t.mesh&&(void 0!==t.children&&0!==t.children.length||i.SetType(1),i.AddMeshIndex(t.mesh))}ImportProperties(e,t){if(void 0!==t.properties){const i=new pe("Properties");e.AddPropertyGroup(i);for(const e of t.properties){const t=new ce(1,e.name,e.value);i.AddProperty(t)}}}GetTransformation(e){let t=new o(0,0,0),i=new j(0,0,0,1),n=new o(1,1,1);void 0!==e.translation&&(t=m(e.translation)),void 0!==e.rotation&&(i=K(e.rotation)),void 0!==e.scale&&(n=m(e.scale));const r=(new q).ComposeTRS(t,i,n);return new J(r)}}function ht(e,t){let i=new $,n=e.attributes.position.array;for(let e=0;e<n.length;e+=3){let t=n[e],r=n[e+1],s=n[e+2];i.AddVertex(new o(t,r,s))}let r=void 0!==e.attributes.normal;if(r){let t=e.attributes.normal.array;for(let e=0;e<t.length;e+=3){let n=t[e],r=t[e+1],s=t[e+2];i.AddNormal(new o(n,r,s))}}let s=void 0!==e.attributes.uv;if(s){let t=e.attributes.uv.array;for(let e=0;e<t.length;e+=2){let n=t[e],r=t[e+1];i.AddTextureUV(new c(n,r))}}let l=null;if(null!==e.index)l=e.index.array;else{l=[];for(let e=0;e<n.length/3;e++)l.push(e)}for(let e=0;e<l.length;e+=3){let n=l[e],o=l[e+1],a=l[e+2],h=new Triangle(n,o,a);r&&h.SetNormals(n,o,a),s&&h.SetTextureUVs(n,o,a),null!==t&&h.SetMaterial(t),i.AddTriangle(h)}return i}class dt extends Pe{constructor(){super(),this.rhino=null}CanImportExtension(e){return"3dm"===e}GetUpDirection(){return 3}ClearContent(){this.instanceObjects=null,this.instanceDefinitions=null}ResetContent(){this.instanceObjects={},this.instanceDefinitions={}}ImportContent(e,t){null===this.rhino?et().then((()=>{rhino3dm().then((i=>{this.rhino=i,this.ImportRhinoContent(e),t()}))})).catch((()=>{t()})):(this.ImportRhinoContent(e),t())}ImportRhinoContent(e){let t=this.rhino.File3dm.fromByteArray(e);null!==t?(this.ImportRhinoDocument(t),ae(this.model)&&this.SetError("The model doesn't contain any 3D meshes. Try to save the model while you are in shaded view in Rhino.")):this.SetError("Failed to read Rhino file.")}ImportRhinoDocument(e){this.InitRhinoInstances(e),this.ImportRhinoUserStrings(e),this.ImportRhinoGeometry(e)}InitRhinoInstances(e){let t=e.objects();for(let e=0;e<t.count;e++){let i=t.get(e),n=i.attributes();n.isInstanceDefinitionObject&&(this.instanceObjects[n.id]=i)}let i=e.instanceDefinitions();for(let e=0;e<i.count();e++){let t=i.get(e);this.instanceDefinitions[t.id]=t}}ImportRhinoUserStrings(e){let t=e.strings();if(t.count()>0){let e=new pe("Document user texts");for(let i=0;i<t.count();i++){let n=t.get(i);e.AddProperty(new ce(1,n[0],n[1]))}this.model.AddPropertyGroup(e)}}ImportRhinoGeometry(e){let t=e.objects();for(let i=0;i<t.count;i++){let n=t.get(i);this.ImportRhinoGeometryObject(e,n,[])}}ImportRhinoGeometryObject(e,t,i){let n=t.geometry(),r=t.attributes(),s=n.objectType;if(r.isInstanceDefinitionObject&&0===i.length)return;let o=null,l=!1;if(s===this.rhino.ObjectType.Mesh)o=n,l=!1;else if(s===this.rhino.ObjectType.Extrusion)o=n.getMesh(this.rhino.MeshType.Any),l=!0;else if(s===this.rhino.ObjectType.Brep){o=new this.rhino.Mesh;let e=n.faces();for(let t=0;t<e.count;t++){let i=e.get(t),n=i.getMesh(this.rhino.MeshType.Any);n&&(o.append(n),n.delete()),i.delete()}e.delete(),o.compact(),l=!0}else if(s===this.rhino.ObjectType.SubD)n.subdivide(3),o=this.rhino.Mesh.createFromSubDControlNet(n),l=!0;else if(s===this.rhino.ObjectType.InstanceReference){let r=n.parentIdefId,s=this.instanceDefinitions[r];if(void 0!==s){let n=s.getObjectIds();for(let r=0;r<n.length;r++){let s=n[r],o=this.instanceObjects[s];void 0!==o&&(i.push(t),this.ImportRhinoGeometryObject(e,o,i),i.pop())}}}null!==o&&(this.ImportRhinoMesh(e,o,t,i),l&&o.delete())}ImportRhinoMesh(e,t,i,n){let r=i.attributes(),s=this.GetMaterialIndex(e,i,n),o=ht(t.toThreejsJSON().data,s);o.SetName(r.name);let l=r.getUserStrings();if(l.length>0){let e=new pe("User texts");for(let t=0;t<l.length;t++){let i=l[t];e.AddProperty(new ce(1,i[0],i[1]))}o.AddPropertyGroup(e)}if(0!==n.length){let e=(new q).CreateIdentity();for(let t=n.length-1;t>=0;t--){let i=n[t].geometry().xform.toFloatArray(!1),r=new q(i);e=e.MultiplyMatrix(r)}le(o,new J(e))}this.model.AddMeshToRootNode(o)}GetMaterialIndex(e,t,i){let n=function t(i,n,r){let s=n.attributes();if(s.materialSource===i.ObjectMaterialSource.MaterialFromObject){let t=s.materialIndex;if(t>-1)return e.materials().get(t)}else if(s.materialSource===i.ObjectMaterialSource.MaterialFromLayer){let t=s.layerIndex;if(t>-1){let i=e.layers().get(t).renderMaterialIndex;if(i>-1)return e.materials().get(i)}}else if(s.materialSource===i.ObjectMaterialSource.MaterialFromParent&&0!==r.length)return t(i,r[0],[]);return null}(this.rhino,t,i);return function(e,t){function i(e,t){e.Set(t.r,t.g,t.b)}function n(e){return 0===e.r&&0===e.g&&0===e.b}function r(e){return 255===e.r&&255===e.g&&255===e.b}let s=null;if(null===t)s=new v(1),s.color.Set(255,255,255);else{let e=t.physicallyBased();e.supported?(s=new v(2),s.metalness=e.metallic?1:0,s.roughness=e.roughness):(s=new v(1),i(s.ambient,t.ambientColor),i(s.specular,t.specularColor)),s.name=t.name,i(s.color,t.diffuseColor),s.opacity=1-t.transparency,Ue(s),n(s.color)&&!r(t.reflectionColor)&&i(s.color,t.reflectionColor),n(s.color)&&!r(t.transparentColor)&&i(s.color,t.transparentColor)}for(let t=0;t<e.MaterialCount();t++)if(I(e.GetMaterial(t),s))return t;return e.AddMaterial(s)}(this.model,n)}}class ut extends Pe{constructor(){super(),this.ifc=null}CanImportExtension(e){return"ifc"===e}GetUpDirection(){return 2}ClearContent(){this.materialNameToIndex=null,this.expressIDToMesh=null}ResetContent(){this.materialNameToIndex={},this.expressIDToMesh={}}ImportContent(e,t){null===this.ifc?et().then((()=>{this.ifc=new IfcAPI,this.ifc.Init().then((()=>{this.ImportIfcContent(e),t()}))})).catch((()=>{t()})):(this.ImportIfcContent(e),t())}ImportIfcContent(e){const t=new Uint8Array(e),i=this.ifc.OpenModel(t,{COORDINATE_TO_ORIGIN:!0}),n=this.ifc.LoadAllGeometry(i);for(let e=0;e<n.size();e++){const t=n.get(e);t.geometries.size()>0&&this.ImportIfcMesh(i,t)}this.ImportProperties(i),this.ifc.CloseModel(i)}ImportIfcMesh(e,t){let i=new $;i.SetName("Mesh "+t.expressID.toString());let n=0;const r=t.geometries;for(let t=0;t<r.size();t++){const s=r.get(t),l=this.ifc.GetGeometry(e,s.geometryExpressID),a=this.ifc.GetVertexArray(l.GetVertexData(),l.GetVertexDataSize()),h=this.ifc.GetIndexArray(l.GetIndexData(),l.GetIndexDataSize()),d=this.GetMaterialIndexByColor(s.color),u=new q(s.flatTransformation),m=new J(u);for(let e=0;e<a.length;e+=6){const t=a[e],n=a[e+1],r=a[e+2],s=new o(t,n,r),l=m.TransformCoord3D(s);i.AddVertex(l)}for(let e=0;e<h.length;e+=3){const t=h[e],r=h[e+1],s=h[e+2],o=new Be(n+t,n+r,n+s);o.SetMaterial(d),i.AddTriangle(o)}n+=a.length/6}this.expressIDToMesh[t.expressID]=i,this.model.AddMeshToRootNode(i)}ImportProperties(e){const t=this.ifc.GetLineIDsWithType(e,4186316022);for(let i=0;i<t.size();i++){const n=t.get(i),r=this.ifc.GetLine(e,n);Array.isArray(r.RelatingPropertyDefinition)||r.RelatedObjects.forEach((t=>{let i=this.expressIDToMesh[t.value];if(void 0===i){if(4031249490!==this.ifc.GetLine(e,t.value,!0).type)return;i=this.model}let n=r.RelatingPropertyDefinition,s=this.ifc.GetLine(e,n.value,!0);if(!s||!s.HasProperties)return;let o=new pe(s.Name.value);s.HasProperties.forEach((e=>{if(!e||!e.Name||!e.NominalValue)return;let t=null,i=this.GetIFCString(e.Name.value),n=null;switch(e.NominalValue.label){case"IFCTEXT":case"IFCLABEL":case"IFCIDENTIFIER":t=new ce(1,i,this.GetIFCString(e.NominalValue.value));break;case"IFCBOOLEAN":case"IFCLOGICAL":n="Unknown","T"===e.NominalValue.value?n="True":"F"===e.NominalValue.value&&(n="False"),t=new ce(1,i,n);break;case"IFCINTEGER":case"IFCCOUNTMEASURE":t=new ce(2,i,e.NominalValue.value);break;case"IFCREAL":case"IFCLENGTHMEASURE":case"IFCPOSITIVELENGTHMEASURE":case"IFCAREAMEASURE":case"IFCVOLUMEMEASURE":case"IFCRATIOMEASURE":case"IFCPOSITIVERATIOMEASURE":case"IFCMASSMEASURE":case"IFCMASSPERLENGTHMEASURE":case"IFCPLANEANGLEMEASURE":case"IFCTHERMALTRANSMITTANCEMEASURE":t=new ce(3,i,e.NominalValue.value);break;default:console.log(e.NominalValue.label),console.log(e.NominalValue.value)}null!==t&&o.AddProperty(t)})),o.PropertyCount()>0&&i.AddPropertyGroup(o)}))}}GetMaterialIndexByColor(e){const t=new g(parseInt(255*e.x,10),parseInt(255*e.y,10),parseInt(255*e.z,10)),i="Color "+b(t.r)+b(t.g)+b(t.b)+b(parseInt(255*e.w,10));let n=this.materialNameToIndex[i];if(void 0===n){let r=new v(1);r.name=i,r.color=t,r.opacity=e.w,Ue(r),n=this.model.AddMaterial(r),this.materialNameToIndex[i]=n}return n}GetIFCString(e){let t=this.DecodeIFCString(e);return 0===t.length&&(t="-"),t}DecodeIFCString(e){const t=/\\X2\\(.*?)\\X0\\/giu;let i=e,n=t.exec(e);for(;n;){const r=String.fromCharCode(parseInt(n[1],16));i=i.replace(n[0],r),n=t.exec(e)}return i}}class mt{constructor(e,t){this.source=t,1===t?(this.fileUrl=e,this.fileObject=null,this.name=ge(e),this.extension=xe(e)):2===t?(this.fileUrl=null,this.fileObject=e,this.name=ge(e.name),this.extension=xe(e.name)):3===t&&(this.fileUrl=null,this.fileObject=null,this.name=ge(e),this.extension=xe(e)),this.content=null}SetContent(e){this.content=e}}class ct{constructor(){this.files=[]}FillFromFileUrls(e){this.Fill(e,1)}FillFromFileObjects(e){this.Fill(e,2)}ExtendFromFileList(e){for(let t=0;t<e.length;t++){let i=e[t];this.ContainsFileByPath(i.name)||this.files.push(i)}}GetFiles(){return this.files}GetContent(e){var t,i;t=this.files.length,i={runTask:(e,t)=>{this.GetFileContent(this.files[e],t)},onReady:e},(new Ce).Run(t,i)}ContainsFileByPath(e){return null!==this.FindFileByPath(e)}FindFileByPath(e){let t=ge(e).toLowerCase();for(let e=0;e<this.files.length;e++){let i=this.files[e];if(i.name.toLowerCase()===t)return i}return null}IsOnlyUrlSource(){if(0===this.files.length)return!1;for(let e=0;e<this.files.length;e++){let t=this.files[e];if(1!==t.source&&3!==t.source)return!1}return!0}Fill(e,t){this.files=[];for(let i=0;i<e.length;i++){let n=e[i],r=new mt(n,t);this.AddFile(r)}}AddFile(e){this.files.push(e)}GetFileContent(e,t){if(null!==e.content)return void t();let i=null;if(1===e.source)n=e.fileUrl,2,i=new Promise(((e,t)=>{let i=new XMLHttpRequest;i.open("GET",n,!0),i.responseType="arraybuffer",i.onload=function(){200===i.status?e(i.response):t()},i.onerror=function(){t()},i.send(null)}));else{if(2!==e.source)return void t();i=function(e,t){return new Promise(((t,i)=>{let n=new FileReader;n.onloadend=function(e){e.target.readyState===FileReader.DONE&&t(e.target.result)},n.onerror=function(){i()},n.readAsArrayBuffer(e)}))}(e.fileObject)}var n;i.then((t=>{e.SetContent(t)})).catch((()=>{})).finally((()=>{t()}))}}class pt extends Pe{constructor(){super()}GetExternalLibraries(){return null}CreateLoader(e){return null}GetMainObject(e){return e}IsMeshVisible(e){return!0}ClearContent(){this.loader=null,this.materialIdToIndex=null,this.objectUrlToFileName=null}ResetContent(){this.loader=null,this.materialIdToIndex=new Map,this.objectUrlToFileName=new Map}ImportContent(e,t){const i=this.GetExternalLibraries();null!==i?async function(e,t,i){try{for(let t=0;t<e.length;t++)await et(e[t])}catch(e){i()}t()}(i,(()=>{this.LoadModel(e,t)}),(()=>{t()})):t()}LoadModel(e,t){let i=null,n=new THREE.LoadingManager((()=>{null!==i&&this.OnThreeObjectsLoaded(i,t)}));const r=De(e);n.setURLModifier((e=>{if(e===r)return e;const t=ge(e);if(xe(e).length>0){const i=this.callbacks.getFileBuffer(e);if(null!==i){let e=De(i);return this.objectUrlToFileName.set(e,t),e}}return e}));const s=this.CreateLoader(n);null!==s?s.load(r,(e=>{i=e}),(()=>{}),(e=>{this.SetError(e),t()})):t()}OnThreeObjectsLoaded(e,t){function i(e){let t=(new q).CreateIdentity();return e.updateMatrix(),void 0!==e.matrix&&null!==e.matrix&&t.Set(e.matrix.elements),new J(t)}function n(e,t,r,s){let o=new _e;void 0!==r.name&&o.SetName(r.name),o.SetTransformation(i(r)),s.AddChildNode(o);for(let i of r.children)n(e,t,i,o);if(r.isMesh&&e.IsMeshVisible(r)){0===r.children.length&&o.SetType(1);let i=e.ConvertThreeMesh(r),n=t.AddMesh(i);o.AddMeshIndex(n)}}let r=this.GetMainObject(e),s=this.model.GetRootNode();s.SetTransformation(i(r));for(let e of r.children)n(this,this.model,e,s);t()}ConvertThreeMesh(e){let t=null;if(Array.isArray(e.material)){if(t=ht(e.geometry,null),void 0===e.geometry.attributes.color||null===e.geometry.attributes.color){let i=[];for(let t=0;t<e.material.length;t++){const n=e.material[t],r=this.FindOrCreateMaterial(n);i.push(r)}for(let n=0;n<e.geometry.groups.length;n++){let r=e.geometry.groups[n];for(let e=r.start/3;e<r.start/3+r.count/3;e++)t.GetTriangle(e).SetMaterial(i[r.materialIndex])}}}else{const i=this.FindOrCreateMaterial(e.material);t=ht(e.geometry,i)}return void 0!==e.name&&null!==e.name&&t.SetName(e.name),t}FindOrCreateMaterial(e){if(this.materialIdToIndex.has(e.id))return this.materialIdToIndex.get(e.id);let t=this.ConvertThreeMaterial(e),i=this.model.AddMaterial(t);return this.materialIdToIndex.set(e.id,i),i}ConvertThreeMaterial(e){function t(e,t){e.Set(parseInt(255*t.r,10),parseInt(255*t.g,10),parseInt(255*t.b,10))}function i(e,t){if(null==e)return null;if(void 0===e.image||null===e.image)return null;try{const i=function(e){if(void 0!==e.data&&null!==e.data){let t=new ImageData(e.width,e.height),i=e.width*e.height*4;for(let n=0;n<i;n++)t.data[n]=e.data[n];return THREE.ImageUtils.getDataURL(t)}return THREE.ImageUtils.getDataURL(e)}(e.image),n=Ae(i);let r=new x,s=null;return s=t.has(e.image.src)?t.get(e.image.src):void 0!==e.name&&null!==e.name?e.name+"."+Ge(n.mimeType):"Embedded_"+e.id.toString()+"."+Ge(n.mimeType),r.name=s,r.url=i,r.buffer=n.buffer,r.rotation=e.rotation,r.offset.x=e.offset.x,r.offset.y=e.offset.y,r.scale.x=e.repeat.x,r.scale.y=e.repeat.y,r}catch(e){return null}}let n=new v(1);return n.name=e.name,t(n.color,e.color),n.opacity=e.opacity,n.transparent=e.transparent,n.alphaTest=e.alphaTest,"MeshPhongMaterial"===e.type&&(t(n.specular,e.specular),n.shininess=e.shininess/100),n.diffuseMap=i(e.map,this.objectUrlToFileName),n.normalMap=i(e.normalMap,this.objectUrlToFileName),n.bumpMap=i(e.bumpMap,this.objectUrlToFileName),n}}class ft extends pt{constructor(){super()}CanImportExtension(e){return"fbx"===e}GetUpDirection(){return 2}GetExternalLibraries(){return["loaders/fflate.min.js","three_loaders/TGALoader.js","three_loaders/FBXLoader.js"]}CreateLoader(e){return e.addHandler(/\.tga$/i,new THREE.TGALoader(e)),new THREE.FBXLoader(e)}GetMainObject(e){return e}}class gt extends pt{constructor(){super()}CanImportExtension(e){return"dae"===e}GetUpDirection(){return 2}GetExternalLibraries(){return["three_loaders/TGALoader.js","three_loaders/ColladaLoader.js"]}CreateLoader(e){return e.addHandler(/\.tga$/i,new THREE.TGALoader(e)),new THREE.ColladaLoader(e)}GetMainObject(e){return e.scene}}class xt extends pt{constructor(){super()}CanImportExtension(e){return"wrl"===e}GetUpDirection(){return 2}GetExternalLibraries(){return["three_loaders/chevrotain.min.js","three_loaders/VRMLLoader.js"]}CreateLoader(e){return new THREE.VRMLLoader(e)}GetMainObject(e){return e}IsMeshVisible(e){let t=!0;if(Array.isArray(e.material)){for(let i=0;i<e.material.length;i++)if(e.material[i].side===THREE.BackSide){t=!1;break}}else t=e.material.side!==THREE.BackSide;return t}}class vt extends pt{constructor(){super()}CanImportExtension(e){return"3mf"===e}GetUpDirection(){return 3}GetExternalLibraries(){return["loaders/fflate.min.js","three_loaders/3MFLoader.js"]}CreateLoader(e){return new THREE.ThreeMFLoader(e)}GetMainObject(e){return e}}class Ct{constructor(){this.defaultColor=new g(200,200,200)}}class yt{constructor(e,t){this.code=e,this.message=t}}class bt{constructor(){this.model=null,this.mainFile=null,this.upVector=null,this.usedFiles=null,this.missingFiles=null}}class wt{constructor(e){this.getBufferCallback=e,this.fileBuffers=new Map,this.textureBuffers=new Map}GetFileBuffer(e){let t=ge(e);if(this.fileBuffers.has(t))return this.fileBuffers.get(t);let i=this.getBufferCallback(t);return this.fileBuffers.set(t,i),i}GetTextureBuffer(e){let t=ge(e);if(this.textureBuffers.has(t))return this.textureBuffers.get(t);let i=null,n=this.getBufferCallback(t);return null!==n&&(i={url:De(n),buffer:n}),this.textureBuffers.set(t,i),i}}class Mt{constructor(){this.importers=[new ze,new je,new Ke,new Xe,new Qe,new nt,new at,new dt,new ut,new ft,new gt,new xt,new vt],this.fileList=new ct,this.model=null,this.usedFiles=[],this.missingFiles=[]}AddImporter(e){this.importers.push(e)}ImportFilesFromUrls(e,t,i){this.ImportFiles(e,1,t,i)}ImportFilesFromFileObjects(e,t,i){this.ImportFiles(e,2,t,i)}ImportFiles(e,t,i,n){this.LoadFiles(e,t,(()=>{n.onFilesLoaded(),ye((()=>{this.ImportLoadedFiles(i,n)}))}))}LoadFiles(e,t,i){let n=new ct(this.importers);1===t?n.FillFromFileUrls(e):2===t&&n.FillFromFileObjects(e);let r=!1;if(this.HasMainFile(n))r=!0;else{let e=!1;for(let t=0;t<this.missingFiles.length;t++){let i=this.missingFiles[t];n.ContainsFileByPath(i)&&(e=!0)}if(e){let e=n.GetFiles();this.fileList.ExtendFromFileList(e),r=!1}else r=!0}r&&(this.fileList=n),this.fileList.GetContent((()=>{this.DecompressArchives(this.fileList,(()=>{i()}))}))}ImportLoadedFiles(e,t){let i=this.GetMainFile(this.fileList);if(null===i||null===i.file||null===i.file.content)return void t.onImportError(new yt(1,null));this.RevokeModelUrls(),this.model=null,this.usedFiles=[],this.missingFiles=[],this.usedFiles.push(i.file.name);let n=i.importer,r=new wt((e=>{let t=null,i=this.fileList.FindFileByPath(e);return null===i||null===i.content?(this.missingFiles.push(e),t=null):(this.usedFiles.push(e),t=i.content),t}));n.Import(i.file.name,i.file.extension,i.file.content,{getDefaultMaterial:()=>{let t=new v(1);return t.color=e.defaultColor,t},getFileBuffer:e=>r.GetFileBuffer(e),getTextureBuffer:e=>r.GetTextureBuffer(e),onSuccess:()=>{let e=new bt;e.mainFile=i.file.name,e.model=n.GetModel(),e.usedFiles=this.usedFiles,e.missingFiles=this.missingFiles,e.upVector=n.GetUpDirection(),t.onImportSuccess(e)},onError:()=>{let e=n.GetErrorMessage();t.onImportError(new yt(2,e))},onComplete:()=>{n.Clear()}})}DecompressArchives(e,t){let i=e.GetFiles(),n=[];for(let e of i)"zip"===e.extension&&n.push(e);0!==n.length?et().then((()=>{for(let t=0;t<n.length;t++){const i=n[t],r=new Uint8Array(i.content),s=fflate.unzipSync(r);for(const t in s)if(Object.prototype.hasOwnProperty.call(s,t)){let i=new mt(t,3);i.SetContent(s[t].buffer),e.AddFile(i)}}t()})).catch((()=>{t()})):t()}GetFileList(){return this.fileList}HasMainFile(e){return null!==this.GetMainFile(e)}GetMainFile(e){function t(e,t){for(let i=0;i<t.length;i++){let n=t[i];if(n.CanImportExtension(e.extension))return n}return null}let i=e.GetFiles();for(let e=0;e<i.length;e++){let n=i[e],r=t(n,this.importers);if(null!==r)return{file:n,importer:r}}return null}RevokeModelUrls(){if(null!==this.model)for(let i=0;i<this.model.MaterialCount();i++)e=this.model.GetMaterial(i),t=e=>{var t;null!==e.url&&(t=e.url,URL.revokeObjectURL(t))},null!==e.diffuseMap&&t(e.diffuseMap),null!==e.specularMap&&t(e.specularMap),null!==e.bumpMap&&t(e.bumpMap),null!==e.normalMap&&t(e.normalMap),null!==e.emissiveMap&&t(e.emissiveMap),null!==e.metalnessMap&&t(e.metalnessMap);var e,t}}class It{constructor(){this.forceMediumpForMaterials=!1}}class St{constructor(){this.defaultMaterial=null}}class Tt{constructor(){this.importer=new Mt,this.callbacks=null,this.inProgress=!1,this.defaultMaterial=null,this.hasHighpDriverIssue=HasHighpDriverIssue()}Init(e){this.callbacks=e}LoadFromUrlList(e,t){this.LoadFromSource(e,1,t)}LoadFromFileList(e,t){this.LoadFromSource(e,2,t)}LoadFromSource(e,t,i){this.inProgress||(this.inProgress=!0,this.callbacks.onLoadStart(),this.importer.ImportFiles(e,t,i,{onFilesLoaded:()=>{this.callbacks.onImportStart()},onImportSuccess:e=>{this.OnModelImported(e)},onImportError:e=>{this.callbacks.onLoadError(e),this.inProgress=!1}}))}OnModelImported(e){this.callbacks.onVisualizationStart();let t=new It;t.forceMediumpForMaterials=this.hasHighpDriverIssue;let i=new St;ConvertModelToThreeObject(e.model,t,i,{onTextureLoaded:()=>{this.callbacks.onTextureLoaded()},onModelLoaded:t=>{this.defaultMaterial=i.defaultMaterial,this.callbacks.onModelFinished(e,t),this.inProgress=!1}})}GetImporter(){return this.importer}ReplaceDefaultMaterialColor(e){null!==this.defaultMaterial&&(this.defaultMaterial.color=new THREE.Color(e.r/255,e.g/255,e.b/255))}}class Et{constructor(){this.modalDiv=U.CreateDiv("ov_modal"),this.overlayDiv=null,this.resizeHandler=null,this.positionCalculator=null,this.closeHandler=null,this.isOpen=!1,this.closeable=!0}GetContentDiv(){return this.modalDiv}SetCloseable(e){this.closeable=e}SetPositionCalculator(e){this.positionCalculator=e}SetCloseHandler(e){this.closeHandler=e}Open(){this.overlayDiv=U.AddDiv(document.body,"ov_modal_overlay"),document.body.appendChild(this.modalDiv),this.resizeHandler=this.Resize.bind(this),window.addEventListener("resize",this.resizeHandler),this.closeable&&(this.overlayDiv.addEventListener("click",(e=>{e.preventDefault(),this.Close()})),this.overlayDiv.addEventListener("contextmenu",(e=>{e.preventDefault(),this.Close()}))),this.isOpen=!0,this.Resize()}Close(){this.isOpen&&(window.removeEventListener("resize",this.resizeHandler),null!==this.closeHandler&&this.closeHandler(),this.modalDiv.remove(),this.overlayDiv.remove(),this.overlayDiv=null,this.resizeHandler=null,this.isOpen=!1)}IsOpen(){return this.isOpen}Resize(){let e=window.innerWidth,t=window.innerHeight,i=(e-this.modalDiv.offsetWidth)/2,n=(t-this.modalDiv.offsetHeight)/3;if(null!==this.positionCalculator){let e=this.positionCalculator();i=e.x,n=e.y}this.modalDiv.style.left=i+"px",this.modalDiv.style.top=n+"px"}}class At{constructor(){this.modal=new Et}GetContentDiv(){return this.modal.GetContentDiv()}SetCloseable(e){this.modal.SetCloseable(e)}SetCloseHandler(e){this.modal.SetCloseHandler(e)}SetPositionCalculator(e){this.modal.SetPositionCalculator(e)}Show(){this.modal.Open()}Hide(){this.modal.Close()}}class Gt extends At{constructor(){super(),this.modal.SetCloseable(!1),this.textDiv=null}Init(e){let t=this.modal.GetContentDiv();t.classList.add("ov_progress"),U.AddDiv(t,"ov_progress_img",'<svg><use href="assets/images/3dviewer_net_logo.svg#logo"></use></svg>'),this.textDiv=U.AddDiv(t,"ov_progress_text"),this.SetText(e)}SetText(e){this.textDiv.innerHTML=e}}class Dt extends At{constructor(){super()}Init(e,t){function i(e,t){let i=U.AddDiv(t,"ov_button ov_dialog_button",e.name);e.subClass&&i.classList.add(e.subClass),i.addEventListener("click",(()=>{e.onClick()}))}let n=this.modal.GetContentDiv();n.classList.add("ov_dialog"),U.AddDiv(n,"ov_dialog_title",e);let r=U.AddDiv(n,"ov_dialog_content"),s=U.AddDiv(n,"ov_dialog_buttons"),o=U.AddDiv(s,"ov_dialog_buttons_inner");for(let e=0;e<t.length;e++)i(t[e],o);return r}}class Rt extends At{constructor(){super()}Init(e){let t=this.modal.GetContentDiv();return t.classList.add("ov_popup"),this.modal.SetPositionCalculator(e),t}}class Ft extends Rt{constructor(){super(),this.listDiv=null}Init(e){let t=super.Init(e);return this.listDiv=U.AddDiv(t,"ov_popup_list ov_thin_scrollbar"),t}AddListItem(e,t){let i=U.AddDiv(this.listDiv,"ov_popup_list_item");if(e.icon&&B.AddSvgIconElement(i,e.icon,"left_inline"),e.color){let t=U.AddDiv(i,"ov_popup_list_item_icon"),n=B.CreateInlineColorCircle(e.color);t.appendChild(n)}U.AddDiv(i,"ov_popup_list_item_name",e.name),i.addEventListener("click",t.onClick),B.IsHoverEnabled()&&t.onHoverStart&&t.onHoverStop&&(i.addEventListener("mouseover",(()=>{t.onHoverStart()})),i.addEventListener("mouseout",(()=>{t.onHoverStop()})))}}function _t(e,t,i){let n=new Dt,r=n.Init(e,[{name:"OK",onClick(){n.Hide()}}]);return U.AddDiv(r,"ov_dialog_message",t),null!==i&&U.AddDiv(r,"ov_dialog_submessage",i),n.Show(),n}class Lt{constructor(e){this.name=e,this.content=null}GetName(){return this.name}SetName(e){this.name=e}GetTextContent(){return Te(this.content)}GetBufferContent(){return this.content}SetTextContent(e){let t=Ee(e);this.content=t}SetBufferContent(e){this.content=e}}class Vt{constructor(){}CanExport(e,t){return!1}Export(e,t,i){let n=[];this.ExportContent(e,t,n,(()=>{i(n)}))}ExportContent(e,t,i,n){}GetExportedMaterialName(e){return this.GetExportedName(e,"Material")}GetExportedMeshName(e){return this.GetExportedName(e,"Mesh")}GetExportedName(e,t){return 0===e.length?t:e}}class Pt{constructor(){this.text="",this.indentation=0}GetText(){return this.text}Indent(e){this.indentation+=e}WriteArrayLine(e){this.WriteLine(e.join(" "))}WriteLine(e){this.WriteIndentation(),this.Write(e+"\n")}WriteIndentation(){for(let e=0;e<this.indentation;e++)this.Write("  ")}Write(e){this.text+=e}}class Nt extends Vt{constructor(){super()}CanExport(e,t){return 1===e&&"obj"===t}ExportContent(e,t,i,n){function r(e,t,i,n){if(null===i||!i.IsValid())return;let r=ge(i.name);if(e.WriteArrayLine([t,r]),-1===n.findIndex((e=>e.GetName()===r))){let e=new Lt(r);e.SetBufferContent(i.buffer),n.push(e)}}let s=new Lt("model.mtl"),o=new Lt("model.obj");i.push(s),i.push(o);let l=new Pt;l.WriteLine(this.GetHeaderText());for(let t=0;t<e.MaterialCount();t++){let n=e.GetMaterial(t);l.WriteArrayLine(["newmtl",this.GetExportedMaterialName(n.name)]),l.WriteArrayLine(["Ka",n.ambient.r/255,n.ambient.g/255,n.ambient.b/255]),l.WriteArrayLine(["Kd",n.color.r/255,n.color.g/255,n.color.b/255]),l.WriteArrayLine(["Ks",n.specular.r/255,n.specular.g/255,n.specular.b/255]),l.WriteArrayLine(["Ns",1e3*n.shininess]),l.WriteArrayLine(["d",n.opacity]),r(l,"map_Kd",n.diffuseMap,i),r(l,"map_Ks",n.specularMap,i),r(l,"bump",n.bumpMap,i)}s.SetTextContent(l.GetText());let a=new Pt;a.WriteLine(this.GetHeaderText()),a.WriteArrayLine(["mtllib",s.GetName()]);let h=0,d=0,u=0,m=null;e.EnumerateTransformedMeshes((t=>{a.WriteArrayLine(["g",this.GetExportedMeshName(t.GetName())]);for(let e=0;e<t.VertexCount();e++){let i=t.GetVertex(e);a.WriteArrayLine(["v",i.x,i.y,i.z])}for(let e=0;e<t.NormalCount();e++){let i=t.GetNormal(e);a.WriteArrayLine(["vn",i.x,i.y,i.z])}for(let e=0;e<t.TextureUVCount();e++){let i=t.GetTextureUV(e);a.WriteArrayLine(["vt",i.x,i.y])}for(let i=0;i<t.TriangleCount();i++){let n=t.GetTriangle(i),r=n.v0+h+1,s=n.v1+h+1,o=n.v2+h+1,l=n.n0+d+1,c=n.n1+d+1,p=n.n2+d+1;if(null!==n.mat){let t=e.GetMaterial(n.mat),i=this.GetExportedMaterialName(t.name);i!==m&&(a.WriteArrayLine(["usemtl",i]),m=i)}let f="",g="",x="";n.HasTextureUVs()&&(f=n.u0+u+1,g=n.u1+u+1,x=n.u2+u+1),a.WriteArrayLine(["f",[r,f,l].join("/"),[s,g,c].join("/"),[o,x,p].join("/")])}h+=t.VertexCount(),d+=t.NormalCount(),u+=t.TextureUVCount()})),o.SetTextContent(a.GetText()),n()}GetHeaderText(){return"# exported by https://3dviewer.net"}}class kt{constructor(e,t){this.arrayBuffer=new ArrayBuffer(e),this.dataView=new DataView(this.arrayBuffer),this.isLittleEndian=t,this.position=0}GetPosition(){return this.position}SetPosition(e){this.position=e}End(){return this.position>=this.arrayBuffer.byteLength}GetBuffer(){return this.arrayBuffer}WriteArrayBuffer(e){let t=new Uint8Array(e);new Uint8Array(this.arrayBuffer).set(t,this.position),this.position+=e.byteLength}WriteBoolean8(e){this.dataView.setInt8(this.position,e?1:0),this.position=this.position+1}WriteCharacter8(e){this.dataView.setInt8(this.position,e),this.position=this.position+1}WriteUnsignedCharacter8(e){this.dataView.setUint8(this.position,e),this.position=this.position+1}WriteInteger16(e){this.dataView.setInt16(this.position,e,this.isLittleEndian),this.position=this.position+2}WriteUnsignedInteger16(e){this.dataView.setUint16(this.position,e,this.isLittleEndian),this.position=this.position+2}WriteInteger32(e){this.dataView.setInt32(this.position,e,this.isLittleEndian),this.position=this.position+4}WriteUnsignedInteger32(e){this.dataView.setUint32(this.position,e,this.isLittleEndian),this.position=this.position+4}WriteFloat32(e){this.dataView.setFloat32(this.position,e,this.isLittleEndian),this.position=this.position+4}WriteDouble64(e){this.dataView.setFloat64(this.position,e,this.isLittleEndian),this.position=this.position+8}}class Ht extends Vt{constructor(){super()}CanExport(e,t){return(1===e||2===e)&&"stl"===t}ExportContent(e,t,i,n){1===t?this.ExportText(e,i):this.ExportBinary(e,i),n()}ExportText(e,t){let i=new Lt("model.stl");t.push(i);let n=new Pt;n.WriteLine("solid Model"),de(e,((e,t,i,r)=>{n.WriteArrayLine(["facet","normal",r.x,r.y,r.z]),n.Indent(1),n.WriteLine("outer loop"),n.Indent(1),n.WriteArrayLine(["vertex",e.x,e.y,e.z]),n.WriteArrayLine(["vertex",t.x,t.y,t.z]),n.WriteArrayLine(["vertex",i.x,i.y,i.z]),n.Indent(-1),n.WriteLine("endloop"),n.Indent(-1),n.WriteLine("endfacet")})),n.WriteLine("endsolid Model"),i.SetTextContent(n.GetText())}ExportBinary(e,t){let i=new Lt("model.stl");t.push(i);let n=e.TriangleCount(),r=new kt(84+50*n,!0);for(let e=0;e<80;e++)r.WriteUnsignedCharacter8(0);r.WriteUnsignedInteger32(n),de(e,((e,t,i,n)=>{r.WriteFloat32(n.x),r.WriteFloat32(n.y),r.WriteFloat32(n.z),r.WriteFloat32(e.x),r.WriteFloat32(e.y),r.WriteFloat32(e.z),r.WriteFloat32(t.x),r.WriteFloat32(t.y),r.WriteFloat32(t.z),r.WriteFloat32(i.x),r.WriteFloat32(i.y),r.WriteFloat32(i.z),r.WriteUnsignedInteger16(0)})),i.SetBufferContent(r.GetBuffer())}}class Ut extends Vt{constructor(){super()}CanExport(e,t){return(1===e||2===e)&&"ply"===t}ExportContent(e,t,i,n){1===t?this.ExportText(e,i):this.ExportBinary(e,i),n()}ExportText(e,t){let i=new Lt("model.ply");t.push(i);let n=new Pt,r=e.VertexCount(),s=e.TriangleCount(),o=this.GetHeaderText("ascii",r,s);n.Write(o),he(e,{onVertex:function(e,t,i){n.WriteArrayLine([e,t,i])},onTriangle:function(e,t,i){n.WriteArrayLine([3,e,t,i])}}),i.SetTextContent(n.GetText())}ExportBinary(e,t){let i=new Lt("model.ply");t.push(i);let n=e.VertexCount(),r=e.TriangleCount(),s=this.GetHeaderText("binary_little_endian",n,r),o=s.length+3*n*4+13*r,l=new kt(o,!0);for(let e=0;e<s.length;e++)l.WriteUnsignedCharacter8(s.charCodeAt(e));he(e,{onVertex:function(e,t,i){l.WriteFloat32(e),l.WriteFloat32(t),l.WriteFloat32(i)},onTriangle:function(e,t,i){l.WriteUnsignedCharacter8(3),l.WriteInteger32(e),l.WriteInteger32(t),l.WriteInteger32(i)}}),i.SetBufferContent(l.GetBuffer())}GetHeaderText(e,t,i){let n=new Pt;return n.WriteLine("ply"),n.WriteLine("format "+e+" 1.0"),n.WriteLine("element vertex "+t),n.WriteLine("property float x"),n.WriteLine("property float y"),n.WriteLine("property float z"),n.WriteLine("element face "+i),n.WriteLine("property list uchar int vertex_index"),n.WriteLine("end_header"),n.GetText()}}class Bt extends Vt{constructor(){super()}CanExport(e,t){return 1===e&&"off"===t}ExportContent(e,t,i,n){let r=new Lt("model.off");i.push(r);let s=new Pt;s.WriteLine("OFF"),s.WriteArrayLine([e.VertexCount(),e.TriangleCount(),0]),he(e,{onVertex:function(e,t,i){s.WriteArrayLine([e,t,i])},onTriangle:function(e,t,i){s.WriteArrayLine([3,e,t,i])}}),r.SetTextContent(s.GetText()),n()}}class Ot{constructor(){this.indices=[],this.vertices=[],this.normals=[],this.uvs=[],this.material=null}GetBounds(){let e=[1/0,1/0,1/0],t=[-1/0,-1/0,-1/0];for(let i=0;i<this.vertices.length/3;i++)for(let n=0;n<3;n++)e[n]=Math.min(e[n],this.vertices[3*i+n]),t[n]=Math.max(t[n],this.vertices[3*i+n]);return{min:e,max:t}}GetByteLength(e,t){return this.indices.length*e+(this.vertices.length+this.normals.length+this.uvs.length)*t}}class zt{constructor(){this.primitives=[]}PrimitiveCount(){return this.primitives.length}GetPrimitive(e){return this.primitives[e]}GetByteLength(e,t){let i=0;for(let n=0;n<this.primitives.length;n++)i+=this.primitives[n].GetByteLength(e,t);return i}}function Wt(e){function t(e,t,i,n,r,s){function o(e,t,i){return null!==t?e.GetTextureUV(t):i?new c(0,0):null}function a(e,t,i,n,r){let s=e.TextureUVCount()>0,l=e.GetVertex(t),a=e.GetNormal(i),h=r.vertices.length/3;r.indices.push(h),r.vertices.push(l.x,l.y,l.z),r.normals.push(a.x,a.y,a.z);let d=o(e,n,s);return null!==d&&r.uvs.push(d.x,d.y),{index:h,normal:a,uv:d}}let h=s[t];if(void 0===h){let o=a(e,t,i,n,r);s[t]=[o]}else{let s=function(e,t,i,n){for(let r=0;r<t.length;r++){let s=t[r],a=e.GetNormal(i),h=l(s.normal,a),d=!1;if(null===s.uv&&null===n)d=!0;else{let t=o(e,n,!0);d=p(s.uv,t)}if(h&&d)return s}return null}(e,h,i,n);if(null!==s)r.indices.push(s.index);else{let s=a(e,t,i,n,r);h.push(s)}}}let i=new zt,n=e.TriangleCount();if(0===n)return null;let r=[];for(let e=0;e<n;e++)r.push(e);r.sort(((t,i)=>{let n=e.GetTriangle(t),r=e.GetTriangle(i);return n.mat-r.mat}));let s=null,o=null;for(let n=0;n<r.length;n++){let l=r[n],a=e.GetTriangle(l);null!==s&&s.material===a.mat||(s=new Ot,s.material=a.mat,o={},i.primitives.push(s)),t(e,a.v0,a.n0,a.u0,s,o),t(e,a.v1,a.n1,a.u1,s,o),t(e,a.v2,a.n2,a.u2,s,o)}return i}class jt extends Vt{constructor(){super(),this.components={index:{type:5125,size:4},number:{type:5126,size:4}}}CanExport(e,t){return 1===e&&"gltf"===t||2===e&&"glb"===t}ExportContent(e,t,i,n){1===t?this.ExportAsciiContent(e,i):2===t&&this.ExportBinaryContent(e,i),n()}ExportAsciiContent(e,t){let i=new Lt("model.gltf"),n=new Lt("model.bin");t.push(i),t.push(n);let r=this.GetMeshData(e),s=this.GetMainBuffer(r),o=this.GetMainJson(r);o.buffers.push({uri:n.GetName(),byteLength:s.byteLength});let l=[];this.ExportMaterials(e,o,(e=>{let i=ge(e.name),n=l[i];if(void 0===n){let r=new Lt(i);r.SetBufferContent(e.buffer),t.push(r),n=o.textures.length,l[i]=n,o.images.push({uri:i}),o.textures.push({source:n})}return n})),i.SetTextContent(JSON.stringify(o,null,4)),n.SetBufferContent(s)}ExportBinaryContent(e,t){function i(e){let t=e%4;return 0===t?e:e+(4-t)}function n(e,t,i){for(let n=0;n<i;n++)e.WriteUnsignedCharacter8(t)}let r=new Lt("model.glb");t.push(r);let s=this.GetMeshData(e),o=this.GetMainBuffer(s),l=this.GetMainJson(s),a=[],h=o.byteLength,d=[];this.ExportMaterials(e,l,(e=>{let t=ge(e.name),i=xe(e.name),n=d[t];if(void 0===n){let r=l.bufferViews.length;n=l.textures.length,d[t]=n;let s=e.buffer;a.push(s),l.bufferViews.push({buffer:0,byteOffset:h,byteLength:s.byteLength}),h+=s.byteLength,l.images.push({bufferView:r,mimeType:"image/"+i}),l.textures.push({source:n})}return n}));let u=o.byteLength;for(let e=0;e<a.length;e++)u+=a[e].byteLength;let m=i(u);l.buffers.push({byteLength:m});let c=Ee(JSON.stringify(l)),p=c.byteLength,f=i(p),g=20+f+8+m,x=new kt(g,!0);x.WriteUnsignedInteger32(1179937895),x.WriteUnsignedInteger32(2),x.WriteUnsignedInteger32(g),x.WriteUnsignedInteger32(f),x.WriteUnsignedInteger32(1313821514),x.WriteArrayBuffer(c),n(x,32,f-p),x.WriteUnsignedInteger32(m),x.WriteUnsignedInteger32(5130562),x.WriteArrayBuffer(o);for(let e=0;e<a.length;e++){let t=a[e];x.WriteArrayBuffer(t)}n(x,0,m-u),r.SetBufferContent(x.GetBuffer())}GetMeshData(e){let t=[];return e.EnumerateTransformedMeshes((e=>{let i=Wt(e);t.push({name:e.GetName(),buffer:i,offsets:[],sizes:[]})})),t}GetMainBuffer(e){let t=0;for(let i=0;i<e.length;i++)t+=e[i].buffer.GetByteLength(this.components.index.size,this.components.number.size);let i=new kt(t,!0);for(let t=0;t<e.length;t++){let n=e[t];for(let e=0;e<n.buffer.PrimitiveCount();e++){let t=n.buffer.GetPrimitive(e),r=i.GetPosition();for(let e=0;e<t.indices.length;e++)i.WriteUnsignedInteger32(t.indices[e]);for(let e=0;e<t.vertices.length;e++)i.WriteFloat32(t.vertices[e]);for(let e=0;e<t.normals.length;e++)i.WriteFloat32(t.normals[e]);for(let e=0;e<t.uvs.length;e++){let n=t.uvs[e];e%2==1&&(n*=-1),i.WriteFloat32(n)}n.offsets.push(r),n.sizes.push(i.GetPosition()-r)}}return i.GetBuffer()}GetMainJson(e){class t{constructor(e,t){this.mainJson=e,this.byteOffset=t}AddBufferView(e){this.mainJson.bufferViews.push({buffer:0,byteOffset:this.byteOffset,byteLength:e}),this.byteOffset+=e}}let i={asset:{version:"2.0",generator:"https://3dviewer.net"},scene:0,scenes:[{nodes:[]}],nodes:[],materials:[],meshes:[],buffers:[],bufferViews:[],accessors:[]};for(let n=0;n<e.length;n++){let r=e[n];i.scenes[0].nodes.push(n),i.nodes.push({mesh:n});let s={name:this.GetExportedMeshName(r.name),primitives:[]},o=r.buffer.primitives;for(let e=0;e<o.length;e++){let n=o[e],l=i.bufferViews.length,a=new t(i,r.offsets[e]);a.AddBufferView(n.indices.length*this.components.index.size),a.AddBufferView(n.vertices.length*this.components.number.size),a.AddBufferView(n.normals.length*this.components.number.size);let h=i.accessors.length,d={attributes:{POSITION:h+1,NORMAL:h+2},indices:h,mode:4,material:n.material},u=n.GetBounds();i.accessors.push({bufferView:l,byteOffset:0,componentType:this.components.index.type,count:n.indices.length,type:"SCALAR"}),i.accessors.push({bufferView:l+1,byteOffset:0,componentType:this.components.number.type,count:n.vertices.length/3,min:u.min,max:u.max,type:"VEC3"}),i.accessors.push({bufferView:l+2,byteOffset:0,componentType:this.components.number.type,count:n.normals.length/3,type:"VEC3"}),n.uvs.length>0&&(a.AddBufferView(n.uvs.length*this.components.number.size),i.accessors.push({bufferView:l+3,byteOffset:0,componentType:this.components.number.type,count:n.uvs.length/2,type:"VEC2"}),d.attributes.TEXCOORD_0=h+3),s.primitives.push(d)}i.meshes.push(s)}return i}ExportMaterials(e,t,i){function n(e,t,i,n){function r(e,t){return[C(e.r/255),C(e.g/255),C(e.b/255),t]}function s(e,t,i){if(null===t||!t.IsValid())return null;void 0===e.images&&(e.images=[]),void 0===e.textures&&(e.textures=[]);let n={index:i(t)};if(t.HasTransformation()){let i="KHR_texture_transform";void 0===e.extensionsUsed&&(e.extensionsUsed=[]),-1===e.extensionsUsed.indexOf(i)&&e.extensionsUsed.push(i),n.extensions={KHR_texture_transform:{offset:[t.offset.x,-t.offset.y],scale:[t.scale.x,t.scale.y],rotation:-t.rotation}}}return n}let o={name:e.GetExportedMaterialName(i.name),pbrMetallicRoughness:{baseColorFactor:r(i.color,i.opacity)},emissiveFactor:(l=i.emissive,[C(l.r/255),C(l.g/255),C(l.b/255)]),doubleSided:!0,alphaMode:"OPAQUE"};var l;i.transparent&&(o.alphaMode="BLEND");let a=s(t,i.diffuseMap,n);null!==a&&(i.multiplyDiffuseMap||(o.pbrMetallicRoughness.baseColorFactor=r(new g(255,255,255),i.opacity)),o.pbrMetallicRoughness.baseColorTexture=a);let h=s(t,i.metalnessMap,n);null!==h?o.pbrMetallicRoughness.metallicRoughnessTexture=h:(o.pbrMetallicRoughness.metallicFactor=i.metalness,o.pbrMetallicRoughness.roughnessFactor=i.roughness);let d=s(t,i.normalMap,n);null!==d&&(o.normalTexture=d);let u=s(t,i.emissiveMap,n);null!==u&&(o.emissiveTexture=u),t.materials.push(o)}for(let r=0;r<e.MaterialCount();r++)n(this,t,e.GetMaterial(r),i)}}class Kt extends Vt{constructor(){super(),this.rhino=null}CanExport(e,t){return 2===e&&"3dm"===t}ExportContent(e,t,i,n){null===this.rhino?et().then((()=>{rhino3dm().then((t=>{this.rhino=t,this.ExportRhinoContent(e,i,n)}))})).catch((()=>{n()})):this.ExportRhinoContent(e,i,n)}ExportRhinoContent(e,t,i){function n(e){return{r:e.r,g:e.g,b:e.b,a:255}}let r=new Lt("model.3dm");t.push(r);let s=new this.rhino.File3dm;e.EnumerateTransformedMeshes((t=>{let i=Wt(t);for(let r=0;r<i.PrimitiveCount();r++){let o=i.GetPrimitive(r),l={data:{attributes:{position:{itemSize:3,type:"Float32Array",array:o.vertices},normal:{itemSize:3,type:"Float32Array",array:o.normals}},index:{type:"Uint16Array",array:o.indices}}},a=e.GetMaterial(o.material),h=new this.rhino.Material;h.name=this.GetExportedMaterialName(a.name),h.ambientColor=n(a.ambient),h.diffuseColor=n(a.color),h.specularColor=n(a.specular),h.transparency=1-a.opacity;let d=s.materials().count();s.materials().add(h);let u=new this.rhino.Mesh.createFromThreejsJSON(l),m=new this.rhino.ObjectAttributes;m.name=this.GetExportedMeshName(t.GetName()),m.materialSource=this.rhino.ObjectMaterialSource.MaterialFromObject,m.materialIndex=d,s.objects().add(u,m)}}));let o=new this.rhino.File3dmWriteOptions;o.version=6;let l=s.toByteArray(o);r.SetBufferContent(l),i()}}class qt{constructor(){this.exporters=[new Nt,new Ht,new Ut,new Bt,new jt,new Kt]}AddExporter(e){this.exporters.push(e)}Export(e,t,i,n){let r=null;for(let e=0;e<this.exporters.length;e++){let n=this.exporters[e];if(n.CanExport(t,i)){r=n;break}}null!==r?r.Export(e,t,(e=>{0===e.length?n.onError():n.onSuccess(e)})):n.onError()}}class Jt{constructor(e){this.callbacks=e,this.model=null,this.exportFormats=[{name:"obj",formats:[{name:"text",type:1,format:1,extension:"obj"}]},{name:"stl",formats:[{name:"text",type:1,format:1,extension:"stl"},{name:"binary",type:1,format:2,extension:"stl"}]},{name:"ply",formats:[{name:"text",type:1,format:1,extension:"ply"},{name:"binary",type:1,format:2,extension:"ply"}]},{name:"gltf",formats:[{name:"text",type:1,format:1,extension:"gltf"},{name:"binary",type:1,format:2,extension:"glb"}]},{name:"off",formats:[{name:"text",type:1,format:1,extension:"off"}]},{name:"3dm",formats:[{name:"binary",type:1,format:2,extension:"3dm"}]},{name:"png",formats:[{name:"current size",type:2,width:null,height:null,extension:"png"},{name:"fixed size (1920x1080)",type:2,width:1920,height:1080,extension:"png"}]}],this.formatParameters={exportFormatButtonDivs:[],formatSettingsDiv:null,selectedFormat:null}}Show(e,t){if(null===e){let e=_t("Export Failed","Please load a model before exporting.",null);return void this.callbacks.onDialog(e)}let i=new Dt,n=i.Init("Export",[{name:"Close",subClass:"outline",onClick(){i.Hide()}},{name:"Export",onClick:()=>{null!==this.formatParameters.selectedFormat&&(i.Hide(),this.ExportFormat(e,t))}}]);U.AddDiv(n,"ov_dialog_section","Select a format from the below list to export your model. Please note that the export can take several second.");let r=U.AddDiv(n,"ov_dialog_select");this.formatParameters.formatSettingsDiv=U.AddDiv(n,"ov_dialog_section ov_dialog_options");for(let e=0;e<this.exportFormats.length;e++){let t=this.exportFormats[e],i=U.AddDiv(r,"ov_button outline ov_dialog_select_option",t.name);this.formatParameters.exportFormatButtonDivs.push(i),i.addEventListener("click",(()=>{this.OnExportFormatSelect(e)}))}this.OnExportFormatSelect(0),i.Show(),this.callbacks.onDialog(i)}OnExportFormatSelect(e){U.ClearDomElement(this.formatParameters.formatSettingsDiv);for(let t=0;t<this.formatParameters.exportFormatButtonDivs.length;t++){let i=this.formatParameters.exportFormatButtonDivs[t];t===e?i.classList.remove("outline"):i.classList.add("outline")}let t=this.exportFormats[e];for(let e=0;e<t.formats.length;e++){let i=t.formats[e],n=U.AddDiv(this.formatParameters.formatSettingsDiv,"ov_dialog_row"),r=U.AddDomElement(n,"label");r.setAttribute("for",i.name);let s=U.AddDomElement(r,"input","ov_radio_button");s.setAttribute("type","radio"),s.setAttribute("id",i.name),s.setAttribute("name","format"),U.AddDomElement(r,"span",null,i.name),0===e&&(s.checked=!0,this.formatParameters.selectedFormat=i),s.addEventListener("change",(()=>{this.formatParameters.selectedFormat=i}))}}ExportFormat(e,t){let i=this.formatParameters.selectedFormat;if(null!==i)if(1===i.type){let t=new ProgressDialog;t.Init("Exporting Model"),t.Show(),ye((()=>{(new qt).Export(e,i.format,i.extension,{onError:()=>{t.Hide()},onSuccess:e=>{if(0===e.length)t.Hide();else if(1===e.length){t.Hide();let i=e[0];B.DownloadArrayBufferAsFile(i.GetBufferContent(),i.GetName())}else e.length>1&&(t.Hide(),this.ShowExportedFiles(e))}})}))}else if(2===i.type){let e=null;if(null===i.width||null===i.height){let i=t.GetImageSize();e=t.GetImageAsDataUrl(i.width,i.height)}else e=t.GetImageAsDataUrl(i.width,i.height);B.DownloadUrlAsFile(e,"model."+i.extension)}}ShowExportedFiles(e){let t=new Dt,i=t.Init("Exported Files",[{name:"Close",onClick(){t.Hide()}}]);U.AddDiv(i,"ov_dialog_section","You can download your exported files here.");let n=U.AddDiv(i,"ov_dialog_section"),r=U.AddDiv(n,"ov_dialog_file_list ov_thin_scrollbar");for(let t=0;t<e.length;t++){let i=e[t],n=De(i.GetBufferContent()),s=U.AddDomElement(r,"a","ov_dialog_file_link");s.setAttribute("href",n),s.setAttribute("download",i.GetName()),U.AddSvgIconElement(s,"file_download","ov_file_link_img"),U.AddDiv(s,"ov_dialog_file_link_text",i.GetName())}t.Show(),this.callbacks.onDialog(t)}}class Xt{}class $t{constructor(e){this.parameters=e,this.viewer=new F,this.hashHandler=new k,this.cookieHandler=new H,this.toolbar=new z(this.parameters.toolbarDiv),this.navigator=new Navigator(this.parameters.navigatorDiv,this.parameters.navigatorSplitterDiv),this.sidebar=new Ie(this.parameters.sidebarDiv,this.parameters.sidebarSplitterDiv),this.eventHandler=new Se(this.parameters.eventHandler),this.settings=new ve,this.modelLoader=new Tt,this.themeHandler=new Xt,this.highlightColor=new THREE.Color(9357808),this.uiState=0,this.model=null,this.dialog=null}Load(){this.settings.LoadFromCookies(this.cookieHandler),this.SwitchTheme(this.settings.themeId,!1),this.InitViewer(),this.InitToolbar(),this.InitDragAndDrop(),this.InitModelLoader(),this.InitSidebar(),this.InitNavigator(),this.InitCookieConsent(),this.viewer.SetClickHandler(this.OnModelClicked.bind(this)),this.viewer.SetContextMenuHandler(this.OnModelContextMenu.bind(this)),this.Resize(),this.SetUIState(1),this.hashHandler.SetEventListener(this.OnHashChange.bind(this)),this.OnHashChange(),B.AddSmallWidthChangeEventListener((()=>{this.OnSmallWidthChanged()})),window.addEventListener("resize",(()=>{this.Resize()}))}async FetchModelFiles(e){}Resize(){let e=window.innerWidth,t=window.innerHeight,i=this.parameters.headerDiv.offsetHeight,n=0,r=0;B.IsSmallWidth()||(n=this.navigator.GetWidth(),r=this.sidebar.GetWidth());let s=e-n-r;s<50&&(this.sidebar.DecreaseWidth(50-s),s=50);let o=t-i;U.SetDomElementOuterHeight(this.parameters.introDiv,o),this.navigator.Resize(o),this.sidebar.Resize(o),this.viewer.Resize(s,o)}OnSmallWidthChanged(){2===this.uiState&&this.UpdatePanelsVisibility()}HasLoadedModel(){return null!==this.model}SetUIState(e){function t(e){document.querySelector(":root").style.setProperty("--ov_only_on_model_display",e?"inherit":"none")}this.uiState!==e&&(this.uiState=e,1===this.uiState?(U.ShowDomElement(this.parameters.introDiv),U.HideDomElement(this.parameters.mainDiv),t(!1)):2===this.uiState?(U.HideDomElement(this.parameters.introDiv),U.ShowDomElement(this.parameters.mainDiv),t(!0),this.UpdatePanelsVisibility()):3===this.uiState&&(U.HideDomElement(this.parameters.introDiv),U.HideDomElement(this.parameters.mainDiv),t(!1)),this.Resize())}ClearModel(){this.HidePopups(),this.model=null,this.viewer.Clear(),this.navigator.Clear(),this.sidebar.Clear()}OnModelLoaded(e,t){this.model=e.model,this.viewer.SetMainObject(t),this.viewer.SetUpVector(e.upVector,!1),this.navigator.FillTree(e),this.sidebar.Update(this.model),this.FitModelToWindow(!0)}OnModelClicked(e,t){if(1===e){let e=this.viewer.GetMeshUserDataUnderMouse(t);null===e?this.navigator.SetSelection(null):this.navigator.SetSelection(new Selection(2,e.originalMeshId))}}OnModelContextMenu(e,t){let i=this.viewer.GetMeshUserDataUnderMouse(t),n=[];if(null===i)n.push({name:"Fit model to window",icon:"fit",onClick:()=>{this.FitModelToWindow(!1)}}),this.navigator.HasHiddenMesh()&&n.push({name:"Show all meshes",icon:"visible",onClick:()=>{this.navigator.ShowAllMeshes(!0)}});else if(n.push({name:"Hide mesh",icon:"hidden",onClick:()=>{this.navigator.ToggleMeshVisibility(i.originalMeshId)}}),n.push({name:"Fit mesh to window",icon:"fit",onClick:()=>{this.navigator.FitMeshToWindow(i.originalMeshId)}}),this.navigator.MeshItemCount()>1){let e=this.navigator.IsMeshIsolated(i.originalMeshId);n.push({name:e?"Remove isolation":"Isolate mesh",icon:e?"deisolate":"isolate",onClick:()=>{e?this.navigator.ShowAllMeshes(!0):this.navigator.IsolateMesh(i.originalMeshId)}})}this.dialog=function(e,t){if(0===e.length)return null;let i=new Ft;i.Init((()=>t.calculatePosition(i.GetContentDiv())));for(let n=0;n<e.length;n++){let r=e[n];i.AddListItem(r,{onHoverStart:function(){t.onHoverStart&&t.onHoverStart(n)},onHoverStop:function(){t.onHoverStop&&t.onHoverStop(n)},onClick:function(){i.Hide(),t.onClick(n)}})}return i.Show(),i}(n,{calculatePosition:t=>function(e,t){let i=window.innerWidth,n=window.innerHeight,r=e.x,s=e.y,o=r+t.offsetWidth,l=s+t.offsetHeight;return o>i&&(r-=o-i),l>n&&(s-=l-n),{x:r,y:s}}(e,t),onClick:e=>{n[e].onClick()}})}OnHashChange(){if(this.hashHandler.HasHash()){let e=this.hashHandler.GetModelFilesFromHash();if(null===e)return;let t=new Ct;t.defaultColor=this.settings.defaultColor;let i=this.hashHandler.GetDefaultColorFromHash();null!==i&&(t.defaultColor=i),this.eventHandler.HandleEvent("model_load_started",{source:"hash"}),this.LoadModelFromUrlList(e,t)}else this.ClearModel(),this.SetUIState(1)}HidePopups(){null!==this.dialog&&(this.dialog.Hide(),this.dialog=null)}OpenFileBrowserDialog(){this.parameters.fileInput.click()}FitModelToWindow(e){let t=!e,i=this.viewer.GetBoundingSphere((e=>this.navigator.IsMeshVisible(e.originalMeshId)));e&&this.viewer.AdjustClippingPlanesToSphere(i),this.viewer.FitSphereToWindow(i,t)}FitMeshToWindow(e){let t=this.viewer.GetBoundingSphere((t=>t.originalMeshId.IsEqual(e)));this.viewer.FitSphereToWindow(t,!0)}FitMeshesToWindow(e){let t=new Set;for(let i of e)t.add(i.GetKey());let i=this.viewer.GetBoundingSphere((e=>t.has(e.originalMeshId.GetKey())));this.viewer.FitSphereToWindow(i,!0)}UpdateMeshesVisibility(){this.viewer.SetMeshesVisibility((e=>this.navigator.IsMeshVisible(e.originalMeshId)))}UpdateMeshesSelection(){let e=this.navigator.GetSelectedMeshId();this.viewer.SetMeshesHighlight(this.highlightColor,(t=>!(null===e||!t.originalMeshId.IsEqual(e))))}LoadModelFromUrlList(e,t){this.modelLoader.LoadFromUrlList(e,t),this.ClearHashIfNotOnlyUrlList()}LoadModelFromFileList(e){let t=new Ct;t.defaultColor=this.settings.defaultColor,this.modelLoader.LoadFromFileList(e,t),this.ClearHashIfNotOnlyUrlList()}ClearHashIfNotOnlyUrlList(){!this.modelLoader.GetImporter().GetFileList().IsOnlyUrlSource()&&this.hashHandler.HasHash()&&(this.hashHandler.SkipNextEventHandler(),this.hashHandler.ClearHash())}SwitchTheme(e,t){if(this.settings.themeId=e,this.themeHandler.SwitchTheme(this.settings.themeId),this.settings.SaveToCookies(this.cookieHandler),t){if(1===this.settings.themeId)this.settings.backgroundColor=new g(255,255,255),this.settings.defaultColor=new g(200,200,200);else{if(2!==this.settings.themeId)return;this.settings.backgroundColor=new g(42,43,46),this.settings.defaultColor=new g(200,200,200)}this.settings.SaveToCookies(this.cookieHandler),this.viewer.SetBackgroundColor(this.settings.backgroundColor),null!==this.modelLoader.defaultMaterial&&(me(this.model,this.settings.defaultColor),this.modelLoader.ReplaceDefaultMaterialColor(this.settings.defaultColor))}}InitViewer(){let e=U.AddDomElement(this.parameters.viewerDiv,"canvas");this.viewer.Init(e),this.viewer.SetBackgroundColor(this.settings.backgroundColor),this.viewer.SetEnvironmentMap(["assets/envmaps/grayclouds/posx.jpg","assets/envmaps/grayclouds/negx.jpg","assets/envmaps/grayclouds/posy.jpg","assets/envmaps/grayclouds/negy.jpg","assets/envmaps/grayclouds/posz.jpg","assets/envmaps/grayclouds/negz.jpg"])}InitToolbar(){function e(e,t,i,n,r,s){let o=e.AddImageButton(i,n,(()=>{t.HandleEvent("toolbar_clicked",{item:i}),s()}));if(null!==r)for(let e of r)o.AddClass(e);return o}function t(e,t){let i=e.AddSeparator();if(null!==t)for(let e of t)i.classList.add(e)}let i=this.modelLoader.GetImporter();e(this.toolbar,this.eventHandler,"open","Open model from your device",null,(()=>{this.OpenFileBrowserDialog()})),e(this.toolbar,this.eventHandler,"open_url","Open model from a url",null,(()=>{this.dialog=function(e){let t=new Dt,i=DomUtils.CreateDomElement("textarea","ov_dialog_textarea"),n=t.Init("Open Model from Url",[{name:"Cancel",subClass:"outline",onClick(){t.Hide()}},{name:"OK",onClick(){let n=[];He(i.value,(e=>{n.push(e)})),t.Hide(),function(e){for(let t=0;t<e.length;t++){let i=e[t];if(-1!==i.search(/www\.dropbox\.com/u)){i=i.replace("www.dropbox.com","dl.dropbox.com");let n=i.indexOf("?");-1!==n&&(i=i.substr(0,n)),e[t]=i}else if(-1!==i.search(/github\.com/u)){i=i.replace("github.com","raw.githubusercontent.com"),i=i.replace("/blob","");let n=i.indexOf("?");-1!==n&&(i=i.substr(0,n)),e[t]=i}}}(n),e(n)}}]);return DomUtils.AddDiv(n,"ov_dialog_section","Here you can load models based on their urls. You can add more lines if your model builds up from multiple files."),n.appendChild(i),t.Show(),i.focus(),t}((e=>{e.length>0&&this.hashHandler.SetModelFilesToHash(e)}))})),t(this.toolbar,["only_on_model"]),e(this.toolbar,this.eventHandler,"fit","Fit model to window",["only_on_model"],(()=>{this.FitModelToWindow(!1)})),e(this.toolbar,this.eventHandler,"up_y","Set Y axis as up vector",["only_on_model"],(()=>{this.viewer.SetUpVector(2,!0)})),e(this.toolbar,this.eventHandler,"up_z","Set Z axis as up vector",["only_on_model"],(()=>{this.viewer.SetUpVector(3,!0)})),e(this.toolbar,this.eventHandler,"flip","Flip up vector",["only_on_model"],(()=>{this.viewer.FlipUpVector()})),t(this.toolbar,["only_on_model"]),function(e,t,i,n,r,s,o){let l=[];for(let e=0;e<i.length;e++){let t=i[e],r=n[e];l.push({image:t,title:r})}let a=e.AddImageRadioButton(l,0,(e=>{t.HandleEvent("toolbar_clicked",{item:i[e]}),o(e)}));if(null!==s)for(let e of s)for(let t of a)t.AddClass(e)}(this.toolbar,this.eventHandler,["fix_up_on","fix_up_off"],["Fixed up vector","Free orbit"],0,["only_on_model"],(e=>{0===e?this.viewer.SetFixUpVector(!0):1===e&&this.viewer.SetFixUpVector(!1)})),t(this.toolbar,["only_full_width","only_on_model"]),e(this.toolbar,this.eventHandler,"export","Export model",["only_full_width","only_on_model"],(()=>{new Jt({onDialog:e=>{this.dialog=e}}).Show(this.model,this.viewer)})),e(this.toolbar,this.eventHandler,"share","Share model",["only_full_width","only_on_model"],(()=>{this.dialog=function(e,t,i){function n(e,t,i,n){let r=U.AddDiv(e,"ov_dialog_row"),s=U.AddDomElement(r,"label");s.setAttribute("for",i);let o=U.AddDomElement(s,"input","ov_checkbox");o.setAttribute("type","checkbox"),o.setAttribute("checked","true"),o.setAttribute("id",i),U.AddDomElement(s,"span",null,t),o.addEventListener("change",(()=>{n(o.checked)}))}function r(e){let t=P();return t.AddModelUrls(e.files),"https://3dviewer.net#"+t.GetParameterList()}function s(e){let t=P();t.AddModelUrls(e.files),t.AddCamera(e.camera),t.AddBackground(e.backgroundColor),t.AddColor(e.defaultColor);let i="";return i+="<iframe",i+=' width="640" height="480"',i+=' style="border:1px solid #eeeeee;"',i+=' src="https://3dviewer.net/embed.html#'+t.GetParameterList()+'">',i+="</iframe>",i}function o(e,t){let i="Copy",n=U.AddDiv(e,"ov_dialog_copyable_input"),r=U.AddDomElement(n,"input","ov_dialog_text");r.readOnly=!0;let s=U.AddDiv(n,"ov_button outline ov_dialog_copyable_input_button",i);return s.addEventListener("click",(()=>{B.CopyToClipboard(t()),s.innerHTML="Copied",setTimeout((()=>{s.innerHTML=i}),2e3)})),r}if(!e.GetFileList().IsOnlyUrlSource())return _t("Sharing Failed","Sharing works only if you load files by url. Please upload your model files to a web server, open them by url, and try embedding again.",null);let l=e.GetFileList().GetFiles(),a=[];for(let e=0;e<l.length;e++){let t=l[e];1===t.source&&a.push(t.fileUrl)}let h={files:a},d={files:a,camera:i,backgroundColor:t.backgroundColor,defaultColor:t.defaultColor},u=new Dt,m=u.Init("Share",[{name:"Close",onClick(){u.Hide()}}]);return function(e,t){let i=U.AddDiv(e,"ov_dialog_section");U.AddDiv(i,"ov_dialog_inner_title","Sharing Link"),o(i,(()=>r(t))).value=r(t)}(m,h),function(e,t,r){let l=U.AddDiv(e,"ov_dialog_section");l.style.marginTop="20px",U.AddDiv(l,"ov_dialog_inner_title","Embedding Code");let a=U.AddDiv(l,"ov_dialog_section"),h=o(l,(()=>s(r)));n(a,"Use current camera position","embed_camera",(e=>{r.camera=e?i:null,h.value=s(r)})),n(a,"Use overridden background color","embed_background",(e=>{r.backgroundColor=e?t.backgroundColor:null,h.value=s(r)})),n(a,"Use overridden default color","embed_color",(e=>{r.defaultColor=e?t.defaultColor:null,h.value=s(r)})),h.value=s(r)}(m,t,d),u.Show(),u}(i,this.settings,this.viewer.GetCamera())})),this.parameters.fileInput.addEventListener("change",(e=>{e.target.files.length>0&&(this.eventHandler.HandleEvent("model_load_started",{source:"open_file"}),this.LoadModelFromFileList(e.target.files))}))}InitDragAndDrop(){window.addEventListener("dragstart",(e=>{e.preventDefault()}),!1),window.addEventListener("dragover",(e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}),!1),window.addEventListener("drop",(e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.files.length>0&&(this.eventHandler.HandleEvent("model_load_started",{source:"drop"}),this.LoadModelFromFileList(e.dataTransfer.files))}),!1)}InitModelLoader(){!function(e,t){let i=null,n=null;e.Init({onLoadStart:()=>{var e;null!==(e=i)&&(e.Hide(),e=null),t.onStart(),n=new Gt,n.Init("Loading Model"),n.Show()},onImportStart:()=>{n.SetText("Importing Model")},onVisualizationStart:()=>{n.SetText("Visualizing Model")},onModelFinished:(e,i)=>{n.Hide(),t.onFinish(e,i)},onTextureLoaded:()=>{t.onRender()},onLoadError:e=>{n.Hide(),t.onError(e),i=function(e){return 1===e.code?_t("Something went wrong","No importable file found.",e.message):2===e.code?_t("Something went wrong","Failed to import model.",e.message):_t("Something went wrong","Unknown error.",e.message)}(e)}})}(this.modelLoader,{onStart:()=>{this.SetUIState(3),this.ClearModel()},onFinish:(e,t)=>{this.SetUIState(2),this.OnModelLoaded(e,t);let i=xe(e.mainFile);this.eventHandler.HandleEvent("model_loaded",{extension:i})},onRender:()=>{this.viewer.Render()},onError:e=>{this.SetUIState(1);let t="unknown";1===e.code?t="no_importable_file":2===e.code&&(t="import_failed");let i=[],n=this.modelLoader.GetImporter().GetFileList().GetFiles();for(let e=0;e<n.length;e++)i.push(n[e].extension);this.eventHandler.HandleEvent("model_load_failed",{reason:t,extensions:i})}})}InitSidebar(){this.sidebar.Init(this.settings,{onBackgroundColorChange:e=>{this.settings.backgroundColor=e,this.settings.SaveToCookies(this.cookieHandler),this.viewer.SetBackgroundColor(e)},onDefaultColorChange:e=>{this.settings.defaultColor=e,this.settings.SaveToCookies(this.cookieHandler),null!==this.modelLoader.defaultMaterial&&(me(this.model,e),this.modelLoader.ReplaceDefaultMaterialColor(e)),this.viewer.Render()},onThemeChange:e=>{this.SwitchTheme(e,!0)},onResize:()=>{this.Resize()},onShowHidePanels:e=>{this.cookieHandler.SetBoolVal("ov_show_sidebar",e)}})}InitNavigator(){function e(e,t){const i=e.GetMaterial(t);return{index:t,name:i.name,color:i.color.Clone()}}this.navigator.Init({openFileBrowserDialog:()=>{this.OpenFileBrowserDialog()},updateMeshesVisibility:()=>{this.UpdateMeshesVisibility()},updateMeshesSelection:()=>{this.UpdateMeshesSelection()},fitMeshToWindow:e=>{this.FitMeshToWindow(e)},fitMeshesToWindow:e=>{this.FitMeshesToWindow(e)},getMeshesForMaterial:e=>function(e,t,i){let n=[];return e.EnumerateMeshesUserData((e=>{if(null===i||-1!==e.originalMaterials.indexOf(i)){const i=t.GetMesh(e.originalMeshId.meshIndex);n.push({meshId:e.originalMeshId,name:i.GetName()})}})),n}(this.viewer,this.model,e),getMaterialsForMesh:t=>function(t,i,n){let r=[];if(null===n)for(let t=0;t<i.MaterialCount();t++)r.push(e(i,t));else{let s=function(e,t){let i=null;return e.EnumerateMeshesUserData((e=>{e.originalMeshId.IsEqual(t)&&(i=e)})),i}(t,n);for(let t=0;t<s.originalMaterials.length;t++){const n=s.originalMaterials[t];r.push(e(i,n))}}return r.sort(((e,t)=>e.index-t.index)),r}(this.viewer,this.model,t),onModelSelected:()=>{this.sidebar.AddObject3DProperties(this.model)},onMeshSelected:e=>{let t=this.model.GetMeshInstance(e);this.sidebar.AddObject3DProperties(t),alert(t.mesh.name)},onMaterialSelected:e=>{this.sidebar.AddMaterialProperties(this.model.GetMaterial(e))},onResize:()=>{this.Resize()},onShowHidePanels:e=>{this.cookieHandler.SetBoolVal("ov_show_navigator",e)}})}UpdatePanelsVisibility(){let e=this.cookieHandler.GetBoolVal("ov_show_navigator",!0),t=this.cookieHandler.GetBoolVal("ov_show_sidebar",!0);this.navigator.ShowPanels(e),this.sidebar.ShowPanels(t)}InitCookieConsent(){this.cookieHandler.GetBoolVal("ov_cookie_consent",!1)||function(e){let t=new Dt,i=t.Init("Cookie Consent",[{name:"Accept",onClick(){t.Hide(),e()}}]);U.AddDiv(i,"ov_dialog_section",'This website uses cookies to offer you better user experience. See the details at the <a target="_blank" href="info/cookies.html">Cookies Policy</a> page.'),t.SetCloseable(!1),t.Show()}((()=>{this.cookieHandler.SetBoolVal("ov_cookie_consent",!0)}))}}window.addEventListener("load",(()=>{new $t({headerDiv:document.getElementById("header"),toolbarDiv:document.getElementById("toolbar"),mainDiv:document.getElementById("main"),introDiv:document.getElementById("intro"),navigatorDiv:document.getElementById("main_navigator"),navigatorSplitterDiv:document.getElementById("main_navigator_splitter"),sidebarDiv:document.getElementById("main_sidebar"),sidebarSplitterDiv:document.getElementById("main_sidebar_splitter"),viewerDiv:document.getElementById("main_viewer"),fileInput:document.getElementById("open_file"),eventHandler:window.gtagEventHandler}).Load()}))})();